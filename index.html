<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æé€Ÿæ”¶é“¶ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .page { display: none; padding-bottom: 80px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ‰«ç æ¡†æ ·å¼ */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        #reader video { object-fit: cover; border-radius: 8px; }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */
        .nav-item.active { color: #2563eb; }
        .nav-item.active svg { fill: currentColor; fill-opacity: 0.2; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <script>
        const SUPABASE_URL = "https://ovhjhqfjygwzvfpaiejb.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>

    <div id="status-bar" class="bg-white border-b px-4 py-2 flex justify-between items-center text-xs text-gray-500 sticky top-0 z-20">
        <span id="connection-status" class="text-green-600 font-bold">â— å·²è¿æ¥</span>
        <span id="queue-status" class="hidden text-orange-500">æœªåŒæ­¥è®¢å•: 0</span>
    </div>

    <div id="page-entry" class="page active px-4 py-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">å•†å“å½•å…¥</h2>
        
        <div class="bg-white p-3 rounded-xl shadow-sm mb-4">
            <div id="entry-scanner-container" class="relative bg-black rounded-lg h-48 flex items-center justify-center overflow-hidden">
                <div id="entry-reader" class="w-full h-full"></div>
                <div id="entry-overlay" class="absolute inset-0 flex flex-col items-center justify-center text-white pointer-events-none z-10">
                    <svg class="w-10 h-10 mb-2 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                    <span class="text-sm bg-black/50 px-2 rounded">ç‚¹å‡»å¼€å§‹æ‰«ç </span>
                </div>
                <button onclick="toggleScanner('entry')" class="absolute inset-0 z-20 w-full h-full opacity-0"></button>
            </div>
            <p class="text-center text-xs text-gray-400 mt-2">ç‚¹å‡»ä¸Šæ–¹åŒºåŸŸå¼€å¯æ‘„åƒå¤´ï¼Œæˆ–ä½¿ç”¨æ‰«ç æª</p>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
            <div>
                <label class="text-xs text-gray-500 block mb-1">æ¡å½¢ç  (å¿…å¡«)</label>
                <input type="text" id="entry-barcode" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-lg font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ‰«ç æˆ–æ‰‹åŠ¨è¾“å…¥">
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">å•†å“åç§°</label>
                <input type="text" id="entry-name" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="é»˜è®¤ï¼šæœªå‘½å">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">æ‰¹å‘ä»·</label>
                    <input type="number" id="entry-wholesale" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-right focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">é›¶å”®ä»·</label>
                    <input type="number" id="entry-retail" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-right focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                </div>
            </div>
            <button onclick="saveProduct()" class="w-full bg-blue-600 active:bg-blue-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg mt-2 transition-transform active:scale-95">ä¿å­˜å¹¶ç»§ç»­ (Enter)</button>
        </div>
    </div>

    <div id="page-manage" class="page px-4 py-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">å•†å“ç®¡ç†</h2>
            <div class="flex gap-2">
                <button onclick="exportExcel()" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold">å¯¼å‡º</button>
            </div>
        </div>
        
        <input type="text" id="manage-search" oninput="renderProductList()" class="w-full bg-white border border-gray-200 rounded-lg p-3 mb-4 shadow-sm" placeholder="æœç´¢å•†å“åæˆ–æ¡ç ...">

        <div id="product-list" class="space-y-3 pb-20">
            </div>
    </div>

    <div id="page-cashier" class="page px-4 pt-2 pb-32 flex flex-col h-full">
        <div class="flex bg-gray-200 p-1 rounded-lg mb-3">
            <button onclick="setPriceMode('retail')" id="btn-mode-retail" class="flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm transition-all">é›¶å”®ä»·</button>
            <button onclick="setPriceMode('wholesale')" id="btn-mode-wholesale" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 transition-all">æ‰¹å‘ä»·</button>
        </div>

        <div class="bg-white p-2 rounded-lg shadow-sm mb-3 flex gap-2 h-24">
            <div id="cashier-scanner-container" class="relative bg-black rounded w-32 h-full flex items-center justify-center overflow-hidden flex-shrink-0">
                <div id="cashier-reader" class="w-full h-full"></div>
                <div id="cashier-overlay" class="absolute inset-0 flex flex-col items-center justify-center text-white pointer-events-none z-10">
                    <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                    <span class="text-xs scale-90">ç‚¹æ­¤æ‰«ç </span>
                </div>
                <button onclick="toggleScanner('cashier')" class="absolute inset-0 z-20 w-full h-full opacity-0"></button>
            </div>
            <div class="flex-1 flex flex-col justify-center">
                 <input type="text" id="cashier-input" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm mb-1" placeholder="æ‰‹åŠ¨è¾“ç /æ‰«ç æª">
                 <div class="text-xs text-gray-400">æ”¯æŒè¿ç»­æ‰«ç  / è‡ªåŠ¨å åŠ </div>
            </div>
        </div>

        <div id="cart-list" class="flex-1 overflow-y-auto space-y-2 no-scrollbar">
            <div class="text-center text-gray-400 py-10">è´­ç‰©è½¦ä¸ºç©º</div>
        </div>

        <div class="fixed bottom-[60px] left-0 right-0 bg-white border-t p-4 shadow-lg z-30">
            <div class="flex justify-between items-end mb-2">
                <div class="text-gray-500 text-sm">æ•°é‡: <span id="cart-count" class="font-bold text-gray-800">0</span></div>
                <div class="text-2xl font-bold text-red-600">ï¿¥<span id="cart-total">0.00</span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearCart()" class="px-4 py-3 rounded-lg border border-red-200 text-red-500 font-bold text-sm">æ¸…ç©º</button>
                <button onclick="showCheckoutModal()" class="flex-1 bg-blue-600 text-white font-bold rounded-lg py-3 text-lg shadow-md active:bg-blue-700">å»ç»“ç®—</button>
            </div>
        </div>
    </div>

    <div id="page-orders" class="page px-4 py-4">
        <h2 class="text-xl font-bold mb-4 text-gray-800">ä»Šæ—¥è®¢å•</h2>
        <div class="bg-blue-50 p-4 rounded-xl mb-4 grid grid-cols-2 gap-4">
            <div>
                <div class="text-xs text-blue-500 mb-1">ä»Šæ—¥é”€å”®é¢</div>
                <div class="text-xl font-bold text-blue-800">ï¿¥<span id="stats-sales">0.00</span></div>
            </div>
            <div>
                <div class="text-xs text-blue-500 mb-1">ä»Šæ—¥è®¢å•æ•°</div>
                <div class="text-xl font-bold text-blue-800" id="stats-count">0</div>
            </div>
        </div>
        <div id="order-list" class="space-y-3 pb-20">
            </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-2 pb-safe z-40 shadow-lg">
        <button onclick="switchPage('entry')" class="nav-item flex flex-col items-center w-1/4 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-[10px]">å½•å…¥</span>
        </button>
        <button onclick="switchPage('manage')" class="nav-item flex flex-col items-center w-1/4 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
            <span class="text-[10px]">ç®¡ç†</span>
        </button>
        <button onclick="switchPage('cashier')" class="nav-item active flex flex-col items-center w-1/4 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
            <span class="text-[10px]">æ”¶é“¶</span>
        </button>
        <button onclick="switchPage('orders')" class="nav-item flex flex-col items-center w-1/4 text-gray-400">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span class="text-[10px]">è®¢å•</span>
        </button>
    </div>

    <div id="modal-edit" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-5">
            <h3 class="font-bold text-lg mb-4">ç¼–è¾‘å•†å“</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-3">
                <input type="text" id="edit-name" class="w-full border rounded p-2" placeholder="å•†å“å">
                <input type="number" id="edit-wholesale" class="w-full border rounded p-2" placeholder="æ‰¹å‘ä»·">
                <input type="number" id="edit-retail" class="w-full border rounded p-2" placeholder="é›¶å”®ä»·">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="edit-status" class="w-5 h-5">
                    <label>åœç”¨æ­¤å•†å“</label>
                </div>
            </div>
            <div class="flex gap-3 mt-5">
                <button onclick="closeModal('modal-edit')" class="flex-1 py-2 border rounded-lg">å–æ¶ˆ</button>
                <button onclick="saveEdit()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="modal-checkout" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:max-w-sm rounded-t-xl sm:rounded-xl p-5 animate-slide-up">
            <h3 class="font-bold text-lg mb-2">ç¡®è®¤æ”¶æ¬¾</h3>
            <div class="text-3xl font-bold text-center text-red-600 my-4">ï¿¥<span id="checkout-total">0.00</span></div>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="completeOrder('ç°é‡‘')" class="py-3 bg-green-50 text-green-700 border border-green-200 rounded-lg font-bold">ğŸ’µ ç°é‡‘</button>
                <button onclick="completeOrder('å¾®ä¿¡')" class="py-3 bg-green-500 text-white rounded-lg font-bold">ğŸ’¬ å¾®ä¿¡æ”¯ä»˜</button>
                <button onclick="completeOrder('æ”¯ä»˜å®')" class="py-3 bg-blue-500 text-white rounded-lg font-bold">ğŸ”· æ”¯ä»˜å®</button>
                <button onclick="completeOrder('å…¶ä»–')" class="py-3 bg-gray-100 text-gray-600 rounded-lg font-bold">ğŸ’³ å…¶ä»–</button>
            </div>
            <button onclick="closeModal('modal-checkout')" class="w-full py-3 text-gray-400">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- 1. å…¨å±€çŠ¶æ€ ---
        const state = {
            products: [], // æœ¬åœ°ç¼“å­˜å•†å“
            cart: [],
            priceMode: 'retail', // retail | wholesale
            scanner: null, // Html5Qrcode å®ä¾‹
            activeCamera: null,
            scanLock: false,
            currentScanType: null // 'entry' | 'cashier'
        };

        // --- 2. åˆå§‹åŒ–ä¸æ•°æ® ---
        async function init() {
            // åŠ è½½æœ¬åœ°æ•°æ®
            const savedProducts = localStorage.getItem('pos_products');
            if (savedProducts) state.products = JSON.parse(savedProducts);
            
            // å¼‚æ­¥ä» Supabase æ‹‰å–æœ€æ–°
            fetchProducts();
            
            // ç»‘å®šäº‹ä»¶
            setupScannerGunListener();
            switchPage('cashier'); // é»˜è®¤è¿›æ”¶é“¶
        }

        async function fetchProducts() {
            try {
                const { data, error } = await supabase.from('products').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                state.products = data;
                localStorage.setItem('pos_products', JSON.stringify(data));
                document.getElementById('connection-status').innerText = "â— å·²è¿æ¥";
                if(document.getElementById('page-manage').style.display === 'block') renderProductList();
            } catch (err) {
                console.error(err);
                document.getElementById('connection-status').innerText = "â—‹ ç¦»çº¿æ¨¡å¼";
                document.getElementById('connection-status').className = "text-gray-500 font-bold";
            }
        }

        // --- 3. æ‰«ç é€»è¾‘ (HTML5-QRCode) ---
        function toggleScanner(type) {
            const containerId = type === 'entry' ? 'entry-reader' : 'cashier-reader';
            const overlayId = type === 'entry' ? 'entry-overlay' : 'cashier-overlay';
            
            // å¦‚æœæ­£åœ¨æ‰«ï¼Œä¸”ç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ª -> å…³æ‰
            if (state.activeCamera && state.currentScanType === type) {
                stopScanner();
                return;
            }
            
            // å¦‚æœæ­£åœ¨æ‰«å…¶ä»– -> å…ˆå…³æ‰
            if (state.activeCamera) {
                stopScanner().then(() => startScanner(type, containerId, overlayId));
            } else {
                startScanner(type, containerId, overlayId);
            }
        }

        async function startScanner(type, containerId, overlayId) {
            state.currentScanType = type;
            state.activeCamera = true;
            document.getElementById(overlayId).style.display = 'none'; // éšè—é®ç½©æç¤º

            // é…ç½®
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 }, 
                aspectRatio: 1.0 
            };
            
            state.scanner = new Html5Qrcode(containerId);
            
            try {
                await state.scanner.start(
                    { facingMode: { ideal: "environment" } }, 
                    config, 
                    (decodedText) => handleScanSuccess(decodedText, type),
                    (errorMessage) => { /* å¿½ç•¥é”™è¯¯ */ }
                );
            } catch (err) {
                console.error("Camera error", err);
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™");
                stopScanner();
            }
        }

        async function stopScanner() {
            if (state.scanner) {
                try {
                    await state.scanner.stop();
                    state.scanner.clear();
                } catch(e) {}
                state.scanner = null;
            }
            state.activeCamera = false;
            state.currentScanType = null;
            // æ¢å¤é®ç½©
            document.getElementById('entry-overlay').style.display = 'flex';
            document.getElementById('cashier-overlay').style.display = 'flex';
        }

        function handleScanSuccess(barcode, type) {
            if (state.scanLock) return;
            state.scanLock = true;
            
            // æ’­æ”¾æ»´å£°
            // const audio = new Audio('beep.mp3'); audio.play().catch(e=>{}); // å¯é€‰

            if (type === 'entry') {
                document.getElementById('entry-barcode').value = barcode;
                document.getElementById('entry-name').focus();
                // æˆåŠŸåæš‚åœ 1ç§’ é˜²æ­¢è¿æ‰«
                setTimeout(() => state.scanLock = false, 1000);
                stopScanner(); // å½•å…¥æ¨¡å¼æ‰«å®Œè‡ªåŠ¨å…³ï¼Œæ–¹ä¾¿è¾“å…¥
            } else if (type === 'cashier') {
                addToCart(barcode);
                // æ”¶é“¶æ¨¡å¼ 500ms åå…è®¸ä¸‹ä¸€ä¸ªï¼Œä¿æŒæ‘„åƒå¤´å¼€å¯
                setTimeout(() => state.scanLock = false, 500);
            }
        }

        // --- 4. æ‰«ç æªå…¼å®¹ (é”®ç›˜æµç›‘å¬) ---
        let gunBuffer = "";
        let gunLastTime = 0;
        
        function setupScannerGunListener() {
            document.addEventListener('keydown', (e) => {
                const now = Date.now();
                // å¦‚æœåœ¨è¾“å…¥æ¡†å†…ï¼Œä¸æ‹¦æˆªï¼Œé™¤éæ˜¯å›è½¦
                if (e.target.tagName === 'INPUT' && e.key !== 'Enter') return;

                if (now - gunLastTime > 100) gunBuffer = ""; // è¶…æ—¶é‡ç½®
                gunLastTime = now;

                if (e.key === 'Enter') {
                    if (gunBuffer.length > 3) {
                        e.preventDefault();
                        handleGunInput(gunBuffer);
                    }
                    gunBuffer = "";
                } else if (e.key.length === 1) {
                    gunBuffer += e.key;
                }
            });
            
            // é’ˆå¯¹æ”¶é“¶è¾“å…¥æ¡†çš„ç‰¹æ®Šå›è½¦å¤„ç†
            const cashierInput = document.getElementById('cashier-input');
            cashierInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && cashierInput.value) {
                    addToCart(cashierInput.value);
                    cashierInput.value = '';
                }
            });
            
            // å½•å…¥é¡µé¢æ¡ç å›è½¦
             document.getElementById('entry-barcode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('entry-name').focus();
            });
        }

        function handleGunInput(code) {
            // æ ¹æ®å½“å‰é¡µé¢å†³å®šé€»è¾‘
            const currentPage = document.querySelector('.page.active').id;
            if (currentPage === 'page-entry') {
                document.getElementById('entry-barcode').value = code;
                document.getElementById('entry-name').focus();
            } else if (currentPage === 'page-cashier') {
                addToCart(code);
            }
        }

        // --- 5. ä¸šåŠ¡é€»è¾‘ï¼šå•†å“å½•å…¥ ---
        async function saveProduct() {
            const barcode = document.getElementById('entry-barcode').value.trim();
            let name = document.getElementById('entry-name').value.trim();
            const wPrice = parseFloat(document.getElementById('entry-wholesale').value) || 0;
            const rPrice = parseFloat(document.getElementById('entry-retail').value) || 0;

            if (!barcode) return alert("å¿…é¡»æœ‰æ¡å½¢ç ");

            // è‡ªåŠ¨å‘½åå¤„ç†
            if (!name) {
                const unnamedCount = state.products.filter(p => p.name.startsWith("æœªå‘½å")).length;
                name = `æœªå‘½å${unnamedCount + 1}`;
            }

            const newProduct = { barcode, name, wholesale_price: wPrice, retail_price: rPrice, status: 'active' };

            // ä¹è§‚æ›´æ–°
            const existingIdx = state.products.findIndex(p => p.barcode === barcode);
            if (existingIdx >= 0) {
                if(!confirm("æ¡ç å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–æ›´æ–°ï¼Ÿ")) return;
                state.products[existingIdx] = { ...state.products[existingIdx], ...newProduct };
            } else {
                state.products.unshift(newProduct);
            }
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('entry-barcode').value = '';
            document.getElementById('entry-name').value = '';
            document.getElementById('entry-wholesale').value = '';
            document.getElementById('entry-retail').value = '';
            
            // é‡æ–°å¼€å¯æ‰«ç 
            toggleScanner('entry');

            // å¼‚æ­¥å­˜åº“
            const { error } = await supabase.from('products').upsert(newProduct, { onConflict: 'barcode' });
            if (error) alert("ä¿å­˜å¤±è´¥: " + error.message);
            
            fetchProducts(); // åˆ·æ–°ç¼“å­˜
        }

        // --- 6. ä¸šåŠ¡é€»è¾‘ï¼šæ”¶é“¶ ---
        function setPriceMode(mode) {
            state.priceMode = mode;
            document.getElementById('btn-mode-retail').className = mode === 'retail' ? 'flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm' : 'flex-1 py-2 rounded-md text-sm font-bold text-gray-500';
            document.getElementById('btn-mode-wholesale').className = mode === 'wholesale' ? 'flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm' : 'flex-1 py-2 rounded-md text-sm font-bold text-gray-500';
            renderCart(); // é‡æ–°è®¡ç®—ä»·æ ¼
        }

        function addToCart(query) {
            const product = state.products.find(p => p.barcode === query || p.name === query);
            
            if (!product) {
                // å¦‚æœæ˜¯æ‰‹åŠ¨è¾“å…¥çš„ï¼Œæç¤ºæ‰¾ä¸åˆ°ï¼›æ‰«ç çš„åˆ™å‘å‡ºéœ‡åŠ¨
                if(document.activeElement.tagName === 'INPUT') alert("æœªæ‰¾åˆ°å•†å“");
                return;
            }
            if (product.status === 'inactive') return alert("å•†å“å·²åœç”¨");

            const existingItem = state.cart.find(i => i.barcode === product.barcode);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                state.cart.push({
                    ...product,
                    quantity: 1,
                    temp_price: null // æ”¯æŒä¸´æ—¶æ”¹ä»·
                });
            }
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;
            let count = 0;

            state.cart.forEach((item, index) => {
                // å†³å®šå•ä»·ï¼šæœ‰æ”¹ä»·ç”¨æ”¹ä»·ï¼Œå¦åˆ™æ ¹æ®æ¨¡å¼
                const unitPrice = item.temp_price !== null ? item.temp_price : (state.priceMode === 'wholesale' ? item.wholesale_price : item.retail_price);
                const subtotal = unitPrice * item.quantity;
                total += subtotal;
                count += item.quantity;

                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-lg shadow-sm flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-400 font-mono">${item.barcode}</div>
                        <div class="text-red-600 font-bold mt-1 cursor-pointer" onclick="editPrice(${index})">ï¿¥${unitPrice} <span class="text-xs text-gray-300 font-normal ml-1">ç‚¹å‡»æ”¹ä»·</span></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateQty(${index}, -1)" class="w-8 h-8 bg-gray-100 rounded-full font-bold text-gray-600">-</button>
                        <span class="w-6 text-center font-bold">${item.quantity}</span>
                        <button onclick="updateQty(${index}, 1)" class="w-8 h-8 bg-gray-100 rounded-full font-bold text-gray-600">+</button>
                    </div>
                `;
                list.appendChild(div);
            });

            if (state.cart.length === 0) list.innerHTML = `<div class="text-center text-gray-400 py-10">è´­ç‰©è½¦ä¸ºç©º</div>`;

            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = total.toFixed(2);
            document.getElementById('checkout-total').innerText = total.toFixed(2);
        }

        function updateQty(index, delta) {
            const item = state.cart[index];
            item.quantity += delta;
            if (item.quantity <= 0) {
                if(confirm("ç¡®å®šç§»é™¤æ­¤å•†å“ï¼Ÿ")) state.cart.splice(index, 1);
                else item.quantity = 1;
            }
            renderCart();
        }

        function editPrice(index) {
            const newPrice = prompt("è¾“å…¥ä¸´æ—¶å•ä»·ï¼š", "");
            if (newPrice !== null && !isNaN(parseFloat(newPrice))) {
                state.cart[index].temp_price = parseFloat(newPrice);
                renderCart();
            }
        }

        function clearCart() {
            if (state.cart.length > 0 && confirm("ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ")) {
                state.cart = [];
                renderCart();
            }
        }

        function showCheckoutModal() {
            if (state.cart.length === 0) return;
            document.getElementById('modal-checkout').classList.remove('hidden');
        }

        async function completeOrder(method) {
            const total = parseFloat(document.getElementById('cart-total').innerText);
            const totalQty = parseInt(document.getElementById('cart-count').innerText);
            
            const orderData = {
                total_price: total,
                total_quantity: totalQty,
                price_type: state.priceMode,
                payment_method: method,
                status: 'completed'
            };

            // 1. åˆ›å»ºè®¢å•
            const { data: order, error } = await supabase.from('orders').insert(orderData).select().single();
            
            if (error) {
                alert("è®¢å•ä¿å­˜å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰ï¼Œè¯·æˆªå›¾ä¿ç•™");
                // è¿™é‡Œå¯ä»¥æ‰©å±• LocalStorage ç¦»çº¿å­˜å‚¨é€»è¾‘
            } else if (order) {
                // 2. åˆ›å»ºæ˜ç»†
                const itemsData = state.cart.map(item => ({
                    order_id: order.id,
                    product_id: item.id,
                    product_name: item.name,
                    barcode: item.barcode,
                    unit_price: item.temp_price !== null ? item.temp_price : (state.priceMode === 'wholesale' ? item.wholesale_price : item.retail_price),
                    quantity: item.quantity,
                    subtotal: item.quantity * (item.temp_price !== null ? item.temp_price : (state.priceMode === 'wholesale' ? item.wholesale_price : item.retail_price))
                }));
                await supabase.from('order_items').insert(itemsData);
            }

            closeModal('modal-checkout');
            state.cart = [];
            renderCart();
            fetchOrders(); // åˆ·æ–°è®¢å•é¡µ
            // ä¸å¼¹æˆåŠŸæç¤ºï¼Œç›´æ¥å‡†å¤‡ä¸‹ä¸€å•
        }

        // --- 7. ç®¡ç†ä¸è®¢å•é€»è¾‘ ---
        function renderProductList() {
            const query = document.getElementById('manage-search').value.toLowerCase();
            const container = document.getElementById('product-list');
            container.innerHTML = '';
            
            state.products.forEach(p => {
                if (p.name.toLowerCase().includes(query) || p.barcode.includes(query)) {
                    const div = document.createElement('div');
                    div.className = `bg-white p-3 rounded-lg shadow-sm flex justify-between items-center ${p.status === 'inactive' ? 'opacity-50 grayscale' : ''}`;
                    div.innerHTML = `
                        <div>
                            <div class="font-bold">${p.name}</div>
                            <div class="text-xs text-gray-500">${p.barcode}</div>
                            <div class="text-xs text-blue-600">æ‰¹: ${p.wholesale_price} / é›¶: ${p.retail_price}</div>
                        </div>
                        <button onclick="openEditModal(${p.id})" class="px-3 py-1 bg-gray-100 rounded text-sm text-gray-600">ç¼–è¾‘</button>
                    `;
                    container.appendChild(div);
                }
            });
        }

        function openEditModal(id) {
            const p = state.products.find(x => x.id == id);
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-wholesale').value = p.wholesale_price;
            document.getElementById('edit-retail').value = p.retail_price;
            document.getElementById('edit-status').checked = p.status === 'inactive';
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        async function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const update = {
                name: document.getElementById('edit-name').value,
                wholesale_price: parseFloat(document.getElementById('edit-wholesale').value),
                retail_price: parseFloat(document.getElementById('edit-retail').value),
                status: document.getElementById('edit-status').checked ? 'inactive' : 'active'
            };
            
            await supabase.from('products').update(update).eq('id', id);
            closeModal('modal-edit');
            fetchProducts();
        }

        async function fetchOrders() {
            // è·å–ä»Šæ—¥è®¢å•
            const today = new Date().toISOString().split('T')[0];
            const { data, error } = await supabase.from('orders')
                .select('*')
                .gte('created_at', today)
                .order('created_at', { ascending: false });
                
            if (data) {
                const list = document.getElementById('order-list');
                list.innerHTML = '';
                let totalSales = 0;
                
                data.forEach(o => {
                    if (o.status === 'completed') totalSales += o.total_price;
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-lg shadow-sm";
                    div.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-gray-800">#${o.id}</span>
                            <span class="${o.status==='completed'?'text-green-600':'text-gray-400'} text-sm">${o.status==='completed'?'å®Œæˆ':'å·²ä½œåºŸ'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">${new Date(o.created_at).toLocaleTimeString()}</span>
                            <span class="font-bold">ï¿¥${o.total_price}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${o.price_type === 'wholesale' ? 'æ‰¹å‘ä»·' : 'é›¶å”®ä»·'} - ${o.payment_method}</div>
                        ${o.status === 'completed' ? `<button onclick="voidOrder(${o.id})" class="mt-2 w-full text-xs text-red-400 border border-red-100 py-1 rounded">ä½œåºŸè®¢å•</button>` : ''}
                    `;
                    list.appendChild(div);
                });
                
                document.getElementById('stats-sales').innerText = totalSales.toFixed(2);
                document.getElementById('stats-count').innerText = data.length;
            }
        }

        async function voidOrder(id) {
            if(confirm("ç¡®å®šä½œåºŸæ­¤è®¢å•ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                await supabase.from('orders').update({ status: 'void' }).eq('id', id);
                fetchOrders();
            }
        }

        // Excel å¯¼å‡º
        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(state.products);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Products");
            XLSX.writeFile(wb, "products_backup.xlsx");
        }

        // --- UI å·¥å…· ---
        function switchPage(pageId) {
            stopScanner(); // åˆ‡é¡µå¿…å…³æ‘„åƒå¤´
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('page-' + pageId).classList.add('active');
            // æ›´æ–°åº•éƒ¨å¯¼èˆªé«˜äº®
            const navIndex = ['entry', 'manage', 'cashier', 'orders'].indexOf(pageId);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // é¡µé¢ç‰¹å®šé€»è¾‘
            if (pageId === 'entry') toggleScanner('entry');
            if (pageId === 'manage') renderProductList();
            if (pageId === 'orders') fetchOrders();
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // å¯åŠ¨
        init();

        // é¡µé¢å¯è§æ€§å¤„ç† (çœç”µ/é‡Šæ”¾æ‘„åƒå¤´)
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) stopScanner();
        });

    </script>
</body>
</html>
