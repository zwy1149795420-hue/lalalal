<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æç®€æ”¶é“¶ Pro (ç»ˆæä¿®å¤ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- å…¨å±€æ ·å¼ä¼˜åŒ– --- */
        body { margin: 0; background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; } /* ä»…å…è®¸è¾“å…¥æ¡†é€‰ä¸­æ–‡æœ¬ */
        [v-cloak] { display: none; }

        /* æ‘„åƒå¤´å®¹å™¨ - ç§»åŠ¨ç«¯å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢é»‘å±é—ªçƒ */
        .scan-base { background-color: #000; border-radius: 12px; overflow: hidden; position: relative; width: 100%; }
        #reader video, #manage-reader video, #cashier-reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* æŒ‰é’®åé¦ˆ */
        .btn-press:active { transform: scale(0.96); transition: transform 0.05s; }
        
        /* ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ¯›ç»ç’ƒ */
        .nav-blur { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }

        /* åŠ¨ç”» */
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen w-full flex flex-col md:flex-row bg-slate-50 overflow-hidden text-slate-800">

    <aside class="hidden md:flex w-64 bg-slate-900 text-white flex-col shrink-0">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold flex items-center gap-2"><i class="ph-storefront text-blue-500 text-2xl"></i> æ”¶é“¶ç³»ç»Ÿ Pro</h1>
            <div class="flex items-center gap-2 mt-3 text-xs text-slate-400 font-mono">
                <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                <span>{{ isOnline ? 'äº‘ç«¯å·²è¿æ¥' : 'ç¦»çº¿æ¨¡å¼' }}</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a @click="switchTab('cashier')" :class="currentTab==='cashier'?'bg-blue-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-medium"><i class="ph-barcode text-xl"></i> æ”¶é“¶å°</a>
            <a @click="switchTab('entry')" :class="currentTab==='entry'?'bg-blue-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-medium"><i class="ph-plus-circle text-xl"></i> å•†å“å½•å…¥</a>
            <a @click="switchTab('manage')" :class="currentTab==='manage'?'bg-blue-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-medium"><i class="ph-package text-xl"></i> å•†å“ç®¡ç†</a>
            <a @click="switchTab('orders')" :class="currentTab==='orders'?'bg-blue-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-medium"><i class="ph-chart-bar text-xl"></i> é”€å”®æŠ¥è¡¨</a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <header class="md:hidden h-12 bg-white px-4 border-b border-slate-100 shrink-0 flex justify-between items-center z-20">
            <h1 class="font-bold text-slate-800">{{ currentTitle }}</h1>
            <span class="text-[10px] font-bold tracking-wider" :class="isOnline?'text-green-600':'text-red-500'">{{ isOnline ? 'ONLINE' : 'OFFLINE' }}</span>
        </header>

        <div class="flex-1 overflow-y-auto hide-scrollbar p-2 md:p-6 bg-slate-50/50 pb-[90px] md:pb-6">

            <div v-if="currentTab === 'cashier'" class="h-full flex flex-col md:flex-row gap-3">
                <div v-if="scanning" class="w-full md:w-[320px] shrink-0 animate-fade-in-up">
                    <div class="scan-base h-[200px] md:h-[240px] shadow-lg ring-4 ring-black/5">
                        <div id="cashier-reader" class="w-full h-full"></div>
                        <div class="absolute inset-0 border-2 border-white/20 rounded-xl pointer-events-none"></div>
                        <button @click="stopScanner" class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-black/60 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur">å…³é—­</button>
                    </div>
                </div>

                <div class="flex-1 flex flex-col h-full overflow-hidden gap-2 min-h-0">
                    <div class="grid grid-cols-2 gap-2 bg-white p-1 rounded-xl shadow-sm border border-slate-200/60 shrink-0">
                        <button @click="switchPriceMode('retail')" :class="priceMode==='retail'?'bg-blue-600 text-white shadow-md':'text-slate-500'" class="py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1"><i class="ph-tag-simple"></i> é›¶å”®</button>
                        <button @click="switchPriceMode('wholesale')" :class="priceMode==='wholesale'?'bg-orange-500 text-white shadow-md':'text-slate-500'" class="py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1"><i class="ph-package"></i> æ‰¹å‘</button>
                    </div>

                    <div class="bg-white p-2 rounded-xl shadow-sm border border-slate-200/60 shrink-0 relative">
                        <i class="ph-barcode absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input ref="cashierInput" v-model="cashierSearch" @keyup.enter="addToCartByInput" @focus="scrollToInput($event)" type="text" placeholder="æ¡ç  / åç§°..." class="w-full py-2 pl-9 pr-10 bg-slate-50 rounded-lg font-bold text-sm focus:ring-2 focus:ring-blue-100 outline-none transition-all">
                        <button v-if="isMobile" @click="toggleScanner('cashier')" :class="scanning?'text-blue-600 bg-blue-50':'text-slate-500'" class="absolute right-2 top-2 p-1.5 rounded transition-colors"><i class="ph-qr-code text-lg"></i></button>
                    </div>

                    <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200/60 overflow-hidden relative">
                        <div class="px-3 py-2 border-b border-slate-50 flex justify-between items-center shrink-0 bg-slate-50/50">
                            <span class="text-xs font-bold text-slate-700">æ¸…å• ({{ cartTotalQty }})</span>
                            <button @click="clearCart" class="text-red-500 text-[10px] font-bold" v-if="cart.length>0">æ¸…ç©º</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll">
                            <div v-for="(item, index) in cart" :key="index" class="flex flex-col p-2 bg-white border border-slate-100 rounded-lg shadow-sm">
                                <div class="flex justify-between items-start mb-1">
                                    <div class="font-bold text-slate-800 text-sm truncate w-4/5">{{ item.name }}</div>
                                    <button @click="removeFromCart(index)" class="text-slate-300 hover:text-red-500"><i class="ph-trash"></i></button>
                                </div>
                                <div class="flex justify-between items-center bg-slate-50 p-1 rounded">
                                    <div class="flex items-center gap-1">
                                        <button @click="item.quantity>1?item.quantity--:removeFromCart(index)" class="w-6 h-6 bg-white border rounded text-xs font-bold">-</button>
                                        <span class="w-6 text-center font-bold text-sm">{{ item.quantity }}</span>
                                        <button @click="item.quantity++" class="w-6 h-6 bg-blue-600 text-white rounded text-xs font-bold shadow-sm">+</button>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="text-[10px] text-slate-400 font-bold">R$</span>
                                        <input v-model="item.unit_price" type="number" class="w-14 text-right font-bold text-sm bg-transparent border-b border-transparent focus:border-blue-500 outline-none p-0">
                                    </div>
                                </div>
                            </div>
                            <div v-if="cart.length===0" class="h-full flex flex-col items-center justify-center text-slate-300 pb-10"><i class="ph-shopping-cart text-3xl mb-2"></i><span class="text-xs">ç©ºç©ºå¦‚ä¹Ÿ</span></div>
                        </div>
                        <div class="px-3 py-2 border-t border-slate-100 bg-white shadow-lg z-10 flex gap-3 items-center">
                            <div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold">åˆè®¡</span><span class="text-xl font-black text-slate-900 leading-none">R$ {{ cartTotalPrice }}</span></div>
                            <button @click="checkoutDirectly" :disabled="cart.length===0" class="flex-1 py-2.5 bg-slate-900 text-white rounded-lg font-bold text-sm shadow-lg btn-press disabled:opacity-50">ç¡®è®¤æ”¶æ¬¾</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'entry'" class="flex flex-col lg:flex-row gap-4 h-full">
                <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-slate-200/60 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold flex items-center gap-2"><div class="bg-blue-100 text-blue-600 p-1 rounded"><i class="ph-plus-circle"></i></div> æ–°å¢å•†å“</h2>
                        <button v-if="isMobile && !scanning" @click="toggleScanner('entry')" class="text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><i class="ph-camera"></i> æ‰«ç </button>
                    </div>

                    <div v-if="scanning" class="mb-4 scan-base h-[200px] shadow-inner ring-4 ring-black/5 rounded-xl">
                        <div id="reader" class="w-full h-full"></div>
                        <button @click="stopScanner" class="absolute bottom-2 right-2 bg-black/60 text-white px-3 py-1 rounded-full text-xs backdrop-blur">å…³é—­</button>
                    </div>

                    <div class="space-y-3 flex-1 overflow-y-auto custom-scroll pr-1">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">æ¡ç </label>
                            <div class="relative">
                                <input ref="barcodeInput" v-model="entryForm.barcode" @keyup.enter="handleBarcodeEnter" type="text" class="w-full pl-8 p-2.5 bg-slate-50 rounded-lg font-mono font-bold border-transparent focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all placeholder:text-slate-300" placeholder="æ‰«ç æˆ–è¾“å…¥">
                                <i class="ph-barcode absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">åç§°</label>
                            <input v-model="entryForm.name" type="text" class="w-full p-2.5 bg-slate-50 rounded-lg font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all" placeholder="å•†å“åç§°">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">åˆ†ç±»</label>
                            <input list="cat-list" v-model="entryForm.category" type="text" class="w-full p-2.5 bg-slate-50 rounded-lg font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all" placeholder="åˆ†ç±»">
                            <datalist id="cat-list"><option v-for="c in allCategories" :value="c"></option></datalist>
                        </div>
                        <div class="grid grid-cols-1 gap-3 pt-2 border-t border-slate-50">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">æ‰¹å‘ä»·</label>
                                <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">R$</span><input v-model="entryForm.wholesale_price" type="number" class="w-full pl-8 p-2.5 bg-slate-50 rounded-lg font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-100"></div>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-blue-500 uppercase">é›¶å”®ä»·</label>
                                <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-500 font-bold text-xs">R$</span><input v-model="entryForm.retail_price" type="number" class="w-full pl-8 p-2.5 bg-blue-50 text-blue-600 rounded-lg font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-200"></div>
                            </div>
                        </div>
                    </div>
                    <button @click="saveProduct" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold mt-4 shadow-lg btn-press flex items-center justify-center gap-2"><i class="ph-check-circle"></i> ç¡®è®¤æ·»åŠ </button>
                </div>

                <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-slate-200/60 flex flex-col h-full overflow-hidden">
                    <h3 class="text-sm font-bold mb-3 flex items-center gap-2"><div class="bg-orange-100 text-orange-600 p-1 rounded"><i class="ph-clock-counter-clockwise"></i></div> åˆšåˆšå½•å…¥</h3>
                    <div class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-1">
                        <div v-for="p in recentProducts" :key="p.id" class="p-2 border border-slate-100 rounded-lg flex justify-between items-center bg-slate-50 hover:bg-blue-50 transition-colors">
                            <div class="overflow-hidden"><div class="font-bold text-slate-800 text-sm truncate">{{ p.name }}</div><div class="text-[10px] text-slate-400 font-mono">{{ p.barcode }}</div></div>
                            <div class="text-right shrink-0"><div class="text-sm text-blue-600 font-bold">R$ {{ p.retail_price }}</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'manage'" class="flex flex-col h-full space-y-3">
                <div class="flex flex-col md:flex-row gap-2">
                    <div class="flex gap-2 bg-white p-2 rounded-xl border border-slate-200/60 flex-1">
                        <i class="ph-magnifying-glass text-slate-400 self-center ml-2"></i>
                        <input ref="manageInput" v-model="searchText" type="text" placeholder="æœç´¢..." class="flex-1 bg-transparent text-sm font-bold outline-none">
                        <button v-if="isMobile" @click="toggleScanner('manage')" :class="scanning?'text-blue-600 bg-blue-50':'text-slate-500'" class="p-2 rounded"><i class="ph-qr-code text-lg"></i></button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                        <select v-model="productFilterStatus" class="bg-white border rounded-lg text-xs font-bold p-2 outline-none"><option value="all">å…¨éƒ¨çŠ¶æ€</option><option value="active">æ­£å¸¸</option><option value="disabled">æš‚åœ</option></select>
                        <button @click="exportExcel" class="bg-green-50 text-green-600 px-3 rounded-lg font-bold text-xs flex items-center gap-1 border border-green-100"><i class="ph-file-xls"></i> å¯¼å‡º</button>
                        <label class="bg-blue-50 text-blue-600 px-3 rounded-lg font-bold text-xs flex items-center gap-1 border border-blue-100 cursor-pointer"><i class="ph-upload-simple"></i> å¯¼å…¥<input type="file" @change="importExcel" class="hidden" accept=".xlsx"></label>
                    </div>
                </div>
                
                <div v-if="isMobile && scanning" class="scan-base h-[200px] shrink-0 rounded-xl mb-2"><div id="manage-reader" class="w-full h-full"></div><button @click="stopScanner" class="absolute bottom-2 right-2 bg-black/60 text-white px-2 py-1 text-xs rounded-full">å…³é—­</button></div>

                <div class="flex-1 overflow-y-auto custom-scroll grid grid-cols-1 md:grid-cols-3 gap-2 content-start pb-20">
                    <div v-for="p in filteredProducts" :key="p.id" @click="editProduct(p)" class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm active:scale-95 transition-transform relative overflow-hidden group">
                        <div v-if="p.status==='disabled'" class="absolute right-0 top-0 bg-red-100 text-red-600 text-[10px] px-2 rounded-bl font-bold">å·²æš‚åœ</div>
                        <h3 class="font-bold text-sm text-slate-800 truncate">{{ p.name }}</h3>
                        <p class="text-[10px] text-slate-400 font-mono mb-2">{{ p.barcode }}</p>
                        <div class="flex justify-between border-t border-slate-50 pt-1.5"><span class="text-[10px] text-slate-400">è¿›:{{ p.wholesale_price }}</span><span class="text-xs font-bold text-blue-600">å–:{{ p.retail_price }}</span></div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'orders'" class="space-y-4 max-w-3xl mx-auto">
                <div class="bg-slate-900 p-5 rounded-2xl text-white shadow-lg relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-24 h-24 bg-blue-500/20 rounded-full blur-xl"></div>
                    <div class="text-xs text-slate-400 font-bold uppercase">ä»Šæ—¥é”€å”®</div>
                    <div class="text-3xl font-black mt-1">R$ {{ todaySales.toFixed(2) }}</div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center"><span class="font-bold text-xs">ğŸ“¦ è®¢å•åˆ—è¡¨</span><div class="flex gap-1"><button @click="orderFilterType='completed'" :class="orderFilterType==='completed'?'bg-white text-blue-600 shadow-sm':''" class="px-2 py-1 rounded text-[10px] font-bold transition-all">æ­£å¸¸</button><button @click="orderFilterType='void'" :class="orderFilterType==='void'?'bg-white text-red-500 shadow-sm':''" class="px-2 py-1 rounded text-[10px] font-bold transition-all">ä½œåºŸ</button></div></div>
                    <div class="max-h-[400px] overflow-y-auto custom-scroll divide-y divide-slate-50">
                        <div v-for="o in filteredOrdersList" :key="o.id" @click="viewOrderDetails(o)" class="p-3 flex justify-between items-center active:bg-slate-50">
                            <div><div class="font-bold text-sm">R$ {{ o.total_price }}</div><div class="text-[10px] text-slate-400 font-mono">{{ formatDate(o.created_at) }}</div></div>
                            <div class="text-right"><div class="text-xs font-bold text-slate-500">{{ o.total_quantity }}ä»¶</div><button v-if="o.status==='completed'" @click.stop="voidOrder(o)" class="text-[10px] text-red-400 border border-red-100 px-1 rounded mt-1">ä½œåºŸ</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav class="md:hidden fixed bottom-0 left-0 right-0 h-[80px] nav-blur flex justify-around items-center z-40 text-slate-400 border-t border-slate-200">
            <div @click="switchTab('cashier')" :class="{'text-blue-600':currentTab==='cashier'}" class="flex flex-col items-center w-1/4 pt-2 btn-press"><i class="ph-barcode text-2xl mb-1"></i><span class="text-[10px] font-bold">æ”¶é“¶</span></div>
            <div @click="switchTab('entry')" :class="{'text-blue-600':currentTab==='entry'}" class="flex flex-col items-center w-1/4 pt-2 btn-press"><i class="ph-plus-circle text-2xl mb-1"></i><span class="text-[10px] font-bold">å½•å…¥</span></div>
            <div @click="switchTab('manage')" :class="{'text-blue-600':currentTab==='manage'}" class="flex flex-col items-center w-1/4 pt-2 btn-press"><i class="ph-package text-2xl mb-1"></i><span class="text-[10px] font-bold">ç®¡ç†</span></div>
            <div @click="switchTab('orders')" :class="{'text-blue-600':currentTab==='orders'}" class="flex flex-col items-center w-1/4 pt-2 btn-press"><i class="ph-chart-bar text-2xl mb-1"></i><span class="text-[10px] font-bold">æŠ¥è¡¨</span></div>
        </nav>
    </main>

    <div v-if="showEntryModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in-up">
            <div class="text-center mb-4"><i class="ph-check-circle text-green-500 text-4xl"></i><h3 class="font-bold text-lg mt-2">æ‰«ç æˆåŠŸ</h3><p class="text-xs font-mono bg-slate-100 inline-block px-2 py-1 rounded mt-1">{{ entryForm.barcode }}</p></div>
            <div class="space-y-3">
                <input v-model="entryForm.name" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-blue-100" placeholder="å•†å“åç§°">
                <input v-model="entryForm.category" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-blue-100" placeholder="åˆ†ç±»">
                <div class="flex gap-3">
                    <input v-model="entryForm.wholesale_price" type="number" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" placeholder="è¿›ä»·">
                    <input v-model="entryForm.retail_price" type="number" class="w-full p-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm outline-none" placeholder="å”®ä»·">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                 <button @click="showEntryModal=false;scanning=true;startScanner('entry')" class="py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">æ”¾å¼ƒ</button>
                 <button @click="confirmAndContinueScan" class="py-3 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg btn-press">ç¡®è®¤å¹¶ç»§ç»­</button>
            </div>
        </div>
    </div>

    <div v-if="showQuickAdd" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-start pt-[20%] justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in-up">
            <div class="text-center mb-6">
                <h3 class="font-bold text-xl">å•†å“æœªå½•å…¥</h3>
                <p class="text-xs text-slate-400 font-mono mt-1 bg-slate-100 inline-block px-2 rounded">{{ quickAddForm.barcode }}</p>
            </div>
            <div class="mb-6">
                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2 text-center">è¾“å…¥{{ priceMode === 'retail' ? 'é›¶å”®' : 'æ‰¹å‘' }}å•ä»·</label>
                <div class="relative"><span class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xl">R$</span><input ref="quickPriceInput" v-model="quickAddForm.price" type="number" class="w-full p-4 pl-14 bg-slate-50 rounded-xl font-black text-3xl text-center outline-none focus:ring-2 focus:ring-blue-500"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button @click="showQuickAdd=false" class="py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
                <button @click="saveQuickAdd" class="py-3 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg btn-press">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <div v-if="editingProduct" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-xl animate-fade-in-up">
            <h3 class="font-bold mb-4">ç¼–è¾‘å•†å“</h3>
            <div class="space-y-3">
                <input v-model="editingProduct.name" class="w-full p-2 border rounded font-bold text-sm">
                <div class="flex gap-2"><input v-model="editingProduct.wholesale_price" type="number" class="w-full p-2 border rounded text-sm"><input v-model="editingProduct.retail_price" type="number" class="w-full p-2 border rounded text-sm text-blue-600 font-bold"></div>
                <select v-model="editingProduct.status" class="w-full p-2 border rounded text-sm font-bold"><option value="active">æ­£å¸¸</option><option value="disabled">æš‚åœ</option></select>
            </div>
            <div class="flex gap-2 mt-4"><button @click="deleteProduct" class="flex-1 py-2 bg-red-50 text-red-500 rounded font-bold text-sm">åˆ é™¤</button><button @click="updateProduct" class="flex-1 py-2 bg-slate-900 text-white rounded font-bold text-sm">ä¿å­˜</button></div>
            <button @click="editingProduct=null" class="w-full mt-2 text-xs text-slate-400 font-bold py-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="viewingOrder" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-xl flex flex-col max-h-[70vh] animate-fade-in-up">
            <div class="flex justify-between items-center mb-3 pb-2 border-b"><h3 class="font-bold">è®¢å•è¯¦æƒ…</h3><button @click="viewingOrder=null"><i class="ph-x text-lg"></i></button></div>
            <div class="flex-1 overflow-y-auto custom-scroll space-y-2">
                <div v-for="i in viewingOrderItems" :key="i.id" class="flex justify-between text-sm"><span class="text-slate-600">{{ i.product_name }} <span class="text-xs text-slate-400">x{{ i.quantity }}</span></span><span class="font-bold">R$ {{ (i.unit_price*i.quantity).toFixed(2) }}</span></div>
            </div>
            <div class="mt-3 pt-3 border-t flex justify-between items-center"><span class="text-xs font-bold text-slate-500">æ€»è®¡</span><span class="text-xl font-black text-slate-900">R$ {{ viewingOrder.total_price }}</span></div>
        </div>
    </div>

</div>
<script>
    const { createClient } = supabase;
    // âš ï¸ å¡«å†™é…ç½®
    const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';

    const app = Vue.createApp({
        data() {
            return {
                supabase: null, isOnline: navigator.onLine, isMobile: /Android|iPhone|iPad|iPod/i.test(navigator.userAgent),
                currentTab: 'cashier',
                products: [], orders: [], orderItems: [],
                entryForm: { barcode: '', name: '', category: '', wholesale_price: '', retail_price: '' },
                quickAddForm: { barcode: '', price: '' }, editingProduct: null,
                scanning: false, html5QrCode: null, lastScanTime: 0,
                searchText: '', cashierSearch: '', productFilterStatus: 'active', orderFilterType: 'completed',
                showQuickAdd: false, showEntryModal: false, viewingOrder: null,
                priceMode: 'retail', cart: [], recentProducts: [],
                syncQueue: JSON.parse(localStorage.getItem('syncQueue') || '[]')
            }
        },
        computed: {
            currentTitle() { return { entry: 'å•†å“å½•å…¥', manage: 'å•†å“ç®¡ç†', cashier: 'å‰å°æ”¶é“¶', orders: 'é”€å”®æŠ¥è¡¨' }[this.currentTab]; },
            allCategories() { return Array.from(new Set(this.products.map(p => p.category || 'é»˜è®¤'))).sort(); },
            filteredProducts() {
                let list = this.products;
                if (this.productFilterStatus !== 'all') list = list.filter(p => p.status === this.productFilterStatus);
                if (this.searchText) { const low = this.searchText.toLowerCase(); list = list.filter(p => p.name?.toLowerCase().includes(low) || p.barcode.includes(low)); }
                return list;
            },
            filteredOrdersList() { return this.orders.filter(o => o.status === this.orderFilterType).sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); },
            cartTotalPrice() { return this.cart.reduce((s, i) => s + (i.unit_price * i.quantity), 0).toFixed(2); },
            cartTotalQty() { return this.cart.reduce((s, i) => s + i.quantity, 0); },
            viewingOrderItems() { return this.viewingOrder ? this.orderItems.filter(i => i.order_id === this.viewingOrder.id) : []; },
            todaySales() { 
                const today = new Date().toLocaleDateString('zh-CN', { timeZone: 'America/Sao_Paulo' }).split('/').join('-');
                return this.orders.filter(o => o.status === 'completed' && this.formatDate(o.created_at).includes(today)).reduce((s, o) => s + o.total_price, 0); 
            }
        },
        async mounted() {
            this.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            this.loadLocalData(); await this.fetchData();
            window.addEventListener('online', () => { this.isOnline = true; this.processSyncQueue(); });
            window.addEventListener('offline', () => this.isOnline = false);
            setInterval(this.processSyncQueue, 10000);
            this.autoFocusPC('cashier'); // åˆå§‹èšç„¦
        },
        methods: {
            // --- æ ¸å¿ƒä¿®å¤ï¼šå£°éŸ³ ---
            playBeep() { 
                try {
                    const a = new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAAB3d3d3d3d3d4eHh4eHh4eHl5eXl5eXl5eYmJiYmJiYmJiXl5eXl5eXl5eHh4eHh4eHh4d3d3d3d3d3d3d3d3d3d3d3d4eHh4eHh4eHl5eXl5eXl5eYmJiYmJiYmJiXl5eXl5eXl5eHh4eHh4eHh4d3d3d3d3d3dw=="); 
                    a.volume = 1.0; a.currentTime = 0; // ğŸš€ å…³é”®ï¼šæ¯æ¬¡é‡ç½®è¿›åº¦
                    a.play().catch(()=>{}); if (navigator.vibrate) navigator.vibrate(200);
                } catch(e) {}
            },
            
            // --- æ ¸å¿ƒä¿®å¤ï¼šé»‘å±é‡å¯é€»è¾‘ ---
            async confirmAndContinueScan() {
                if (!this.saveProduct()) return; // ä¿å­˜å¤±è´¥åˆ™ä¸­æ–­
                this.showEntryModal = false;
                // ğŸš€ é”€æ¯ -> ç­‰å¾… -> é‡å»º
                this.scanning = false;
                await this.$nextTick(); 
                this.scanning = true;
                await this.$nextTick(); 
                this.startScanner('entry');
            },

            // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ‰«ç  ---
            async toggleScanner(tab) { 
                if (this.scanning) await this.stopScanner(); 
                else { this.currentTab = tab; this.scanning = true; await this.$nextTick(); this.startScanner(tab); } 
            },
            async startScanner(tab) {
                const id = tab === 'entry' ? "reader" : (tab === 'manage' ? 'manage-reader' : "cashier-reader");
                if (this.html5QrCode) { try { await this.html5QrCode.stop(); } catch(e){} this.html5QrCode = null; }
                await this.$nextTick(); if (!document.getElementById(id)) return;

                this.html5QrCode = new Html5Qrcode(id);
                const config = { fps: 15, qrbox: { width: 280, height: 150 }, experimentalFeatures: { useBarCodeDetectorIfSupported: true } };
                try { await this.html5QrCode.start({ facingMode: "environment" }, config, (txt) => this.onScanSuccess(txt, tab), () => {}); } 
                catch (e) { this.scanning = false; alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥"); }
            },
            async stopScanner() { if(this.html5QrCode){try{await this.html5QrCode.stop();this.html5QrCode.clear();}catch(e){}} this.html5QrCode=null; this.scanning=false; },
            onScanSuccess(txt, tab) {
                if (Date.now() - this.lastScanTime < 2000) return; this.lastScanTime = Date.now();
                this.playBeep();
                if (tab === 'entry') { this.entryForm.barcode = txt; if(this.isMobile){this.stopScanner();this.showEntryModal=true;}else{this.handleBarcodeEnter();} }
                else if (tab === 'cashier') { this.cashierSearch = txt; this.addToCartByInput(); }
                else if (tab === 'manage') { this.searchText = txt; }
            },

            // --- æ ¸å¿ƒä¿®å¤ï¼šè‡ªåŠ¨èšç„¦ ---
            async switchTab(tab) {
                if (this.scanning) await this.stopScanner();
                this.currentTab = tab;
                this.autoFocusPC(tab);
            },
            autoFocusPC(tab) {
                if (this.isMobile) return;
                this.$nextTick(() => {
                    if (tab==='cashier' && this.$refs.cashierInput) this.$refs.cashierInput.focus();
                    if (tab==='entry' && this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
                    if (tab==='manage' && this.$refs.manageInput) this.$refs.manageInput.focus();
                });
            },

            // --- ä¸šåŠ¡é€»è¾‘ ---
            saveProduct() {
                if (!this.entryForm.barcode) { alert('ç¼ºæ¡ç '); return false; }
                const p = { 
                    id: Date.now().toString() + Math.floor(Math.random()*1000), // ğŸš€ å…¼å®¹ID
                    barcode: this.entryForm.barcode, 
                    name: this.entryForm.name || `æœªå‘½å${this.products.length+1}`, 
                    category: this.entryForm.category || 'é»˜è®¤', 
                    wholesale_price: parseFloat(this.entryForm.wholesale_price)||0, 
                    retail_price: parseFloat(this.entryForm.retail_price)||0, 
                    status: 'active' 
                };
                this.products.unshift(p); localStorage.setItem('products', JSON.stringify(this.products));
                this.addToSyncQueue('products', 'insert', p);
                this.recentProducts.unshift(p);
                this.entryForm = { barcode: '', name: '', category: '', wholesale_price: '', retail_price: '' };
                this.autoFocusPC('entry'); // å½•å…¥åå›ç„¦
                return true;
            },
            addToCartByInput() {
                const term = this.cashierSearch.trim(); if (!term) return;
                let p = this.products.find(x => (x.barcode === term || x.name === term) && x.status === 'active');
                if (p) {
                    const ex = this.cart.find(i => i.product_id === p.id);
                    if (ex) ex.quantity++; 
                    else this.cart.push({ product_id: p.id, name: p.name, barcode: p.barcode, unit_price: this.priceMode==='retail'?p.retail_price:p.wholesale_price, quantity: 1 });
                    this.cashierSearch = '';
                } else {
                    this.quickAddForm = { barcode: term, price: '' }; this.showQuickAdd = true;
                    this.$nextTick(()=>this.$refs.quickPriceInput?.focus());
                }
            },
            saveQuickAdd() {
                if (!this.quickAddForm.price) return;
                const p = { id: Date.now().toString(), barcode: this.quickAddForm.barcode, name: `æ–°å•†å“${this.products.length+1}`, wholesale_price: parseFloat(this.quickAddForm.price), retail_price: parseFloat(this.quickAddForm.price), status: 'active', category: 'é»˜è®¤' };
                this.products.unshift(p); this.addToSyncQueue('products', 'insert', p);
                this.cart.push({ product_id: p.id, name: p.name, barcode: p.barcode, unit_price: p.retail_price, quantity: 1 });
                this.showQuickAdd = false; this.cashierSearch = '';
            },
            checkoutDirectly() {
                if (!confirm(`ç¡®è®¤æ”¶æ¬¾ R$ ${this.cartTotalPrice}?`)) return;
                const order = { id: Date.now().toString(), total_price: parseFloat(this.cartTotalPrice), total_quantity: this.cartTotalQty, price_type: this.priceMode, payment_method: 'cash', status: 'completed', created_at: new Date().toISOString() };
                const items = this.cart.map(i => ({ order_id: order.id, product_id: i.product_id, product_name: i.name, barcode: i.barcode, unit_price: i.unit_price, quantity: i.quantity, subtotal: i.unit_price*i.quantity }));
                this.orders.unshift(order); this.orderItems.push(...items);
                localStorage.setItem('orders', JSON.stringify(this.orders)); localStorage.setItem('orderItems', JSON.stringify(this.orderItems));
                this.addToSyncQueue('orders', 'insert', order); this.addToSyncQueue('order_items', 'insert', items);
                this.cart = []; this.switchTab('orders');
            },
            
            // --- åŸºç¡€æ•°æ®åŠŸèƒ½ ---
            loadLocalData() { this.products = JSON.parse(localStorage.getItem('products') || '[]'); this.orders = JSON.parse(localStorage.getItem('orders') || '[]'); this.orderItems = JSON.parse(localStorage.getItem('orderItems') || '[]'); },
            async fetchData() {
                if (!this.isOnline) return;
                const [p, o, oi] = await Promise.all([this.supabase.from('products').select('*'), this.supabase.from('orders').select('*').limit(100), this.supabase.from('order_items').select('*').limit(500)]);
                if(p.data) { this.products = p.data; localStorage.setItem('products', JSON.stringify(p.data)); }
                if(o.data) { this.orders = o.data; localStorage.setItem('orders', JSON.stringify(o.data)); }
                if(oi.data) { this.orderItems = oi.data; localStorage.setItem('orderItems', JSON.stringify(oi.data)); }
            },
            addToSyncQueue(tbl, act, dat) { this.syncQueue.push({ t: tbl, a: act, d: dat }); localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue)); this.processSyncQueue(); },
            async processSyncQueue() {
                if (!this.isOnline || !this.syncQueue.length) return; const i = this.syncQueue[0];
                try {
                    if (i.a === 'insert') await this.supabase.from(i.t).insert(i.d);
                    else if (i.a === 'update') { const { id, ...u } = i.d; await this.supabase.from(i.t).update(u).eq('id', id); }
                    else if (i.a === 'delete') await this.supabase.from(i.t).delete().eq('id', i.d.id);
                    this.syncQueue.shift(); localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue)); this.processSyncQueue();
                } catch (e) { console.error(e); setTimeout(this.processSyncQueue, 5000); }
            },
            
            // --- è¾…åŠ© ---
            switchPriceMode(m) { this.priceMode = m; this.cart.forEach(i => { const p = this.products.find(x => x.id === i.product_id); if(p) i.unit_price = m==='retail'?p.retail_price:p.wholesale_price; }); },
            removeFromCart(i) { this.cart.splice(i, 1); }, clearCart() { if(confirm('æ¸…ç©º?')) this.cart = []; },
            voidOrder(o) { if(!confirm('ä½œåºŸ?')) return; o.status = 'void'; localStorage.setItem('orders', JSON.stringify(this.orders)); this.addToSyncQueue('orders', 'update', { id: o.id, status: 'void' }); },
            editProduct(p) { this.editingProduct = JSON.parse(JSON.stringify(p)); },
            async updateProduct() { const idx = this.products.findIndex(p => p.id === this.editingProduct.id); if(idx!==-1) this.products[idx] = this.editingProduct; localStorage.setItem('products', JSON.stringify(this.products)); this.addToSyncQueue('products', 'update', this.editingProduct); this.editingProduct = null; },
            async deleteProduct() { if(!confirm('åˆ é™¤?')) return; const id = this.editingProduct.id; this.products = this.products.filter(p => p.id !== id); localStorage.setItem('products', JSON.stringify(this.products)); if(this.isOnline) await this.supabase.from('products').delete().eq('id', id); else this.addToSyncQueue('products', 'delete', {id}); this.editingProduct=null; },
            exportExcel() { const ws=XLSX.utils.json_to_sheet(this.products); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Products"); XLSX.writeFile(wb,"Products.xlsx"); },
            importExcel(e) { 
                const f=e.target.files[0]; const r=new FileReader(); 
                r.onload=(ev)=>{ const d=XLSX.utils.sheet_to_json(XLSX.read(ev.target.result,{type:'binary'}).Sheets[Object.keys(XLSX.read(ev.target.result,{type:'binary'}).Sheets)[0]]); 
                if(confirm(`å¯¼å…¥${d.length}æ¡?`)) { d.forEach(r=>{ const p={id:Date.now()+Math.random().toString(),barcode:r['barcode']||r['æ¡ç '],name:r['name']||r['åç§°'],wholesale_price:r['wholesale']||0,retail_price:r['retail']||0,status:'active',category:'é»˜è®¤'}; if(p.barcode) { this.products.unshift(p); this.addToSyncQueue('products','insert',p); } }); window.location.reload(); } }; r.readAsBinaryString(f); 
            },
            handleBarcodeEnter() { if(this.entryForm.barcode) { const p = this.products.find(x => x.barcode === this.entryForm.barcode); if(p) alert('å·²å­˜åœ¨: '+p.name); } },
            formatDate(s) { return new Date(s).toLocaleString('zh-CN', { timeZone: 'America/Sao_Paulo', month:'numeric', day:'numeric', hour:'numeric', minute:'numeric', hour12: false }); },
            scrollToInput(e) { setTimeout(()=>e.target.scrollIntoView({behavior:'smooth',block:'center'}), 300); }
        }
    });
    app.mount('#app');
</script>
</body>
</html>

