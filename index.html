<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Smart POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .touch-target { min-height: 44px; min-width: 44px; }
        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#2563eb', secondary: '#64748b', surface: '#f8fafc' }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-slate-800 font-sans h-[100dvh] w-full flex flex-col overflow-hidden">

    <header class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm shrink-0 z-20">
        <h1 class="font-bold text-lg text-slate-800 flex items-center gap-2">
            <i data-lucide="scan-barcode" class="w-6 h-6 text-primary"></i>
            Smart POS
        </h1>
        <div id="header-actions"></div>
    </header>

    <main id="app" class="flex-1 overflow-hidden relative w-full">
        </main>

    <nav class="bg-white border-t flex justify-around items-center pb-safe shrink-0 z-30 h-[60px]">
        <button onclick="router.navigate('cashier')" class="flex-1 h-full flex flex-col justify-center items-center gap-1 text-xs text-slate-500 nav-btn" data-target="cashier">
            <i data-lucide="shopping-cart" class="w-5 h-5"></i> 收银
        </button>
        <button onclick="router.navigate('entry')" class="flex-1 h-full flex flex-col justify-center items-center gap-1 text-xs text-slate-500 nav-btn" data-target="entry">
            <i data-lucide="plus-square" class="w-5 h-5"></i> 入库
        </button>
        <button onclick="router.navigate('inventory')" class="flex-1 h-full flex flex-col justify-center items-center gap-1 text-xs text-slate-500 nav-btn" data-target="inventory">
            <i data-lucide="package" class="w-5 h-5"></i> 管理
        </button>
        <button onclick="router.navigate('analytics')" class="flex-1 h-full flex flex-col justify-center items-center gap-1 text-xs text-slate-500 nav-btn" data-target="analytics">
            <i data-lucide="bar-chart-2" class="w-5 h-5"></i> 报表
        </button>
    </nav>

    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end sm:items-center justify-center transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full sm:w-[400px] rounded-t-2xl sm:rounded-xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0"></div>
    </div>

    <script>
        // State & Utils (保持不变，省略以节省空间，与上一版一致)
        const Store = {
            data: { products: [], transactions: [], autoNameCount: 1 },
            init() { const l = localStorage.getItem('pos_data'); if(l) this.data = JSON.parse(l); },
            save() { localStorage.setItem('pos_data', JSON.stringify(this.data)); },
            addProduct(p) { 
                const idx = this.data.products.findIndex(x => x.barcode === p.barcode);
                idx >= 0 ? this.data.products[idx] = {...this.data.products[idx], ...p} : this.data.products.push({...p, id: Date.now()});
                this.save();
            },
            deleteProduct(b) { this.data.products = this.data.products.filter(p => p.barcode !== b); this.save(); },
            addTransaction(t) { this.data.transactions.push(t); this.save(); },
            getProduct(b) { return this.data.products.find(p => p.barcode === b); },
            getNextAutoName() { return `未命名商品 ${this.data.autoNameCount}`; },
            incrementAutoName() { this.data.autoNameCount++; this.save(); }
        };
        const Utils = {
            formatCurrency: (n) => `¥${parseFloat(n).toFixed(2)}`,
            vibrate: () => { if (navigator.vibrate) navigator.vibrate(50); },
            generateId: () => Math.random().toString(36).substr(2, 9),
            now: () => new Date().toISOString()
        };
        let html5QrcodeScanner = null;
        const Scanner = {
            start: (elId, cb) => {
                if(html5QrcodeScanner) Scanner.stop();
                html5QrcodeScanner = new Html5Qrcode(elId);
                html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (d) => { Utils.vibrate(); cb(d); }).catch(console.error);
            },
            stop: () => { if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }).catch(console.error); }
        };

        // --- 视图修正重点 ---

        // View: Cashier (收银) - 布局重构
        const CashierView = {
            cart: [],
            mode: 'retail',
            render: () => {
                const header = document.getElementById('header-actions');
                header.innerHTML = `
                    <div class="flex bg-slate-100 rounded-lg p-1">
                        <button onclick="CashierView.toggleMode('retail')" class="px-3 py-1 text-xs rounded-md ${CashierView.mode === 'retail' ? 'bg-white shadow text-primary font-bold' : 'text-slate-500'}">零售</button>
                        <button onclick="CashierView.toggleMode('wholesale')" class="px-3 py-1 text-xs rounded-md ${CashierView.mode === 'wholesale' ? 'bg-white shadow text-primary font-bold' : 'text-slate-500'}">批发</button>
                    </div>
                `;

                // 修复点2: 使用 Flex-Col 布局，让 list 自动撑开中间，Footer 自然处于底部，不使用 fixed
                return `
                    <div class="flex flex-col h-full w-full">
                        <div class="p-4 bg-white border-b shrink-0">
                            <div class="flex gap-2">
                                <input type="text" id="cashier-input" placeholder="扫码或输入条码..." class="flex-1 border p-3 rounded-lg shadow-sm bg-gray-50 text-lg" onkeypress="CashierView.handleInput(event)" inputmode="numeric">
                                <button onclick="CashierView.openScanner()" class="bg-slate-800 text-white w-12 rounded-lg flex items-center justify-center shrink-0">
                                    <i data-lucide="scan"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="cart-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
                            ${CashierView.cart.length === 0 ? '<div class="h-full flex flex-col items-center justify-center text-slate-300"><i data-lucide="shopping-cart" class="w-12 h-12 mb-2 opacity-50"></i><p>购物车为空</p></div>' : ''}
                            ${CashierView.cart.map((item, index) => `
                                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 flex justify-between items-center">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-slate-800 truncate pr-2">${item.name}</div>
                                        <div class="text-xs text-slate-400 font-mono">${item.barcode}</div>
                                        <div class="text-primary font-bold mt-1">${Utils.formatCurrency(item.price)}</div>
                                    </div>
                                    <div class="flex items-center gap-3 bg-slate-50 rounded-lg p-1 shrink-0">
                                        <button onclick="CashierView.updateQty(${index}, -1)" class="w-8 h-8 flex items-center justify-center text-slate-500 active:bg-slate-200 rounded text-lg">-</button>
                                        <span class="font-bold w-6 text-center">${item.qty}</span>
                                        <button onclick="CashierView.updateQty(${index}, 1)" class="w-8 h-8 flex items-center justify-center text-primary active:bg-blue-100 rounded text-lg">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0 z-10">
                            <div class="flex justify-between items-end mb-3">
                                <div class="text-slate-500 text-sm">共 ${CashierView.cart.reduce((a, b) => a + b.qty, 0)} 件</div>
                                <div class="text-2xl font-bold text-slate-800">
                                    ${Utils.formatCurrency(CashierView.getTotal())}
                                </div>
                            </div>
                            <button onclick="CashierView.checkout()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-600/30 active:scale-95 transition-transform text-lg">
                                结算收款
                            </button>
                        </div>
                    </div>
                `;
            },
            // ... (逻辑保持不变)
            toggleMode: (m) => { CashierView.mode = m; CashierView.recalcCart(); router.refresh(); },
            recalcCart: () => { CashierView.cart = CashierView.cart.map(i => ({...i, price: CashierView.mode === 'retail' ? Store.getProduct(i.barcode)?.retailPrice || 0 : Store.getProduct(i.barcode)?.costPrice || 0})); },
            handleInput: (e) => { if(e.key === 'Enter'){ CashierView.addToCart(e.target.value); e.target.value = ''; } },
            openScanner: () => { Modal.show(`<div id="c-r" class="h-64 bg-black"></div><button onclick="Modal.hide();Scanner.stop()" class="w-full mt-4 py-3 border rounded-lg">关闭</button>`); Scanner.start("c-r", (b)=>{Scanner.stop();Modal.hide();CashierView.addToCart(b);}); },
            addToCart: (b) => { 
                const p = Store.getProduct(b); 
                if(!p) return Toast.show("未找到商品", "error");
                const ex = CashierView.cart.find(i => i.barcode === b);
                ex ? ex.qty++ : CashierView.cart.push({barcode: p.barcode, name: p.name, price: CashierView.mode==='retail'?p.retailPrice:p.costPrice, cost: p.costPrice, qty: 1});
                router.refresh(); Utils.vibrate();
            },
            updateQty: (i, d) => { CashierView.cart[i].qty += d; if(CashierView.cart[i].qty <= 0) CashierView.cart.splice(i, 1); router.refresh(); },
            getTotal: () => CashierView.cart.reduce((s, i) => s + (i.price * i.qty), 0),
            checkout: () => {
                if(CashierView.cart.length===0) return;
                const t = CashierView.getTotal();
                Store.addTransaction({id:Utils.generateId(), date:Utils.now(), items:[...CashierView.cart], totalAmount:t, totalCount:CashierView.cart.reduce((a,b)=>a+b.qty,0)});
                CashierView.cart=[]; router.refresh(); Toast.show(`收款 ${Utils.formatCurrency(t)}`);
            }
        };

        // View: Inventory Entry (入库) - 滚动优化
        const EntryView = {
            render: () => `
                <div class="flex flex-col h-full p-4 overflow-y-auto">
                    <div id="reader" class="w-full bg-slate-900 rounded-2xl overflow-hidden aspect-square shadow-inner relative mb-6 shrink-0">
                        <div class="absolute inset-0 flex items-center justify-center text-white/50"><span class="text-sm">点击按钮激活</span></div>
                    </div>
                    <button onclick="EntryView.startScan()" class="bg-primary text-white py-4 rounded-xl font-bold shadow-lg shadow-primary/30 active:scale-95 transition-transform flex items-center justify-center gap-2 shrink-0">
                        <i data-lucide="camera"></i> 开启摄像头扫码
                    </button>
                    <div class="text-center text-slate-400 text-xs mt-4">支持连续扫码录入</div>
                </div>
            `,
            startScan: () => { document.getElementById('reader').innerHTML=''; Scanner.start("reader", (b)=>{ Scanner.stop(); EntryView.openEditModal(b); }); },
            openEditModal: (b) => {
                const ex = Store.getProduct(b);
                Modal.show(`
                    <h2 class="text-xl font-bold mb-4">商品入库</h2>
                    <form onsubmit="EntryView.save(event)">
                        <div class="space-y-4">
                            <div><label class="text-xs text-slate-500">条码</label><input name="barcode" value="${b}" class="w-full bg-slate-100 p-3 rounded-lg font-mono text-sm" readonly></div>
                            <div><label class="text-xs text-slate-500">名称</label><input name="name" value="${ex?ex.name:''}" placeholder="自动命名" class="w-full border p-3 rounded-lg"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs text-slate-500">进价</label><input type="number" step="0.01" name="cost" value="${ex?ex.costPrice:''}" class="w-full border p-3 rounded-lg" required></div>
                                <div><label class="text-xs text-slate-500">售价</label><input type="number" step="0.01" name="retail" value="${ex?ex.retailPrice:''}" class="w-full border p-3 rounded-lg" required></div>
                            </div>
                            <div class="pt-4 flex gap-3"><button type="button" onclick="Modal.hide();EntryView.startScan()" class="flex-1 py-3 bg-slate-100 rounded-lg text-slate-500">取消</button><button type="submit" class="flex-1 py-3 bg-primary text-white rounded-lg font-bold">保存继续</button></div>
                        </div>
                    </form>
                `);
            },
            save: (e) => {
                e.preventDefault(); const fd = new FormData(e.target);
                let n = fd.get('name').trim(); if(!n){ n=Store.getNextAutoName(); Store.incrementAutoName(); }
                Store.addProduct({barcode:fd.get('barcode'), name:n, costPrice:parseFloat(fd.get('cost')), retailPrice:parseFloat(fd.get('retail'))});
                Modal.hide(); setTimeout(()=>EntryView.startScan(), 300); Toast.show(`已存: ${n}`);
            }
        };

        // View: Inventory List (管理)
        const InventoryView = {
            searchQuery: '',
            render: () => {
                const ps = Store.data.products.filter(p => p.name.includes(InventoryView.searchQuery) || p.barcode.includes(InventoryView.searchQuery));
                document.getElementById('header-actions').innerHTML = `<button onclick="InventoryView.exp()" class="text-xs bg-slate-100 p-2 rounded flex gap-1"><i data-lucide="download" class="w-4 h-4"></i></button>`;
                return `
                    <div class="flex flex-col h-full">
                        <div class="p-4 bg-white border-b shrink-0">
                            <input type="text" placeholder="搜索商品..." value="${InventoryView.searchQuery}" oninput="InventoryView.search(this.value)" class="w-full border p-3 rounded-lg bg-gray-50">
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-2">
                            ${ps.map(p => `
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100 flex justify-between">
                                    <div><div class="font-bold">${p.name}</div><div class="text-xs text-slate-400 font-mono">${p.barcode}</div></div>
                                    <div class="text-right"><div class="text-primary font-bold">${Utils.formatCurrency(p.retailPrice)}</div><button onclick="Store.deleteProduct('${p.barcode}');router.refresh()" class="text-red-400 text-xs mt-1">删除</button></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            search: (v) => { InventoryView.searchQuery = v; router.refresh(); },
            exp: () => { const ws=XLSX.utils.json_to_sheet(Store.data.products); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "P"); XLSX.writeFile(wb, "Inv.xlsx"); }
        };

        // View: Analytics (报表)
        const AnalyticsView = { render: () => {
            document.getElementById('header-actions').innerHTML = '';
            const tx = Store.data.transactions;
            const tot = tx.reduce((s,t)=>s+t.totalAmount,0);
            return `
                <div class="h-full overflow-y-auto p-4 space-y-4">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white p-6 rounded-2xl shadow-lg">
                        <div class="text-blue-100 text-sm mb-1">总销售额</div><div class="text-3xl font-bold">${Utils.formatCurrency(tot)}</div>
                    </div>
                    <h3 class="font-bold text-slate-700 mt-4">交易记录</h3>
                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                        ${tx.slice().reverse().map(t => `<div class="p-4 border-b flex justify-between"><div><div class="text-xs text-slate-400">${new Date(t.date).toLocaleString()}</div><div class="text-sm mt-1">${t.items.length}件商品</div></div><div class="font-bold text-primary">+${Utils.formatCurrency(t.totalAmount)}</div></div>`).join('')}
                    </div>
                </div>
            `;
        }};

        // Router & Global UI
        const router = {
            current: 'cashier',
            routes: { 'entry': EntryView, 'inventory': InventoryView, 'cashier': CashierView, 'analytics': AnalyticsView },
            navigate: (v) => { 
                Scanner.stop(); router.current = v; 
                document.querySelectorAll('.nav-btn').forEach(b => { 
                    const t = b.dataset.target; 
                    b.classList.toggle('text-primary', t===v); 
                    b.classList.toggle('text-slate-500', t!==v); 
                });
                router.refresh(); 
            },
            refresh: () => { 
                document.getElementById('app').innerHTML = router.routes[router.current].render(); 
                lucide.createIcons(); 
            }
        };
        const Modal = { 
            el: document.getElementById('modal-overlay'), c: document.getElementById('modal-content'),
            show: (h) => { Modal.c.innerHTML=h; Modal.el.classList.remove('hidden'); setTimeout(()=>Modal.c.classList.remove('translate-y-full'),10); },
            hide: () => { Modal.c.classList.add('translate-y-full'); setTimeout(()=>Modal.el.classList.add('hidden'),300); }
        };
        const Toast = { show: (m, t='s') => { const d=document.createElement('div'); d.className=`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full shadow-xl text-white text-sm font-bold z-50 transition-all duration-300 transform translate-y-[-20px] opacity-0 ${t==='error'?'bg-red-500':'bg-slate-800'}`; d.textContent=m; document.body.appendChild(d); requestAnimationFrame(()=>d.classList.remove('translate-y-[-20px]','opacity-0')); setTimeout(()=>{d.classList.add('opacity-0');setTimeout(()=>d.remove(),300)},2000); } };

        window.addEventListener('DOMContentLoaded', () => { Store.init(); router.navigate('cashier'); });
    </script>
</body>
</html>
