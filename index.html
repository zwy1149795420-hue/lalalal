<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>极简收银 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* 隐藏滚动条但保持滚动功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 防止iOS点击高亮 */
        * { -webkit-tap-highlight-color: transparent; }
        body { background-color: #f3f4f6; }
        /* 扫码区域样式 */
        #reader video { object-fit: cover; border-radius: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="app" class="flex flex-col h-full">
        
        <header class="bg-white shadow-sm z-50 shrink-0">
            <div class="flex justify-between items-center px-2 py-2">
                <nav class="flex w-full space-x-1 bg-gray-100 p-1 rounded-lg">
                    <button v-for="tab in tabs" :key="tab.id" 
                        @click="switchTab(tab.id)"
                        :class="['flex-1 py-2 text-sm font-bold rounded-md transition-all duration-200', 
                                 currentTab === tab.id ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-200']">
                        {{ tab.name }}
                    </button>
                </nav>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto relative no-scrollbar bg-gray-50">
            
            <div v-if="currentTab === 'entry'" class="p-4 space-y-4 h-full flex flex-col">
                <div id="reader-container" class="bg-black rounded-xl overflow-hidden shadow-lg border-2 border-gray-300 relative h-64 shrink-0">
                    <div id="reader" class="w-full h-full"></div>
                    <div v-if="!cameraActive" class="absolute inset-0 flex items-center justify-center text-white/50">
                        <span class="text-sm">摄像头已关闭</span>
                    </div>
                </div>
                
                <div class="flex-1 flex flex-col justify-center items-center text-gray-400 space-y-2">
                    <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 16h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                    <p>扫描条码或使用扫码枪录入</p>
                    <button @click="openManualEntry" class="mt-4 px-6 py-2 bg-gray-200 text-gray-700 rounded-full text-sm font-medium active:scale-95 transition-transform">
                        手动输入条码
                    </button>
                </div>
            </div>

            <div v-if="currentTab === 'manage'" class="p-4 space-y-4 h-full flex flex-col">
                <div class="flex justify-between items-center space-x-2">
                    <input v-model="searchQuery" type="text" placeholder="搜索商品名/条码..." class="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <div class="flex space-x-1">
                        <button @click="exportExcel" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs shadow hover:bg-green-700">导出</button>
                        <label class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs shadow hover:bg-blue-700 cursor-pointer">
                            导入
                            <input type="file" @change="importExcel" accept=".xlsx,.xls" class="hidden">
                        </label>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-sm">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 sticky top-0">
                            <tr>
                                <th class="px-3 py-2">商品</th>
                                <th class="px-3 py-2">价格(批/零)</th>
                                <th class="px-3 py-2 text-center">状态</th>
                                <th class="px-3 py-2 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="p in filteredProducts" :key="p.id" :class="{'opacity-50': p.status === 'inactive'}">
                                <td class="px-3 py-2">
                                    <div class="font-bold text-gray-800">{{ p.name }}</div>
                                    <div class="text-xs text-gray-400">{{ p.barcode }}</div>
                                </td>
                                <td class="px-3 py-2">
                                    <div class="text-blue-600">¥{{ p.wholesale_price }}</div>
                                    <div class="text-green-600">¥{{ p.retail_price }}</div>
                                </td>
                                <td class="px-3 py-2 text-center">
                                    <button @click="toggleStatus(p)" class="text-xs px-2 py-1 rounded-full" 
                                        :class="p.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                        {{ p.status === 'active' ? '启用' : '停用' }}
                                    </button>
                                </td>
                                <td class="px-3 py-2 text-center">
                                    <button @click="editProduct(p)" class="text-blue-600 font-medium">编辑</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="currentTab === 'cashier'" class="h-full flex flex-col">
                <div class="bg-white p-3 shadow-sm z-10 shrink-0 space-y-3">
                    <div class="flex rounded-lg bg-gray-100 p-1">
                        <button @click="priceMode = 'wholesale'" :class="['flex-1 py-1.5 text-sm font-bold rounded-md transition-colors', priceMode === 'wholesale' ? 'bg-purple-600 text-white shadow' : 'text-gray-500']">批发价</button>
                        <button @click="priceMode = 'retail'" :class="['flex-1 py-1.5 text-sm font-bold rounded-md transition-colors', priceMode === 'retail' ? 'bg-green-600 text-white shadow' : 'text-gray-500']">零售价</button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="relative flex-1">
                            <input v-model="cashierInput" @keyup.enter="handleCashierSearch" type="text" placeholder="扫码或输入名称..." class="w-full bg-gray-100 border-none rounded-lg py-2 pl-3 pr-10 text-sm focus:ring-2 focus:ring-blue-500">
                            <button @click="toggleScanner" class="absolute right-2 top-1.5 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 16h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div v-show="showCashierScanner" class="bg-black relative h-48 shrink-0 transition-all duration-300">
                    <div id="cashier-reader" class="w-full h-full"></div>
                    <button @click="toggleScanner" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto bg-gray-50 p-2 space-y-2">
                    <div v-for="(item, index) in cart" :key="index" class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-bold text-gray-800 text-lg">{{ item.name }}</div>
                            <div class="text-xs text-gray-400">{{ item.barcode }}</div>
                            <div class="mt-1 flex items-center space-x-2">
                                <span class="text-xs text-gray-500">单价:</span>
                                <input type="number" v-model.number="item.unit_price" class="w-20 bg-gray-50 border border-gray-200 rounded px-1 py-0.5 text-sm font-bold text-blue-600 focus:bg-white focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <div class="flex items-center bg-gray-100 rounded-lg p-1">
                                <button @click="updateQty(index, -1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow text-gray-600 font-bold active:bg-gray-200">-</button>
                                <span class="w-10 text-center font-bold text-gray-800">{{ item.quantity }}</span>
                                <button @click="updateQty(index, 1)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow text-blue-600 font-bold active:bg-gray-200">+</button>
                            </div>
                            <div class="font-mono font-bold text-lg">¥{{ (item.unit_price * item.quantity).toFixed(2) }}</div>
                        </div>
                    </div>
                    
                    <div v-if="cart.length === 0" class="h-64 flex flex-col items-center justify-center text-gray-400">
                        <svg class="w-16 h-16 mb-2 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <p>暂无商品</p>
                    </div>
                </div>

                <div class="bg-white border-t border-gray-200 p-4 pb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <div class="flex justify-between items-end mb-3">
                        <div class="text-sm text-gray-500">共 {{ cartTotalQty }} 件</div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">合计</div>
                            <div class="text-3xl font-bold text-gray-900 font-mono">¥{{ cartTotalAmount.toFixed(2) }}</div>
                        </div>
                    </div>
                    <div class="flex space-x-3 h-12">
                        <button @click="clearCart" class="w-1/4 bg-red-100 text-red-600 rounded-xl font-bold text-sm hover:bg-red-200 active:scale-95 transition-transform">清空</button>
                        <button @click="openCheckout" :disabled="cart.length === 0" class="flex-1 bg-blue-600 disabled:bg-gray-300 text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-transform">
                            收款
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'orders'" class="p-4 h-full flex flex-col bg-gray-50">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 shrink-0">
                    <h2 class="text-gray-500 text-xs font-bold uppercase tracking-wide">今日概览</h2>
                    <div class="flex justify-between mt-2">
                        <div>
                            <div class="text-2xl font-bold text-gray-800">{{ todayStats.count }}</div>
                            <div class="text-xs text-gray-400">订单数</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-green-600">¥{{ todayStats.amount.toFixed(2) }}</div>
                            <div class="text-xs text-gray-400">销售额</div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto space-y-3">
                    <div v-for="order in orders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="text-xs text-gray-400">{{ formatDate(order.created_at) }}</div>
                                <div class="text-xs mt-0.5 px-2 py-0.5 rounded bg-gray-100 inline-block">{{ order.payment_method }}</div>
                            </div>
                            <div class="text-right">
                                <div :class="order.status === 'void' ? 'text-gray-400 line-through' : 'text-gray-800 font-bold'">¥{{ order.total_price }}</div>
                                <div v-if="order.status === 'void'" class="text-xs text-red-500 font-bold">已作废</div>
                            </div>
                        </div>
                        <div class="border-t border-gray-50 my-2"></div>
                        <button v-if="order.status !== 'void'" @click="voidOrder(order)" class="w-full py-2 text-xs text-red-500 font-bold bg-red-50 rounded-lg hover:bg-red-100">
                            作废订单
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <div v-if="showEntryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-gray-800">{{ isEditing ? '编辑商品' : '新商品录入' }}</h3>
                    <button @click="closeEntryModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1">条形码</label>
                        <input v-model="entryForm.barcode" type="text" class="w-full bg-gray-100 text-gray-500 p-3 rounded-lg font-mono text-sm" readonly>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">商品名称</label>
                        <input v-model="entryForm.name" ref="nameInput" type="text" placeholder="未命名 (自动生成)" class="w-full bg-white border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg font-bold">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-purple-600 mb-1">批发价</label>
                            <input v-model="entryForm.wholesale_price" type="number" step="0.01" class="w-full bg-white border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none font-mono font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-green-600 mb-1">零售价</label>
                            <input v-model="entryForm.retail_price" type="number" step="0.01" class="w-full bg-white border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none font-mono font-bold">
                        </div>
                    </div>
                    <button @click="saveEntry" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-95 transition-transform">
                        保存商品
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showCheckoutModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden p-6 space-y-6 animate-slide-up">
                <div class="text-center">
                    <div class="text-gray-500 text-sm mb-1">应收金额</div>
                    <div class="text-5xl font-bold text-gray-900 font-mono">¥{{ cartTotalAmount.toFixed(2) }}</div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button v-for="method in ['微信支付', '支付宝', '现金', '其他']" :key="method" 
                        @click="confirmCheckout(method)"
                        class="h-16 rounded-xl font-bold text-lg border-2 transition-all active:scale-95 flex items-center justify-center"
                        :class="method === '现金' ? 'border-green-500 text-green-600 bg-green-50' : 'border-blue-100 text-blue-600 bg-blue-50 hover:border-blue-300'">
                        {{ method }}
                    </button>
                </div>
                <button @click="showCheckoutModal = false" class="w-full py-4 text-gray-400 font-bold">取消</button>
            </div>
        </div>
        
        <input type="text" id="global-gun-input" class="absolute -z-50 opacity-0 h-0 w-0" />

    </div>

<script>
const { createClient } = supabase;
const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co';
/* 在这里填写 Supabase Key */
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';

const app = Vue.createApp({
    data() {
        return {
            db: null,
            tabs: [
                { id: 'entry', name: '商品录入' },
                { id: 'manage', name: '商品管理' },
                { id: 'cashier', name: '收银台' },
                { id: 'orders', name: '订单管理' }
            ],
            currentTab: 'entry',
            
            // 数据缓存
            products: [],
            orders: [],
            
            // 扫码相关
            html5QrcodeScanner: null,
            cameraActive: false,
            scanLock: false,
            gunBuffer: '',
            gunTimeout: null,
            showCashierScanner: false,
            
            // 录入表单
            showEntryModal: false,
            isEditing: false,
            entryForm: { id: null, barcode: '', name: '', wholesale_price: '', retail_price: '' },
            
            // 管理相关
            searchQuery: '',
            
            // 收银相关
            priceMode: 'retail', // 'wholesale' | 'retail'
            cart: [],
            cashierInput: '',
            showCheckoutModal: false,
        }
    },
    computed: {
        filteredProducts() {
            if (!this.searchQuery) return this.products;
            const q = this.searchQuery.toLowerCase();
            return this.products.filter(p => 
                (p.name && p.name.toLowerCase().includes(q)) || 
                p.barcode.includes(q)
            );
        },
        cartTotalQty() {
            return this.cart.reduce((sum, item) => sum + item.quantity, 0);
        },
        cartTotalAmount() {
            return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        },
        todayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = this.orders.filter(o => 
                o.created_at.startsWith(today) && o.status !== 'void'
            );
            return {
                count: todayOrders.length,
                amount: todayOrders.reduce((sum, o) => sum + o.total_price, 0)
            };
        }
    },
    async mounted() {
        this.db = createClient(SUPABASE_URL, SUPABASE_KEY);
        await this.fetchProducts();
        await this.fetchOrders();
        
        // 全局监听键盘事件（兼容扫码枪）
        window.addEventListener('keydown', this.handleGlobalKeydown);
        
        // 初始启动扫码
        this.$nextTick(() => {
            if (this.currentTab === 'entry') this.startScanner('reader');
        });
    },
    methods: {
        // --- 核心逻辑 ---
        async switchTab(tabId) {
            // 切换前停止摄像头
            await this.stopScanner();
            this.currentTab = tabId;
            this.showCashierScanner = false;
            
            this.$nextTick(async () => {
                if (tabId === 'entry') {
                    await this.startScanner('reader');
                }
            });
        },

        // --- 扫码引擎 ---
        async startScanner(elementId) {
            if (this.cameraActive) return;
            try {
                // 确保DOM已渲染
                await new Promise(r => setTimeout(r, 100));
                
                this.html5QrcodeScanner = new Html5Qrcode(elementId);
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0 };
                
                await this.html5QrcodeScanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    this.onScanSuccess
                );
                this.cameraActive = true;
            } catch (err) {
                console.error("Camera error", err);
                this.cameraActive = false;
            }
        },
        async stopScanner() {
            if (this.html5QrcodeScanner && this.cameraActive) {
                try {
                    await this.html5QrcodeScanner.stop();
                    this.html5QrcodeScanner.clear();
                } catch(e) {}
                this.cameraActive = false;
                this.html5QrcodeScanner = null;
            }
        },
        onScanSuccess(decodedText) {
            if (this.scanLock) return;
            this.scanLock = true;
            
            // 播放提示音
            this.playBeep();
            
            // 逻辑分发
            if (this.currentTab === 'entry') {
                this.handleEntryScan(decodedText);
            } else if (this.currentTab === 'cashier') {
                this.addToCart(decodedText);
                setTimeout(() => { this.scanLock = false; }, 800); // 收银连扫间隔稍长防止误触
                return;
            }
            
            // 默认锁定500ms
            setTimeout(() => { this.scanLock = false; }, 500);
        },
        playBeep() {
            // 简单的Web Audio API beep
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 1500;
            gain.gain.value = 0.1;
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        },
        
        // --- 扫码枪兼容 ---
        handleGlobalKeydown(e) {
            // 忽略输入框内的输入
            if (e.target.tagName === 'INPUT') return;
            
            if (e.key === 'Enter') {
                if (this.gunBuffer.length > 3) { // 至少4位才视为条码
                    this.onScanSuccess(this.gunBuffer);
                }
                this.gunBuffer = '';
            } else {
                // 仅累加数字和字母
                if (e.key.length === 1) this.gunBuffer += e.key;
            }
            
            // 50ms超时重置，区分人工输入和扫码枪
            clearTimeout(this.gunTimeout);
            this.gunTimeout = setTimeout(() => { this.gunBuffer = ''; }, 100);
        },

        // --- 商品录入逻辑 ---
        async handleEntryScan(barcode) {
            const existing = this.products.find(p => p.barcode === barcode);
            this.entryForm = {
                id: existing ? existing.id : null,
                barcode: barcode,
                name: existing ? existing.name : '',
                wholesale_price: existing ? existing.wholesale_price : '',
                retail_price: existing ? existing.retail_price : ''
            };
            this.isEditing = !!existing;
            this.showEntryModal = true;
            await this.stopScanner(); // 暂停扫描防止背景继续触发
        },
        openManualEntry() {
             this.entryForm = { barcode: '', name: '', wholesale_price: '', retail_price: '' };
             // 生成临时随机条码用于手动录入测试
             const tempCode = 'MANUAL' + Date.now().toString().slice(-6);
             this.entryForm.barcode = tempCode;
             this.isEditing = false;
             this.showEntryModal = true;
             this.stopScanner();
        },
        closeEntryModal() {
            this.showEntryModal = false;
            // 重新开启扫描
            if (this.currentTab === 'entry') this.startScanner('reader');
        },
        async saveEntry() {
            if (!this.entryForm.barcode) return;
            
            // 自动生成未命名逻辑
            let finalName = this.entryForm.name.trim();
            if (!finalName) {
                const untitledCount = this.products.filter(p => p.name.startsWith('未命名')).length;
                finalName = untitledCount === 0 ? '未命名' : `未命名${untitledCount}`;
            }

            const payload = {
                barcode: this.entryForm.barcode,
                name: finalName,
                wholesale_price: parseFloat(this.entryForm.wholesale_price) || 0,
                retail_price: parseFloat(this.entryForm.retail_price) || 0,
                status: 'active'
            };

            const { error } = await this.db.from('products').upsert(
                this.isEditing ? { ...payload, id: this.entryForm.id } : payload
            );

            if (!error) {
                await this.fetchProducts();
                this.closeEntryModal();
            } else {
                alert('保存失败: ' + error.message);
            }
        },

        // --- 商品管理逻辑 ---
        async fetchProducts() {
            const { data } = await this.db.from('products').select('*').order('created_at', { ascending: false });
            if (data) this.products = data;
        },
        async toggleStatus(product) {
            const newStatus = product.status === 'active' ? 'inactive' : 'active';
            const { error } = await this.db.from('products').update({ status: newStatus }).eq('id', product.id);
            if (!error) product.status = newStatus;
        },
        editProduct(product) {
            this.entryForm = { ...product };
            this.isEditing = true;
            this.showEntryModal = true;
        },
        exportExcel() {
            const ws = XLSX.utils.json_to_sheet(this.products);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Products");
            XLSX.writeFile(wb, "products_backup.xlsx");
        },
        importExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                // 简单的批量导入逻辑
                json.forEach(async row => {
                    if(row.barcode) {
                        await this.db.from('products').upsert({
                            barcode: String(row.barcode),
                            name: row.name || '未命名(导入)',
                            wholesale_price: row.wholesale_price || 0,
                            retail_price: row.retail_price || 0
                        });
                    }
                });
                setTimeout(this.fetchProducts, 1000); // 延迟刷新
            };
            reader.readAsArrayBuffer(file);
        },

        // --- 收银逻辑 ---
        toggleScanner() {
            this.showCashierScanner = !this.showCashierScanner;
            this.$nextTick(() => {
                if (this.showCashierScanner) this.startScanner('cashier-reader');
                else this.stopScanner();
            });
        },
        handleCashierSearch() {
            if (!this.cashierInput) return;
            this.addToCart(this.cashierInput);
            this.cashierInput = '';
        },
        addToCart(query) {
            // 查找逻辑: 全匹配条码 OR 名称包含
            const target = this.products.find(p => p.barcode === query) || 
                           this.products.find(p => p.name === query);
            
            if (target) {
                if (target.status !== 'active') {
                    alert('该商品已停用');
                    return;
                }
                const existing = this.cart.find(item => item.id === target.id);
                if (existing) {
                    existing.quantity++;
                } else {
                    this.cart.unshift({
                        id: target.id,
                        name: target.name,
                        barcode: target.barcode,
                        unit_price: this.priceMode === 'wholesale' ? target.wholesale_price : target.retail_price,
                        quantity: 1
                    });
                }
            } else {
                // 如果找不到，可选择手动创建临时商品? 暂时仅提示
                // alert('未找到商品'); // 取消弹窗干扰，仅不做动作
            }
        },
        updateQty(index, delta) {
            const item = this.cart[index];
            item.quantity += delta;
            if (item.quantity <= 0) this.cart.splice(index, 1);
        },
        clearCart() {
            if (confirm('确定清空购物车？')) this.cart = [];
        },
        openCheckout() {
            this.showCheckoutModal = true;
        },
        async confirmCheckout(method) {
            // 1. 创建 Order
            const { data: orderData, error: orderError } = await this.db.from('orders').insert({
                total_price: this.cartTotalAmount,
                total_quantity: this.cartTotalQty,
                price_type: this.priceMode,
                payment_method: method,
                status: 'completed'
            }).select().single();

            if (orderError) {
                alert('订单创建失败');
                return;
            }

            // 2. 创建 Items
            const itemsPayload = this.cart.map(item => ({
                order_id: orderData.id,
                product_id: item.id,
                product_name: item.name,
                barcode: item.barcode,
                unit_price: item.unit_price,
                quantity: item.quantity,
                subtotal: item.unit_price * item.quantity
            }));

            await this.db.from('order_items').insert(itemsPayload);

            // 3. 收尾
            this.cart = [];
            this.showCheckoutModal = false;
            this.fetchOrders();
        },

        // --- 订单管理 ---
        async fetchOrders() {
            const { data } = await this.db.from('orders').select('*').order('created_at', { ascending: false }).limit(50);
            if (data) this.orders = data;
        },
        async voidOrder(order) {
            if (confirm('确定作废此订单？此操作不可逆。')) {
                await this.db.from('orders').update({ status: 'void' }).eq('id', order.id);
                order.status = 'void';
            }
        },
        formatDate(isoStr) {
            const d = new Date(isoStr);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        }
    }
});
app.mount('#app');
</script>
<style>
    /* 动画定义 */
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 0.3s ease-out; }
    .animate-slide-up { animation: slide-up 0.3s ease-out; }
</style>
</body>
</html>

