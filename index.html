<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>æç®€æ”¶é“¶ Pro (UIä¼˜åŒ–ç‰ˆ)</title>

    <!-- ä¾èµ– -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* å…¨å±€ */
        body { margin: 0; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #0f172a; }
        [v-cloak] { display: none; }

        /* æ‘„åƒå¤´åŸºç¡€æ ·å¼ï¼ˆæµ®å±‚æˆ–å ä½ï¼‰ */
        .scan-base { width: 100%; background-color: #000; border-radius: 16px; overflow: hidden; position: relative; }
        #reader video, #manage-reader video, #cashier-reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; border-radius: 16px; }

        /* éšè—æ»šåŠ¨æ¡ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* äº¤äº’ */
        .btn-press:active { transform: scale(0.98); opacity: 0.95; transition: transform 0.08s; }
        input:focus, select:focus { outline: none; box-shadow: 0 0 0 4px rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2); }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-blur { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { position: relative; transition: all 0.25s ease; }
        .nav-item.active { color: #2563eb; }
        .nav-item.active::after { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: #2563eb; border-radius: 0 0 4px 4px; }

        /* æ¨¡æ€æ¡† */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-panel { width: 92%; max-width: 420px; background: white; border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(2,6,23,0.2); }

        /* cashier camera æµ®å±‚ï¼ˆå°ï¼‰ */
        .cashier-camera-float { position: absolute; top: 8px; left: 8px; right: 8px; height: 160px; border-radius: 12px; overflow: hidden; z-index: 10; box-shadow: 0 6px 18px rgba(2,6,23,0.12); }
        .cashier-camera-small { height: 100%; width: 100%; }

        @media (min-width: 768px) {
            .desktop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen w-full flex flex-col md:flex-row bg-slate-50 overflow-hidden text-slate-800">

    <!-- ä¾§æ ï¼ˆæ¡Œé¢å¯è§ï¼‰ -->
    <aside class="hidden md:flex w-64 bg-slate-900 text-white flex-col shrink-0">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold flex items-center gap-2"><i class="ph-storefront text-blue-400"></i> æ”¶é“¶ç³»ç»Ÿ Pro</h1>
            <div class="flex items-center gap-2 mt-2 text-xs text-slate-400">
                <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                <span>{{ isOnline ? 'åœ£ä¿ç½—å·²è¿æ¥' : 'ç¦»çº¿æ¨¡å¼' }}</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a @click="switchTab('cashier')" :class="currentTab==='cashier' ? 'bg-blue-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer font-bold transition-all"><i class="ph-barcode text-xl"></i> æ”¶é“¶å°</a>
            <a @click="switchTab('entry')" :class="currentTab==='entry' ? 'bg-blue-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer font-bold transition-all"><i class="ph-plus-circle text-xl"></i> å•†å“å½•å…¥</a>
            <a @click="switchTab('manage')" :class="currentTab==='manage' ? 'bg-blue-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer font-bold transition-all"><i class="ph-package text-xl"></i> å•†å“ç®¡ç†</a>
            <a @click="switchTab('orders')" :class="currentTab==='orders' ? 'bg-blue-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer font-bold transition-all"><i class="ph-chart-bar text-xl"></i> é”€å”®æŠ¥è¡¨</a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        <header class="md:hidden h-14 bg-white px-4 shadow-sm shrink-0 flex justify-between items-center z-20">
            <h1 class="font-bold text-lg text-slate-800">{{ currentTitle }}</h1>
            <div class="flex items-center gap-2">
                <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full animate-pulse"></div>
                <span class="text-xs text-slate-400 font-mono">{{ isOnline ? 'ONLINE' : 'OFFLINE' }}</span>
            </div>
        </header>

        <div ref="mainContent" class="flex-1 overflow-y-auto hide-scrollbar p-3 md:p-8 bg-slate-50/50 pb-28 md:pb-8">

            <!-- æ”¶é“¶ Tab -->
            <div v-if="currentTab === 'cashier'" class="h-full flex flex-col md:flex-row gap-4 relative">
                <!-- æ‘„åƒå¤´æµ®å±‚ï¼ˆä¸ä¼šéšè—æ¸…å•ï¼‰ -->
                <div v-show="scanning && scanTab==='cashier'" class="cashier-camera-float md:hidden">
                    <div id="cashier-reader" class="cashier-camera-small"></div>
                    <button @click="stopScanner" class="absolute bottom-3 left-1/2 -translate-x-1/2 bg-white/90 text-slate-800 px-3 py-1 rounded-full text-sm font-bold border border-slate-200">å…³é—­æ‘„åƒå¤´</button>
                </div>

                <!-- å·¦ä¾§ï¼šæœç´¢/æ‰«ç è¾“å…¥ï¼ˆåœ¨æ¡Œé¢æ—¶æ˜¾ç¤ºæ‘„åƒå¤´æ—è¾¹ï¼‰ -->
                <div class="w-full md:w-[350px] shrink-0 flex flex-col gap-3 relative">
                    <!-- åœ¨æ¡Œé¢ä¸Šï¼Œæ˜¾ç¤ºå›ºå®šæ‘„åƒå¤´å®¹å™¨ï¼ˆä¸é®æŒ¡ï¼‰ -->
                    <div v-show="scanning && scanTab==='cashier' && !isMobile" class="scan-base h-[260px] md:h-[260px] shadow-inner border border-slate-200 relative bg-black rounded-2xl overflow-hidden">
                        <div id="cashier-reader-desktop" class="w-full h-full"></div>
                        <button @click="stopScanner" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/20 backdrop-blur text-white px-4 py-2 rounded-full text-sm font-bold border border-white/30">å…³é—­æ‘„åƒå¤´</button>
                    </div>

                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
                        <div class="relative">
                            <input ref="cashierInput" v-model="cashierSearch" @keyup.enter="addToCartByInput" @focus="scrollToInput($event)" type="text" placeholder="æ‰«ç æªç›´æ¥æ‰« / è¾“å…¥åç§°" class="w-full p-4 pl-12 bg-slate-50 rounded-xl font-bold text-lg border border-transparent focus:bg-white focus:border-blue-200 transition-all">
                            <i class="ph-barcode absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                            <button @click="toggleScanner('cashier')" :class="scanning && scanTab==='cashier' ? 'text-blue-600 bg-blue-50' : 'text-slate-500 bg-slate-100'" class="absolute right-2 top-2 p-2 rounded-lg transition-colors btn-press">
                                <i class="ph-qr-code text-xl"></i>
                            </button>
                        </div>
                    </div>

                </div>

                <!-- å³ä¾§ï¼šå½“å‰æ¸…å•ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
                <div class="flex-1 flex flex-col h-full overflow-hidden gap-3">
                    <div class="grid grid-cols-2 gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 shrink-0">
                        <button @click="switchPriceMode('retail')" :class="priceMode === 'retail' ? 'bg-blue-600 text-white shadow' : 'text-slate-500 hover:bg-slate-50'" class="py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2">
                            <i class="ph-tag"></i> é›¶å”®æ¨¡å¼
                        </button>
                        <button @click="switchPriceMode('wholesale')" :class="priceMode === 'wholesale' ? 'bg-orange-500 text-white shadow' : 'text-slate-500 hover:bg-slate-50'" class="py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2">
                            <i class="ph-package"></i> æ‰¹å‘æ¨¡å¼
                        </button>
                    </div>

                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 shrink-0">
                        <div class="relative">
                            <input v-model="cashierSearch" @keyup.enter="addToCartByInput" @focus="scrollToInput($event)" type="text" placeholder="æ‰«ç æªç›´æ¥æ‰« / è¾“å…¥åç§°" class="w-full p-4 pl-12 bg-slate-50 rounded-xl font-bold text-lg border border-transparent focus:bg-white focus:border-blue-200 transition-all">
                            <i class="ph-barcode absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-0">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-4 rounded-full" :class="priceMode==='retail'?'bg-blue-500':'bg-orange-500'"></div>
                                <h3 class="font-bold text-slate-700">å½“å‰æ¸…å• ({{ cartTotalQty }})</h3>
                            </div>
                            <button @click="clearCart" class="text-red-500 text-sm font-bold hover:bg-red-50 px-2 py-1 rounded" v-if="cart.length > 0">æ¸…ç©º</button>
                        </div>

                        <div class="flex-1 overflow-y-auto p-3 space-y-2">
                            <div v-if="cart.length === 0" class="h-full flex flex-col items-center justify-center text-slate-300">
                                <i class="ph-shopping-cart text-6xl mb-4 text-slate-200"></i>
                                <p>å½“å‰æŒ‰ {{ priceMode==='retail'?'é›¶å”®ä»·':'æ‰¹å‘ä»·' }} ç»“ç®—</p>
                            </div>
                            <div v-for="(item, index) in cart" :key="index" class="flex flex-col p-3 bg-white border border-slate-100 rounded-xl shadow-sm hover:border-blue-200 transition-colors">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-slate-800 text-lg">{{ item.name }}</div>
                                        <div class="text-xs text-slate-400 font-mono">{{ item.barcode }}</div>
                                    </div>
                                    <button @click="removeFromCart(index)" class="text-slate-300 hover:text-red-500 p-1"><i class="ph-trash text-xl"></i></button>
                                </div>
                                <div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <button @click="item.quantity > 1 ? item.quantity-- : removeFromCart(index)" class="w-8 h-8 bg-white rounded border border-slate-200 text-slate-700 font-bold hover:bg-slate-100">-</button>
                                        <span class="w-8 text-center font-bold text-lg">{{ item.quantity }}</span>
                                        <button @click="item.quantity++" class="w-8 h-8 bg-blue-600 rounded text-white font-bold shadow-sm hover:bg-blue-700">+</button>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-[10px] text-slate-400 mb-0.5">å•ä»· ({{ priceMode==='retail'?'é›¶':'æ‰¹' }})</div>
                                        <input v-model.number="item.unit_price" @focus="scrollToInput($event)" type="number" class="w-20 text-right font-bold text-lg bg-transparent border-b border-transparent focus:border-blue-500 focus:bg-white rounded px-1 transition-all">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border-t border-slate-100 bg-slate-50 flex flex-col gap-3 shrink-0">
                            <div class="flex justify-between items-end">
                                <span class="text-slate-500 text-sm">åˆè®¡é‡‘é¢</span>
                                <div class="text-3xl font-black text-slate-900">R$ {{ cartTotalPrice }}</div>
                            </div>
                            <button @click="checkoutDirectly" :disabled="cart.length===0" class="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg disabled:opacity-50 btn-press transition-colors">
                                ç¡®è®¤æ”¶æ¬¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç† Tab -->
            <div v-if="currentTab === 'manage'" class="space-y-4 max-w-7xl mx-auto">
                <div class="flex gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-100 items-center">
                    <div class="relative flex-1">
                        <i class="ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input ref="manageInput" v-model="searchText" @focus="scrollToInput($event)" type="text" placeholder="æ‰«ç æªæœç´¢ / è¾“å…¥..." class="w-full pl-9 p-3 bg-slate-50 rounded-lg text-sm border-none focus:ring-2 focus:ring-blue-100 font-bold">
                    </div>
                    <button v-if="isMobile" @click="toggleScanner('manage')" :class="scanning && scanTab==='manage' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-600'" class="p-3 rounded-lg flex items-center gap-2 font-bold btn-press">
                        <i class="ph-qr-code text-xl"></i>
                        <span class="hidden md:inline">{{ scanning && scanTab==='manage' ? 'å…³é—­' : 'æ‰«ç ' }}</span>
                    </button>
                </div>

                <div v-if="isMobile && scanning && scanTab === 'manage'" class="scan-base h-[160px] shadow-inner mb-2">
                    <div id="manage-reader" class="w-full h-full"></div>
                </div>

                <div class="flex gap-2 items-center">
                    <select v-model="productFilterStatus" class="flex-1 min-w-0 p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-100 shadow-sm">
                        <option value="all">ğŸŸ¢ âšª å…¨éƒ¨çŠ¶æ€</option>
                        <option value="active">ğŸŸ¢ æ­£å¸¸é”€å”®</option>
                        <option value="disabled">âšª å·²æš‚åœ</option>
                    </select>
                    <select v-model="productFilterCategory" class="flex-1 min-w-0 p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-100 shadow-sm">
                        <option value="all">ğŸ“ å…¨éƒ¨åˆ†ç±»</option>
                        <option v-for="cat in allCategories" :key="cat" :value="cat">{{ cat }}</option>
                    </select>
                    <button @click="exportExcel" class="w-12 h-11 flex items-center justify-center bg-green-50 text-green-600 rounded-xl border border-green-100 shadow-sm btn-press"><i class="ph-file-xls text-xl"></i></button>
                    <label class="w-12 h-11 flex items-center justify-center bg-blue-50 text-blue-600 rounded-xl border border-blue-100 shadow-sm cursor-pointer btn-press"><i class="ph-upload-simple text-xl"></i><input type="file" @change="importExcel" class="hidden" accept=".xlsx,.xls"></label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <div v-for="p in filteredProducts" :key="p.id" @click="editProduct(p)" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:scale-98 transition-transform cursor-pointer relative overflow-hidden hover:border-blue-300 group">
                        <div v-if="p.status==='disabled'" class="absolute right-0 top-0 bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded-bl-lg font-bold">å·²æš‚åœ</div>
                        <div v-else class="absolute right-0 top-0 bg-blue-50 text-blue-600 text-[10px] px-2 py-1 rounded-bl-lg font-bold">{{ p.category || 'é»˜è®¤' }}</div>
                        <h3 :class="p.status==='disabled' ? 'text-slate-400' : 'text-slate-800'" class="font-bold truncate mb-1 text-lg">{{ p.name }}</h3>
                        <p class="text-xs text-slate-400 font-mono mb-3">{{ p.barcode }}</p>
                        <div class="flex justify-between items-end border-t border-slate-50 pt-2 text-sm">
                            <div class="text-slate-500">æ‰¹: <span class="font-bold">{{ p.wholesale_price }}</span></div>
                            <div class="text-blue-600">é›¶: <span class="font-bold text-lg">{{ p.retail_price }}</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å½•å…¥ Tab -->
            <div v-if="currentTab === 'entry'" class="flex flex-col max-w-7xl mx-auto gap-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 items-start">
                    <!-- æ–°å¢å•†å“ï¼ˆå·¦ï¼‰ -->
                    <div class="bg-white p-5 lg:p-6 rounded-2xl shadow-sm border border-slate-100 min-h-[300px]">
                        <h2 class="text-lg font-bold mb-5 flex items-center gap-2 text-slate-800 shrink-0">
                            <div class="bg-blue-100 p-1.5 rounded-lg text-blue-600"><i class="ph-plus-circle text-xl"></i></div>
                            æ–°å¢å•†å“
                        </h2>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-1.5">æ¡å½¢ç </label>
                                <div class="relative">
                                    <input ref="barcodeInput" v-model="entryForm.barcode" @keyup.enter="handleBarcodeEnter" type="text" class="w-full pl-10 p-3 bg-slate-50 rounded-xl font-mono text-lg font-bold border border-transparent focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all" placeholder="æ‰«ç æªç›´æ¥æ‰«">
                                    <i class="ph-barcode absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-1.5">å•†å“åç§°</label>
                                <input v-model="entryForm.name" type="text" class="w-full p-3 bg-slate-50 rounded-xl border border-transparent focus:bg-white focus:border-blue-500 transition-all" placeholder="è‡ªåŠ¨ç”Ÿæˆ: æœªå‘½åX">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-1.5">åˆ†ç±»</label>
                                <input list="category-list" v-model="entryForm.category" type="text" class="w-full p-3 bg-slate-50 rounded-xl border border-transparent focus:bg-white focus:border-blue-500 font-bold transition-all" placeholder="ä¾‹å¦‚: é¥®æ–™">
                                <datalist id="category-list"><option v-for="cat in allCategories" :value="cat"></option></datalist>
                            </div>

                            <!-- æ”¹ä¸ºä¸¤è¡Œæ˜¾ç¤ºï¼šæ‰¹å‘ä»· å’Œ é›¶å”®ä»· å„å ä¸€è¡Œï¼ˆå¢åŠ æ¨¡å—é«˜åº¦ï¼‰ -->
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-1.5">æ‰¹å‘ä»·</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">R$</span>
                                        <input v-model="entryForm.wholesale_price" type="number" class="w-full pl-8 p-3 bg-slate-50 rounded-xl font-bold border border-transparent focus:bg-white focus:border-blue-500 transition-all">
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs font-bold text-slate-400 block mb-1.5">é›¶å”®ä»·</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">R$</span>
                                        <input v-model="entryForm.retail_price" type="number" class="w-full pl-8 p-3 bg-slate-50 rounded-xl font-bold text-blue-600 border border-transparent focus:bg-white focus:border-blue-500 transition-all">
                                    </div>
                                </div>
                            </div>

                            <button @click="saveProduct" class="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg mt-2 btn-press flex items-center justify-center gap-2 transition-colors">
                                <i class="ph-check-circle text-xl"></i> ç¡®è®¤æ·»åŠ 
                            </button>
                        </div>
                    </div>

                    <!-- åˆšåˆšå½•å…¥ï¼ˆå³ï¼‰ å¯¹é½åˆ°å·¦ä¾§é«˜åº¦ -->
                    <div class="bg-white p-5 lg:p-6 rounded-2xl shadow-sm border border-slate-100 min-h-[300px] flex flex-col">
                        <h3 class="text-lg font-bold mb-5 flex items-center gap-2 text-slate-800 shrink-0">
                            <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600"><i class="ph-clock-counter-clockwise text-xl"></i></div>
                            åˆšåˆšå½•å…¥
                        </h3>

                        <div class="space-y-2 overflow-auto">
                            <div v-for="p in recentProducts" :key="p.id" class="p-3 border border-slate-100 rounded-xl flex justify-between items-center bg-slate-50 hover:bg-blue-50 transition-colors group">
                                <div>
                                    <div class="font-bold text-slate-800 text-base">{{ p.name }}</div>
                                    <div class="text-xs text-slate-400 font-mono mt-0.5 group-hover:text-blue-400">{{ p.barcode }}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-blue-600 font-bold">R$ {{ p.retail_price }}</div>
                                    <div class="text-[10px] text-slate-400">æ‰¹: {{ p.wholesale_price }}</div>
                                </div>
                            </div>

                            <div v-if="recentProducts.length === 0" class="py-10 flex flex-col items-center justify-center text-slate-300 gap-2">
                                <i class="ph-clipboard-text text-4xl opacity-20"></i>
                                <span class="text-sm">æš‚æ— æœ¬æ¬¡å½•å…¥è®°å½•</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ¥è¡¨ Tabï¼ˆä¿æŒåŸæ ·ï¼‰ -->
            <div v-if="currentTab === 'orders'" class="space-y-4 max-w-4xl mx-auto">
                <div class="bg-blue-600 p-6 rounded-2xl shadow-lg text-white">
                    <div class="text-blue-100 text-xs font-bold uppercase tracking-wider">ä»Šæ—¥é”€å”®é¢ (åœ£ä¿ç½—)</div>
                    <div class="text-4xl font-black mt-2">R$ {{ todaySales.toFixed(2) }}</div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-3 border-b border-slate-100 font-bold text-sm text-slate-700 bg-slate-50 flex items-center justify-between">
                        <span>ğŸ† é”€é‡æ’è¡Œ</span>
                        <div class="flex bg-slate-200 rounded-lg p-0.5">
                            <button @click="rankingRange = 'today'" :class="rankingRange==='today' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 text-xs rounded-md font-bold transition-all">ä»Šæ—¥</button>
                            <button @click="rankingRange = 'week'" :class="rankingRange==='week' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 text-xs rounded-md font-bold transition-all">æœ¬å‘¨</button>
                            <button @click="rankingRange = 'month'" :class="rankingRange==='month' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 text-xs rounded-md font-bold transition-all">æœ¬æœˆ</button>
                        </div>
                    </div>
                    <div class="max-h-[300px] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="text-xs text-slate-400 bg-slate-50 sticky top-0 z-10"><tr><th class="p-3 font-bold w-10">#</th><th class="p-3 font-bold">å•†å“åç§°</th><th class="p-3 font-bold text-right">é”€é‡</th></tr></thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr v-for="(stat, idx) in productSalesStats" :key="stat.barcode"><td class="p-3 text-xs text-slate-400 font-mono">{{ idx + 1 }}</td><td class="p-3 text-sm text-slate-700 font-bold"><div class="truncate max-w-[180px]">{{ stat.name }}</div></td><td class="p-3 text-sm text-slate-900 font-bold text-right">{{ stat.qty }}</td></tr>
                                <tr v-if="productSalesStats.length === 0"><td colspan="3" class="p-6 text-center text-xs text-slate-400">æš‚æ— æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-2 border-b border-slate-100 bg-slate-50 flex gap-1">
                        <button @click="orderFilterType = 'completed'" :class="orderFilterType === 'completed' ? 'bg-white text-blue-600 shadow' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">âœ… æ­£å¸¸è®¢å•</button>
                        <button @click="orderFilterType = 'void'" :class="orderFilterType === 'void' ? 'bg-white text-red-500 shadow' : 'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all">ğŸš« ä½œåºŸè®¢å•</button>
                    </div>
                    <div class="divide-y divide-slate-50 min-h-[200px]">
                        <div v-for="order in filteredOrdersList" :key="order.id" @click="viewOrderDetails(order)" class="p-4 hover:bg-blue-50 cursor-pointer transition-colors flex justify-between items-center group">
                            <div>
                                <div class="text-xs text-slate-400 mb-1 font-mono flex items-center gap-2">{{ formatDate(order.created_at) }}</div>
                                <div class="font-bold text-slate-800">R$ {{ order.total_price }}</div>
                                <div class="text-xs text-slate-500 mt-0.5">{{ order.total_quantity }} ä»¶ / {{ order.price_type==='retail'?'é›¶å”®':'æ‰¹å‘' }}</div>
                            </div>
                            <div class="text-right flex flex-col items-end gap-2">
                                <button v-if="order.status==='completed'" @click.stop="voidOrder(order)" class="text-xs text-red-400 border border-red-200 px-2 py-1 rounded hover:bg-red-50">ä½œåºŸ</button>
                                <div v-if="order.status==='void'" class="flex items-center gap-2">
                                    <span class="text-[10px] bg-slate-100 text-slate-400 px-2 py-1 rounded">å·²ä½œåºŸ</span>
                                    <button @click.stop="deleteOrder(order)" class="text-slate-400 hover:text-red-600 p-1"><i class="ph-trash text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                        <div v-if="filteredOrdersList.length === 0" class="p-8 text-center text-slate-400 text-xs">æš‚æ— {{ orderFilterType === 'completed' ? 'æ­£å¸¸' : 'ä½œåºŸ' }}è®¢å•</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- æ‰‹æœºåº•éƒ¨å¯¼èˆª -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 h-[80px] nav-blur flex justify-around items-center z-40 text-slate-400">
            <div @click="switchTab('cashier')" :class="{'active': currentTab==='cashier'}" class="nav-item flex flex-col items-center w-1/4 btn-press"><i class="ph-barcode text-2xl mb-1"></i><span class="text-[10px] font-bold">æ”¶é“¶</span></div>
            <div @click="switchTab('entry')" :class="{'active': currentTab==='entry'}" class="nav-item flex flex-col items-center w-1/4 btn-press"><i class="ph-plus-circle text-2xl mb-1"></i><span class="text-[10px] font-bold">å½•å…¥</span></div>
            <div @click="switchTab('manage')" :class="{'active': currentTab==='manage'}" class="nav-item flex flex-col items-center w-1/4 btn-press"><i class="ph-package text-2xl mb-1"></i><span class="text-[10px] font-bold">ç®¡ç†</span></div>
            <div @click="switchTab('orders')" :class="{'active': currentTab==='orders'}" class="nav-item flex flex-col items-center w-1/4 btn-press"><i class="ph-chart-bar text-2xl mb-1"></i><span class="text-[10px] font-bold">æŠ¥è¡¨</span></div>
        </nav>
    </main>

    <!-- ç¼–è¾‘å•†å“ Modal -->
    <div v-if="editingProduct" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in-up">
            <h3 class="font-bold text-lg mb-4 text-slate-800">ç¼–è¾‘å•†å“</h3>
            <div class="space-y-3">
                <div><label class="text-xs font-bold text-slate-400">æ¡ç </label><input v-model="editingProduct.barcode" @focus="scrollToInput($event)" class="w-full p-3 border border-slate-200 rounded-lg bg-yellow-50 font-mono text-slate-700"></div>
                <div><label class="text-xs font-bold text-slate-400">åç§°</label><input v-model="editingProduct.name" @focus="scrollToInput($event)" class="w-full p-3 border border-slate-200 rounded-lg"></div>
                <div><label class="text-xs font-bold text-slate-400">åˆ†ç±»</label><input list="category-list-edit" v-model="editingProduct.category" @focus="scrollToInput($event)" class="w-full p-3 border border-slate-200 rounded-lg font-bold" placeholder="ä¾‹å¦‚: é¥®æ–™"><datalist id="category-list-edit"><option v-for="cat in allCategories" :key="cat" :value="cat"></option></datalist></div>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="text-xs font-bold text-slate-400">æ‰¹å‘ä»·</label><input v-model.number="editingProduct.wholesale_price" @focus="scrollToInput($event)" type="number" class="w-full p-3 border border-slate-200 rounded-lg font-bold"></div>
                    <div class="flex-1"><label class="text-xs font-bold text-slate-400">é›¶å”®ä»·</label><input v-model.number="editingProduct.retail_price" @focus="scrollToInput($event)" type="number" class="w-full p-3 border border-slate-200 rounded-lg font-bold text-blue-600"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">çŠ¶æ€</label>
                    <select v-model="editingProduct.status" class="w-full p-3 border border-slate-200 rounded-lg bg-white">
                        <option value="active">ğŸŸ¢ æ­£å¸¸é”€å”®</option>
                        <option value="disabled">âšª æš‚åœé”€å”®</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button @click="deleteProduct" class="py-3 bg-red-50 text-red-600 rounded-xl font-bold text-sm">åˆ é™¤ / åœç”¨</button>
                <button @click="updateProduct" class="py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">ä¿å­˜</button>
            </div>
            <button @click="editingProduct = null" class="w-full mt-3 py-2 text-slate-400 text-xs">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- è®¢å•è¯¦æƒ… Modal -->
    <div v-if="viewingOrder" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in-up flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <div><h3 class="font-bold text-lg text-slate-800">è®¢å•è¯¦æƒ…</h3><div class="text-xs text-slate-400 font-mono mt-1">{{ formatDate(viewingOrder.created_at) }}</div></div>
                <button @click="viewingOrder = null" class="bg-slate-100 p-2 rounded-full text-slate-500"><i class="ph-x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-2 mb-4 pr-1">
                <div v-for="item in viewingOrderItems" :key="item.id" class="flex justify-between items-center p-2 border-b border-slate-50 last:border-0">
                    <div class="flex-1"><div class="font-bold text-slate-700 text-sm">{{ item.product_name }}</div><div class="text-[10px] text-slate-400 font-mono">x{{ item.quantity }} @ {{ item.unit_price }}</div></div>
                    <div class="font-bold text-slate-800">R$ {{ (item.quantity * item.unit_price).toFixed(2) }}</div>
                </div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="flex justify-between text-sm mb-1"><span class="text-slate-500">å•†å“æ€»æ•°</span><span class="font-bold">{{ viewingOrder.total_quantity }}</span></div>
                <div class="flex justify-between text-lg"><span class="text-slate-500 font-bold">æ€»é‡‘é¢</span><span class="font-black text-slate-900">R$ {{ viewingOrder.total_price }}</span></div>
            </div>
        </div>
    </div>

    <!-- Entry è‡ªåŠ¨å¼¹çª—ï¼šæ‰«ç åç›´æ¥å¼¹å‡ºæ–°å¢å•†å“å°çª—ï¼ˆä¸ quickAdd åŒºåˆ«ï¼‰ -->
    <div v-if="entryModalVisible" class="modal-backdrop z-60">
        <div class="modal-panel">
            <h3 class="font-bold text-lg mb-2">æ–°å¢å•†å“</h3>
            <p class="text-xs text-slate-500 mb-4">æ¡ç : <span class="font-mono">{{ entryForm.barcode }}</span></p>

            <div class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-1.5">å•†å“åç§°</label>
                    <input v-model="entryForm.name" type="text" class="w-full p-3 bg-slate-50 rounded-xl border border-transparent focus:bg-white focus:border-blue-500">
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-1.5">åˆ†ç±»</label>
                    <input list="category-list" v-model="entryForm.category" type="text" class="w-full p-3 bg-slate-50 rounded-xl border border-transparent focus:bg-white focus:border-blue-500">
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-1.5">æ‰¹å‘ä»·</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">R$</span>
                        <input v-model.number="entryForm.wholesale_price" type="number" class="w-full pl-8 p-3 bg-slate-50 rounded-xl font-bold border border-transparent focus:bg-white focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 block mb-1.5">é›¶å”®ä»·</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs">R$</span>
                        <input v-model.number="entryForm.retail_price" type="number" class="w-full pl-8 p-3 bg-slate-50 rounded-xl font-bold text-blue-600 border border-transparent focus:bg-white focus:border-blue-500">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button @click="confirmEntryAdd" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">ä¿å­˜å¹¶å…¥åº“</button>
                    <button @click="cancelEntryAdd" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createClient } = supabase;

    // ==========================================
    // âš ï¸âš ï¸ å¡«å…¥ä½ çš„ Supabase é…ç½®ï¼ˆå¦‚æœéœ€è¦åœ¨çº¿åŒæ­¥ï¼‰
    // ==========================================
    const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';
    // ==========================================

    const app = Vue.createApp({
        data() {
            return {
                supabase: null,
                isOnline: navigator.onLine,
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                currentTab: 'cashier',
                products: [], orders: [], orderItems: [],
                entryForm: { barcode: '', name: '', category: '', wholesale_price: '', retail_price: '' },
                quickAddForm: { barcode: '', price: '' },
                scanning: false,
                scanTab: null, // å½“å‰æ˜¯å“ªä¸ª tab åœ¨æ‰«ç 
                html5QrCode: null,
                scanError: '',
                lastScanTime: 0, scanCooldown: 600, justScanned: false,
                searchText: '', productFilterStatus: 'active', productFilterCategory: 'all', orderFilterType: 'completed',
                editingProduct: null, showQuickAdd: false, entryModalVisible: false,
                priceMode: 'retail', cashierSearch: '', cart: [],
                rankingRange: 'today', viewingOrder: null, syncQueue: JSON.parse(localStorage.getItem('syncQueue') || '[]'),
                recentProducts: [], inputLock: false
            };
        },
        computed: {
            currentTitle() { return { entry: 'å•†å“å½•å…¥', manage: 'å•†å“ç®¡ç†', cashier: 'å‰å°æ”¶é“¶', orders: 'é”€å”®æŠ¥è¡¨' }[this.currentTab]; },
            allCategories() { const cats = new Set(this.products.map(p => p.category || 'é»˜è®¤')); return Array.from(cats).sort(); },
            filteredProducts() {
                let list = this.products;
                if (this.productFilterStatus !== 'all') list = list.filter(p => p.status === this.productFilterStatus);
                if (this.productFilterCategory !== 'all') list = list.filter(p => (p.category || 'é»˜è®¤') === this.productFilterCategory);
                if (this.searchText) { const low = this.searchText.toLowerCase(); list = list.filter(p => (p.name || '').toLowerCase().includes(low) || (p.barcode || '').includes(low)); }
                return list;
            },
            filteredOrdersList() { return this.orders.filter(o => o.status === this.orderFilterType).sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); },
            cartTotalPrice() { return this.cart.reduce((sum, item) => sum + (Number(item.unit_price || 0) * item.quantity), 0).toFixed(2); },
            cartTotalQty() { return this.cart.reduce((sum, item) => sum + item.quantity, 0); },
            viewingOrderItems() { if (!this.viewingOrder) return []; return this.orderItems.filter(i => i.order_id === this.viewingOrder.id); },
            todaySales() { const spDate = this.getSaoPauloDateString(new Date()); return this.orders.filter(o => o.status === 'completed' && this.formatDate(o.created_at).includes(spDate)).reduce((sum, o) => sum + o.total_price, 0); },
            productSalesStats() {
                const now = new Date(); let startTime;
                if (this.rankingRange === 'today') {
                    const spDate = this.getSaoPauloDateString(now);
                    const validOrderIds = new Set(this.orders.filter(o => o.status === 'completed' && this.formatDate(o.created_at).includes(spDate)).map(o => o.id));
                    return this.calcStats(validOrderIds);
                } else {
                    const spNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
                    if (this.rankingRange === 'week') { const day = spNow.getDay() || 7; spNow.setHours(0,0,0,0); spNow.setDate(spNow.getDate() - day + 1); startTime = spNow; }
                    else if (this.rankingRange === 'month') { spNow.setDate(1); spNow.setHours(0,0,0,0); startTime = spNow; }
                    const validOrderIds = new Set(this.orders.filter(o => o.status === 'completed' && new Date(o.created_at) >= startTime).map(o => o.id));
                    return this.calcStats(validOrderIds);
                }
            }
        },
        mounted() {
            this.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            this.loadLocalData();
            this.fetchData().catch(()=>{});
            window.addEventListener('online', () => { this.isOnline = true; this.processSyncQueue(); });
            window.addEventListener('offline', () => { this.isOnline = false; });
            setInterval(this.processSyncQueue, 10000);

            this.$nextTick(() => {
                if (this.$refs.cashierInput && !this.isMobile) this.$refs.cashierInput.focus();
            });
        },
        methods: {
            /* ===== beep ä½¿ç”¨ WebAudioï¼ˆæ›´å¯é ï¼‰ ===== */
            playBeep() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sine';
                    o.frequency.value = 1200;
                    g.gain.value = 0.0001;
                    o.connect(g);
                    g.connect(ctx.destination);
                    o.start();

                    // æ¸å¢å†æ¸é€€ï¼Œé¿å…çªå…€ï¼ˆçŸ­ä¿ƒæ»´ï¼‰
                    g.gain.linearRampToValueAtTime(0.12, ctx.currentTime + 0.005);
                    g.gain.linearRampToValueAtTime(0.001, ctx.currentTime + 0.12);
                    setTimeout(() => { try { o.stop(); ctx.close(); } catch (e) {} }, 160);
                } catch (e) {
                    // fallback
                    const a = new Audio();
                    // é¢‘ç‡æ’­æ”¾å—é™ï¼Œå°è¯•ç©ºæ“ä½œä»¥é¿å…é”™è¯¯
                    try { a.play().catch(()=>{}); } catch(e){}
                }
            },

            calcStats(ids) { const stats = {}; this.orderItems.forEach(item => { if (ids.has(item.order_id)) { if (!stats[item.barcode]) stats[item.barcode] = { name: item.product_name, barcode: item.barcode, qty: 0 }; stats[item.barcode].qty += item.quantity; } }); return Object.values(stats).sort((a, b) => b.qty - a.qty); },
            getSaoPauloDateString(date) { return date.toLocaleDateString('zh-CN', { timeZone: 'America/Sao_Paulo' }).split('/').join('-'); },

            scrollToInput(event) {
                const el = event.target;
                if (!this.isMobile) return;
                const rect = el.getBoundingClientRect();
                const offset = window.scrollY + rect.top - 120;
                setTimeout(() => {
                    window.scrollTo({ top: offset, behavior: 'smooth' });
                }, 250);
            },

            /* ===== Scanner ç®¡ç†ï¼šæ¯æ¬¡ start åˆ›å»ºæ–°çš„å®ä¾‹ï¼Œstop æ—¶å½»åº• clear ===== */
            async toggleScanner(tab) {
                if (this.scanning && this.scanTab === tab) {
                    await this.stopScanner();
                } else {
                    // å¦‚æœå½“å‰åœ¨åˆ«çš„ tab çš„æ‘„åƒå¤´å¼€å¯ï¼Œå…ˆ stop
                    if (this.scanning && this.scanTab !== tab) await this.stopScanner();
                    this.scanTab = tab;
                    await this.startScanner(tab);
                }
            },

            async startScanner(tab) {
                this.scanError = '';
                const elementId = tab === 'entry' ? 'reader' : (tab === 'manage' ? 'manage-reader' : (tab === 'cashier' ? (this.isMobile ? 'cashier-reader' : 'cashier-reader-desktop') : 'reader'));
                // æ¯æ¬¡æ–°å»ºå®ä¾‹ï¼Œç¡®ä¿ç»‘å®šæ­£ç¡®çš„ DOM
                try {
                    this.html5QrCode = new Html5Qrcode(elementId);
                    this.scanning = true;

                    // æ›´ç¨³çš„é…ç½®ï¼ˆé€‚åˆæ¡å½¢ç /ä¸€ç»´ç ï¼‰
                    const config = {
                        fps: 15,
                        qrbox: tab === 'cashier' && !this.isMobile ? { width: 400, height: 200 } : { width: 280, height: 160 },
                        aspectRatio: 1.6,
                        experimentalFeatures: { useBarcodeDetectorIfSupported: true },
                        // disableFlip recommended for many devices but keep default
                    };

                    await this.html5QrCode.start(
                        { facingMode: "environment" },
                        config,
                        (decodedText) => { this.onScanSuccess(decodedText, tab); },
                        (errorMessage) => { /* å¿½ç•¥ä¸´æ—¶é”™è¯¯ */ }
                    );
                } catch (err) {
                    console.error('startScanner error', err);
                    this.scanning = false;
                    this.scanError = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥";
                    try { if (this.html5QrCode) { this.html5QrCode.clear(); } } catch(e){}
                    this.html5QrCode = null;
                }
            },

            async stopScanner() {
                try {
                    if (this.html5QrCode) {
                        if (this.html5QrCode.isScanning) {
                            await this.html5QrCode.stop();
                        }
                        try { this.html5QrCode.clear(); } catch(e){}
                    }
                } catch (e) { console.warn(e); }
                this.html5QrCode = null;
                this.scanning = false;
                this.scanTab = null;
                this.justScanned = false;
            },

            onScanSuccess(decodedText, tab) {
                const now = Date.now();
                if (now - this.lastScanTime < this.scanCooldown) return;
                this.lastScanTime = now;
                this.justScanned = true;
                setTimeout(() => { this.justScanned = false; }, this.scanCooldown);

                // beep (ç¡®è®¤å£°)
                try { this.playBeep(); } catch (e) {}

                if (tab === 'entry') {
                    // ç›´æ¥å¡«å…¥ entryForm å¹¶å¼¹çª—æ–°å¢
                    this.entryForm.barcode = decodedText;
                    // æ¸…ç©ºå…¶ä»–å­—æ®µä»¥ä¾¿å¿«é€Ÿå½•å…¥
                    this.entryForm.name = '';
                    this.entryForm.category = '';
                    this.entryForm.wholesale_price = '';
                    this.entryForm.retail_price = '';
                    this.entryModalVisible = true;
                    this.$nextTick(() => { /* focus name è¾“å…¥ */ const el = document.querySelector('.modal-panel input'); if (el) el.focus(); });
                } else if (tab === 'cashier') {
                    this.cashierSearch = decodedText;
                    this.addToCartByInput();
                } else if (tab === 'manage') {
                    this.searchText = decodedText;
                }
            },

            async switchTab(tab) {
                if (this.scanning) await this.stopScanner();
                this.currentTab = tab;
                this.$nextTick(() => {
                    if (!this.isMobile) {
                        if (tab === 'cashier' && this.$refs.cashierInput) this.$refs.cashierInput.focus();
                        if (tab === 'entry' && this.$refs.barcodeInput) this.$refs.barcodeInput.focus();
                        if (tab === 'manage' && this.$refs.manageInput) this.$refs.manageInput.focus();
                    }
                });
            },

            switchPriceMode(mode) {
                this.priceMode = mode;
                this.cart.forEach(item => {
                    const product = this.products.find(p => p.id === item.product_id);
                    if (product) {
                        item.unit_price = mode === 'retail' ? product.retail_price : product.wholesale_price;
                    }
                });
            },

            loadLocalData() {
                this.products = JSON.parse(localStorage.getItem('products') || '[]');
                this.orders = JSON.parse(localStorage.getItem('orders') || '[]');
                this.orderItems = JSON.parse(localStorage.getItem('orderItems') || '[]');
                this.recentProducts = JSON.parse(localStorage.getItem('recentProducts') || '[]');
            },

            async fetchData() {
                if (!this.isOnline) return;
                try {
                    const { data: p } = await this.supabase.from('products').select('*');
                    if (p) { this.products = p; localStorage.setItem('products', JSON.stringify(p)); }
                    const { data: o } = await this.supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(100);
                    if (o) { this.orders = o; localStorage.setItem('orders', JSON.stringify(o)); }
                    const { data: oi } = await this.supabase.from('order_items').select('*').limit(1000);
                    if (oi) { this.orderItems = oi; localStorage.setItem('orderItems', JSON.stringify(oi)); }
                } catch(e) {
                    console.warn('fetchData error', e);
                }
            },

            async addToCartByInput() {
                if (this.inputLock) return;
                this.inputLock = true;
                setTimeout(() => { this.inputLock = false; }, 300);

                const term = String(this.cashierSearch || '').trim();
                if (!term) return;

                let p = this.products.find(x => x.barcode === term && x.status === 'active');
                if (!p) p = this.products.find(x => x.name === term && x.status === 'active');

                if (p) {
                    const existing = this.cart.find(i => i.product_id === p.id);
                    if (existing) existing.quantity++;
                    else this.cart.push({
                        product_id: p.id, name: p.name, barcode: p.barcode,
                        unit_price: this.priceMode === 'retail' ? Number(p.retail_price || 0) : Number(p.wholesale_price || 0),
                        quantity: 1
                    });
                    this.cashierSearch = '';
                } else {
                    // quick add modal (cashier å¿«é€Ÿå…¥åº“)
                    this.quickAddForm = { barcode: term, price: '' };
                    this.showQuickAdd = true;
                    this.$nextTick(() => { if(this.$refs.quickPriceInput) this.$refs.quickPriceInput.focus(); });
                }
            },

            getNextName() {
                let max = 0; const regex = /^æœªå‘½å(\d+)$/;
                this.products.forEach(p => { const match = (p.name || '').match(regex); if (match) { const num = parseInt(match[1]); if (num > max) max = num; } });
                return `æœªå‘½å${max + 1}`;
            },

            saveQuickAdd() {
                if (!this.quickAddForm.price) return alert('è¯·è¾“å…¥ä»·æ ¼');
                const finalName = this.getNextName();
                const priceVal = parseFloat(this.quickAddForm.price);
                const retail = this.priceMode === 'retail' ? priceVal : 0;
                const wholesale = this.priceMode === 'wholesale' ? priceVal : 0;
                const p = { barcode: this.quickAddForm.barcode, name: finalName, category: 'é»˜è®¤', wholesale_price: wholesale, retail_price: retail, status: 'active' };
                const tempId = crypto.randomUUID(); const newProduct = { ...p, id: tempId };
                this.products.unshift(newProduct); localStorage.setItem('products', JSON.stringify(this.products)); this.addToSyncQueue('products', 'insert', p);

                this.recentProducts.unshift(p); if (this.recentProducts.length > 10) this.recentProducts.pop(); localStorage.setItem('recentProducts', JSON.stringify(this.recentProducts));

                this.cart.push({ product_id: tempId, name: p.name, barcode: p.barcode, unit_price: priceVal, quantity: 1 });
                this.showQuickAdd = false; this.cashierSearch = '';
            },

            handleBarcodeEnter() {
                if (!this.entryForm.barcode) return;
                const exists = this.products.find(p => p.barcode === this.entryForm.barcode);
                if (exists) alert('æ¡ç å·²å­˜åœ¨: ' + exists.name);
                else {
                    // å½“ç”¨æˆ·åœ¨æ¡ç è¾“å…¥åæŒ‰å›è½¦ï¼Œå¼¹å‡º entry modal ä»¥å¡«å…¥å…¶ä½™ä¿¡æ¯
                    this.entryModalVisible = true;
                    this.$nextTick(()=> {
                        const el = document.querySelector('.modal-panel input');
                        if (el) el.focus();
                    });
                }
            },

            saveProduct() {
                if (!this.entryForm.barcode) return alert('éœ€è¾“å…¥æ¡ç ');
                let finalName = this.entryForm.name || this.getNextName();
                const p = { barcode: this.entryForm.barcode, name: finalName, category: this.entryForm.category || 'é»˜è®¤', wholesale_price: parseFloat(this.entryForm.wholesale_price) || 0, retail_price: parseFloat(this.entryForm.retail_price) || 0, status: 'active' };
                const tempId = crypto.randomUUID(); this.products.unshift({ ...p, id: tempId }); localStorage.setItem('products', JSON.stringify(this.products)); this.addToSyncQueue('products', 'insert', p);

                this.recentProducts.unshift(p); if (this.recentProducts.length > 10) this.recentProducts.pop(); localStorage.setItem('recentProducts', JSON.stringify(this.recentProducts));

                this.entryForm = { barcode: '', name: '', category: '', wholesale_price: '', retail_price: '' };
                if (!this.isMobile) this.$refs.barcodeInput.focus();
            },

            /* Entry modal confirm (æ‰«ç åå¼¹çª—ä¿å­˜å¹¶å…¥åº“) */
            confirmEntryAdd() {
                if (!this.entryForm.barcode) return alert('ç¼ºå°‘æ¡ç ');
                this.saveProduct();
                this.entryModalVisible = false;
            },
            cancelEntryAdd() {
                this.entryModalVisible = false;
            },

            removeFromCart(idx) { this.cart.splice(idx, 1); },
            clearCart() { if(confirm('æ¸…ç©ºè´­ç‰©è½¦?')) this.cart = []; },

            checkoutDirectly() {
                const total = this.cartTotalPrice;
                if (!confirm(`æ€»é‡‘é¢ï¼šR$ ${total}\n\nç¡®è®¤æ”¶æ¬¾ï¼Ÿ`)) return;
                const orderId = crypto.randomUUID(); const now = new Date().toISOString();
                const order = { id: orderId, total_price: parseFloat(total), total_quantity: this.cartTotalQty, price_type: this.priceMode, payment_method: 'å¸¸è§„ç»“ç®—', status: 'completed', created_at: now };
                const items = this.cart.map(i => ({ order_id: orderId, product_id: i.product_id, product_name: i.name, barcode: i.barcode, unit_price: i.unit_price, quantity: i.quantity, subtotal: i.unit_price * i.quantity }));
                this.orders.unshift(order); this.orderItems.push(...items);
                localStorage.setItem('orders', JSON.stringify(this.orders)); localStorage.setItem('orderItems', JSON.stringify(this.orderItems));
                this.addToSyncQueue('orders', 'insert', order); this.addToSyncQueue('order_items', 'insert', items);
                this.cart = [];
                this.switchTab('orders');
            },

            voidOrder(order) { if(!confirm('ç¡®è®¤ä½œåºŸ?')) return; order.status = 'void'; localStorage.setItem('orders', JSON.stringify(this.orders)); this.addToSyncQueue('orders', 'update', { id: order.id, status: 'void' }); },
            async deleteOrder(order) {
                if(!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡ä½œåºŸè®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
                this.orders = this.orders.filter(o => o.id !== order.id); localStorage.setItem('orders', JSON.stringify(this.orders));
                if (this.isOnline) { const { error } = await this.supabase.from('orders').delete().eq('id', order.id); if (error) alert('åˆ é™¤å¤±è´¥'); } else { alert('ç¦»çº¿ä»…åˆ æœ¬åœ°'); }
            },
            viewOrderDetails(order) { this.viewingOrder = order; },
            editProduct(p) { this.editingProduct = JSON.parse(JSON.stringify(p)); },

            async updateProduct() {
                const idx = this.products.findIndex(p => p.id === this.editingProduct.id); if (idx !== -1) this.products[idx] = this.editingProduct;
                localStorage.setItem('products', JSON.stringify(this.products));
                const { id, ...updates } = this.editingProduct; this.addToSyncQueue('products', 'update', { id, ...updates }); this.editingProduct = null;
            },

            async deleteProduct() {
                if(!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤æ­¤å•†å“å—ï¼Ÿ')) return;
                const idToDelete = this.editingProduct.id;
                if (this.isOnline) {
                    const { error } = await this.supabase.from('products').delete().eq('id', idToDelete);
                    if (error) {
                        await this.supabase.from('products').update({ status: 'disabled' }).eq('id', idToDelete);
                        const idx = this.products.findIndex(p => p.id === idToDelete); if (idx !== -1) this.products[idx].status = 'disabled';
                        localStorage.setItem('products', JSON.stringify(this.products));
                        alert('ğŸ’¡ æç¤ºï¼šè¯¥å•†å“å­˜åœ¨å…³è”è®¢å•ï¼Œæ— æ³•å½»åº•åˆ é™¤ã€‚\nå·²ä¸ºæ‚¨è‡ªåŠ¨è½¬ä¸ºã€æš‚åœé”€å”®ã€‘çŠ¶æ€ã€‚');
                    } else {
                        this.products = this.products.filter(p => p.id !== idToDelete); localStorage.setItem('products', JSON.stringify(this.products));
                        console.log('å•†å“åˆ é™¤æˆåŠŸ');
                    }
                } else { alert('ç¦»çº¿æ¨¡å¼æ— æ³•åˆ é™¤'); }
                this.editingProduct = null;
            },

            exportExcel() { const ws = XLSX.utils.json_to_sheet(this.products); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Products"); XLSX.writeFile(wb, "Products_Brazil.xlsx"); },
            importExcel(e) { const f = e.target.files[0]; const r = new FileReader(); r.onload = (evt) => { const wb = XLSX.read(evt.target.result, { type: 'binary' }); const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); if(confirm(`å¯¼å…¥ ${data.length} æ¡?`)) { data.forEach(row => { const p = { barcode: row['barcode']||row['æ¡ç '], name: row['name']||row['åç§°'], category: row['category']||'é»˜è®¤', wholesale_price: row['wholesale']||0, retail_price: row['retail']||0, status: 'active' }; if(p.barcode) this.addToSyncQueue('products', 'insert', p); }); alert('å·²åŠ å…¥é˜Ÿåˆ—'); } }; r.readAsBinaryString(f); },

            formatDate(str) { if(!str) return ''; return new Date(str).toLocaleString('zh-CN', { timeZone: 'America/Sao_Paulo', month:'numeric', day:'numeric', hour:'numeric', minute:'numeric', hour12: false }); },

            /* ===== Sync é˜Ÿåˆ—ç®€æ˜“å®ç° ===== */
            addToSyncQueue(table, action, data) {
                this.syncQueue.push({ table, action, data, retry: 0, time: Date.now() });
                localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                this.processSyncQueue();
            },

            async processSyncQueue() {
                if (!this.isOnline || !this.syncQueue.length) return;
                const item = this.syncQueue[0];
                try {
                    if (item.action === 'insert') await this.supabase.from(item.table).insert(item.data);
                    else if (item.action === 'update') { const { id, ...updates } = item.data; await this.supabase.from(item.table).update(updates).eq('id', id); }
                    this.syncQueue.shift(); localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                    // ç»§ç»­é€’å½’å¤„ç†
                    setTimeout(() => this.processSyncQueue(), 200);
                } catch (e) {
                    item.retry = (item.retry || 0) + 1;
                    if (item.retry > 3) this.syncQueue.shift();
                    localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                }
            }
        }
    });

    app.mount('#app');
</script>
</body>
</html>
