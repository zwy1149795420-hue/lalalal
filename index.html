<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€æ”¶é“¶ Pro</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* æ‘„åƒå¤´æ ·å¼ä¼˜åŒ– */
        .scan-container {
            width: 100%;
            height: 100%; /* é€‚é…çˆ¶å®¹å™¨ */
            min-height: 250px;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        #reader video { 
            width: 100% !important; 
            height: 100% !important; 
            object-fit: cover !important; 
            border-radius: 12px;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-press:active { transform: scale(0.98); opacity: 0.9; }
        input:focus { outline: none; border-color: #2563eb; ring: 2px; box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }
        [v-cloak] { display: none; }

        /* æ¡Œé¢ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) {
            .desktop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
            .cashier-layout { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; height: calc(100vh - 80px); }
        }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen w-full flex flex-col md:flex-row bg-gray-50 overflow-hidden">

    <aside class="hidden md:flex w-64 bg-gray-900 text-white flex-col shrink-0 transition-all">
        <div class="p-6 border-b border-gray-800">
            <h1 class="text-xl font-bold flex items-center gap-2"><i class="ph-storefront text-blue-500"></i> å•†æˆ·é€š Pro</h1>
            <div class="flex items-center gap-2 mt-2 text-xs text-gray-400">
                <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                <span>{{ isOnline ? 'äº‘ç«¯å·²è¿æ¥' : 'ç¦»çº¿æ¨¡å¼' }}</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a @click="switchTab('cashier')" :class="currentTab==='cashier' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-bold">
                <i class="ph-barcode text-xl"></i> å‰å°æ”¶é“¶
            </a>
            <a @click="switchTab('entry')" :class="currentTab==='entry' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-bold">
                <i class="ph-plus-circle text-xl"></i> å•†å“å½•å…¥
            </a>
            <a @click="switchTab('manage')" :class="currentTab==='manage' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-bold">
                <i class="ph-package text-xl"></i> å•†å“ç®¡ç†
            </a>
            <a @click="switchTab('orders')" :class="currentTab==='orders' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-800'" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all font-bold">
                <i class="ph-receipt text-xl"></i> é”€å”®æŠ¥è¡¨
            </a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <header class="md:hidden h-14 bg-white px-4 shadow-sm shrink-0 flex justify-between items-center z-20 border-b border-gray-100">
            <h1 class="font-bold text-lg text-gray-800">{{ currentTitle }}</h1>
            <div class="flex items-center gap-2">
                <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                <span class="text-xs text-gray-500 font-mono">{{ isOnline ? 'ONLINE' : 'OFFLINE' }}</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto hide-scrollbar p-4 md:p-8 bg-gray-50/50">
            
            <div v-if="currentTab === 'cashier'" class="h-full flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-[400px] flex flex-col gap-4 shrink-0">
                    <div class="grid grid-cols-2 gap-2 bg-white p-1.5 rounded-xl shadow-sm border border-gray-100">
                        <button @click="priceMode = 'retail'" :class="priceMode === 'retail' ? 'bg-blue-600 text-white shadow' : 'text-gray-500 hover:bg-gray-50'" class="py-2.5 rounded-lg font-bold text-sm transition-all">é›¶å”®ä»·æ¨¡å¼</button>
                        <button @click="priceMode = 'wholesale'" :class="priceMode === 'wholesale' ? 'bg-orange-500 text-white shadow' : 'text-gray-500 hover:bg-gray-50'" class="py-2.5 rounded-lg font-bold text-sm transition-all">æ‰¹å‘ä»·æ¨¡å¼</button>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3">
                        <div class="relative">
                            <input ref="cashierInput" v-model="cashierSearch" @keyup.enter="addToCartByInput" type="text" placeholder="æ‰«ææ¡ç æˆ–è¾“å…¥åç§°" class="w-full p-4 pl-12 bg-gray-50 rounded-xl font-bold text-lg border border-transparent focus:bg-white focus:border-blue-200 transition-all">
                            <i class="ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
                            <button @click="toggleScanner('cashier')" :class="scanning ? 'text-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-200'" class="absolute right-2 top-2 p-2 rounded-lg transition-colors">
                                <i class="ph-qr-code text-xl"></i>
                            </button>
                        </div>

                        <div v-show="scanning" class="scan-container rounded-xl shadow-inner border border-gray-200">
                            <div id="cashier-reader" class="w-full h-full"></div>
                            <div class="absolute inset-0 pointer-events-none border-[3px] border-blue-500/30 rounded-xl"></div>
                            <div class="absolute top-1/2 left-4 right-4 h-0.5 bg-red-500/80 shadow-[0_0_10px_red] z-10 animate-pulse"></div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden relative min-h-[500px]">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">è´­ç‰©æ¸…å• ({{ cartTotalQty }})</h3>
                        <button @click="clearCart" class="text-red-500 text-sm hover:underline" v-if="cart.length > 0">æ¸…ç©º</button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        <div v-if="cart.length === 0" class="h-full flex flex-col items-center justify-center text-gray-300">
                            <i class="ph-shopping-cart text-6xl mb-2"></i>
                            <p>æš‚æ— å•†å“ï¼Œè¯·æ‰«ç æˆ–æœç´¢</p>
                        </div>
                        <div v-for="(item, index) in cart" :key="index" class="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-white border border-gray-100 rounded-lg hover:border-blue-200 transition-colors shadow-sm gap-3">
                            <div class="flex-1">
                                <div class="font-bold text-gray-800 text-lg">{{ item.name }}</div>
                                <div class="text-xs text-gray-400 font-mono">{{ item.barcode }}</div>
                            </div>
                            
                            <div class="flex items-center justify-between sm:justify-end gap-6 w-full sm:w-auto">
                                <div class="flex items-center bg-gray-100 rounded-lg p-1">
                                    <button @click="item.quantity > 1 ? item.quantity-- : removeFromCart(index)" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-gray-700 hover:text-red-500 transition-colors font-bold">-</button>
                                    <span class="w-10 text-center font-bold text-gray-800">{{ item.quantity }}</span>
                                    <button @click="item.quantity++" class="w-8 h-8 flex items-center justify-center bg-blue-600 rounded shadow-sm text-white hover:bg-blue-700 transition-colors font-bold">+</button>
                                </div>
                                <div class="text-right min-w-[80px]">
                                    <input v-model="item.unit_price" type="number" class="w-20 text-right font-bold text-lg bg-transparent border-b border-transparent focus:border-blue-500 transition-colors">
                                    <div class="text-xs text-gray-400">å°è®¡: {{ (item.unit_price * item.quantity).toFixed(2) }}</div>
                                </div>
                                <button @click="removeFromCart(index)" class="text-gray-400 hover:text-red-500 sm:hidden"><i class="ph-trash text-lg"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-100 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="text-center sm:text-left">
                            <div class="text-xs text-gray-500">åº”æ”¶é‡‘é¢</div>
                            <div class="text-3xl font-black text-gray-900">Â¥{{ cartTotalPrice }}</div>
                        </div>
                        <button @click="checkoutDirectly" :disabled="cart.length===0" class="w-full sm:w-auto px-10 py-4 bg-gray-900 hover:bg-gray-800 text-white rounded-xl font-bold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
                            <span>ç«‹å³æ”¶æ¬¾</span>
                            <i class="ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'manage'" class="space-y-4 max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row gap-3 bg-white p-3 rounded-xl shadow-sm border border-gray-100 sticky top-0 z-10">
                    <div class="relative flex-1">
                        <i class="ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input v-model="searchText" type="text" placeholder="æœç´¢å•†å“åç§°æˆ–æ¡ç ..." class="w-full pl-10 p-3 bg-gray-50 rounded-lg border border-transparent focus:bg-white focus:border-blue-200 transition-all">
                    </div>
                    <div class="flex gap-2">
                        <button @click="exportExcel" class="px-4 py-2 bg-green-50 text-green-700 hover:bg-green-100 rounded-lg font-bold flex items-center gap-2 transition-colors">
                            <i class="ph-file-xls text-lg"></i> <span class="hidden md:inline">å¯¼å‡º</span>
                        </button>
                        <label class="px-4 py-2 bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-lg font-bold flex items-center gap-2 cursor-pointer transition-colors">
                            <i class="ph-upload-simple text-lg"></i> <span class="hidden md:inline">å¯¼å…¥</span>
                            <input type="file" @change="importExcel" class="hidden" accept=".xlsx,.xls">
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <div v-for="p in filteredProducts" :key="p.id" @click="editProduct(p)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-blue-300 cursor-pointer transition-all group relative overflow-hidden">
                        <div v-if="p.status==='disabled'" class="absolute right-0 top-0 bg-red-100 text-red-600 text-xs px-2 py-1 rounded-bl-lg font-bold">åœç”¨</div>
                        <div class="flex flex-col h-full justify-between">
                            <div class="mb-3">
                                <h3 class="font-bold text-gray-800 text-lg leading-tight group-hover:text-blue-600 transition-colors line-clamp-2">{{ p.name }}</h3>
                                <p class="text-xs text-gray-400 font-mono mt-1">{{ p.barcode }}</p>
                            </div>
                            <div class="flex justify-between items-end border-t border-gray-50 pt-2">
                                <div class="text-xs text-gray-400">
                                    <div>è¿›: Â¥{{ p.wholesale_price }}</div>
                                </div>
                                <div class="text-xl font-bold text-blue-600">Â¥{{ p.retail_price }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="filteredProducts.length === 0" class="text-center py-20 text-gray-400">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“</div>
            </div>

            <div v-if="currentTab === 'entry'" class="flex flex-col lg:flex-row gap-6 max-w-5xl mx-auto">
                <div class="w-full lg:w-1/2 bg-black rounded-2xl overflow-hidden shadow-lg relative min-h-[300px] lg:h-[500px]">
                    <div v-show="scanning" class="w-full h-full">
                         <div id="reader" class="w-full h-full"></div>
                         <div class="absolute inset-0 pointer-events-none border-[4px] border-blue-500/30"></div>
                    </div>
                    <div v-if="!scanning" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                        <i class="ph-camera-slash text-5xl mb-2"></i>
                        <p>æ‘„åƒå¤´å·²å…³é—­</p>
                    </div>
                    <button @click="toggleScanner('entry')" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white/90 hover:bg-white text-gray-900 px-6 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 backdrop-blur-sm transition-all z-20">
                        <i :class="scanning ? 'ph-x' : 'ph-camera'" class="text-xl"></i> {{ scanning ? 'åœæ­¢æ‰«æ' : 'å¼€å¯æ‘„åƒå¤´' }}
                    </button>
                    <p v-if="scanError" class="absolute top-4 left-0 right-0 text-center text-red-500 bg-black/50 py-1 font-bold z-20">{{ scanError }}</p>
                </div>

                <div class="w-full lg:w-1/2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800"><i class="ph-plus-circle text-blue-600"></i> æ–°å¢å•†å“</h2>
                    <div class="space-y-5">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">æ¡å½¢ç </label>
                            <input ref="barcodeInput" v-model="entryForm.barcode" @keyup.enter="handleBarcodeEnter" type="text" class="w-full p-4 bg-gray-50 rounded-xl font-mono text-xl font-bold border border-gray-200 focus:bg-white focus:border-blue-500 transition-all" placeholder="è¯·æ‰«ç ">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">å•†å“åç§°</label>
                            <input v-model="entryForm.name" type="text" class="w-full p-4 bg-gray-50 rounded-xl text-gray-800 border border-gray-200 focus:bg-white focus:border-blue-500 transition-all" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">æ‰¹å‘ä»·</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                                    <input v-model="entryForm.wholesale_price" type="number" class="w-full p-4 pl-8 bg-gray-50 rounded-xl font-bold border border-gray-200 focus:bg-white focus:border-blue-500 transition-all">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1 block">é›¶å”®ä»·</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                                    <input v-model="entryForm.retail_price" type="number" class="w-full p-4 pl-8 bg-gray-50 rounded-xl font-bold text-blue-600 border border-gray-200 focus:bg-white focus:border-blue-500 transition-all">
                                </div>
                            </div>
                        </div>
                        <button @click="saveProduct" class="w-full py-4 bg-gray-900 hover:bg-gray-800 text-white rounded-xl font-bold text-lg shadow-lg transition-all mt-4 flex justify-center items-center gap-2">
                            <i class="ph-check-circle text-xl"></i> ç¡®è®¤æ·»åŠ 
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'orders'" class="space-y-6 max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-6 rounded-2xl shadow-lg text-white">
                        <div class="text-blue-100 text-sm font-bold uppercase tracking-wider">ä»Šæ—¥é”€å”®é¢</div>
                        <div class="text-4xl font-black mt-2">Â¥{{ todaySales.toFixed(2) }}</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="text-gray-400 text-sm font-bold uppercase tracking-wider">ä»Šæ—¥è®¢å•æ•°</div>
                        <div class="text-4xl font-black text-gray-800 mt-2">{{ todayOrders }} <span class="text-lg font-normal text-gray-400">å•</span></div>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="text-gray-400 text-sm font-bold uppercase tracking-wider">ä»Šæ—¥é”€é‡</div>
                        <div class="text-4xl font-black text-gray-800 mt-2">{{ todayItems }} <span class="text-lg font-normal text-gray-400">ä»¶</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 font-bold text-gray-700">æœ€è¿‘è®¢å•</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4">æ—¶é—´</th>
                                    <th class="p-4">çŠ¶æ€</th>
                                    <th class="p-4">æ¨¡å¼</th>
                                    <th class="p-4">æ•°é‡</th>
                                    <th class="p-4 text-right">é‡‘é¢</th>
                                    <th class="p-4 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                <tr v-for="order in sortedOrders" :key="order.id" class="hover:bg-gray-50 transition-colors">
                                    <td class="p-4 text-gray-600 font-mono text-sm">{{ formatDate(order.created_at) }}</td>
                                    <td class="p-4">
                                        <span :class="order.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="px-2 py-1 rounded text-xs font-bold">
                                            {{ order.status === 'completed' ? 'å®Œæˆ' : 'ä½œåºŸ' }}
                                        </span>
                                    </td>
                                    <td class="p-4 text-sm text-gray-500">{{ order.price_type === 'retail' ? 'é›¶å”®' : 'æ‰¹å‘' }}</td>
                                    <td class="p-4 font-bold text-gray-700">{{ order.total_quantity }}</td>
                                    <td class="p-4 text-right font-bold text-gray-900">Â¥{{ order.total_price }}</td>
                                    <td class="p-4 text-center">
                                        <button v-if="order.status === 'completed'" @click="voidOrder(order)" class="text-red-400 hover:text-red-600 font-bold text-xs border border-red-200 hover:border-red-400 px-3 py-1 rounded transition-all">ä½œåºŸ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <nav class="md:hidden h-[70px] bg-white border-t border-gray-200 flex justify-around items-center shrink-0 z-40 pb-2">
            <div @click="switchTab('entry')" :class="{'text-blue-600': currentTab==='entry'}" class="flex flex-col items-center w-1/4 btn-press">
                <i class="ph-plus-circle text-2xl mb-1"></i>
                <span class="text-[10px] font-bold">å½•å…¥</span>
            </div>
            <div @click="switchTab('manage')" :class="{'text-blue-600': currentTab==='manage'}" class="flex flex-col items-center w-1/4 btn-press">
                <i class="ph-package text-2xl mb-1"></i>
                <span class="text-[10px] font-bold">ç®¡ç†</span>
            </div>
            <div @click="switchTab('cashier')" :class="{'text-blue-600': currentTab==='cashier'}" class="flex flex-col items-center w-1/4 btn-press relative">
                 <div class="absolute -top-6 bg-blue-600 text-white p-3 rounded-full shadow-lg border-4 border-gray-50">
                    <i class="ph-barcode text-2xl"></i>
                 </div>
                 <span class="text-[10px] font-bold mt-7">æ”¶é“¶</span>
            </div>
            <div @click="switchTab('orders')" :class="{'text-blue-600': currentTab==='orders'}" class="flex flex-col items-center w-1/4 btn-press">
                <i class="ph-receipt text-2xl mb-1"></i>
                <span class="text-[10px] font-bold">æŠ¥è¡¨</span>
            </div>
        </nav>

    </main>

    <div v-if="editingProduct" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-fade-in-up">
            <h3 class="font-bold text-xl mb-6 text-gray-800">ç¼–è¾‘å•†å“</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400">å•†å“åç§°</label>
                    <input v-model="editingProduct.name" class="w-full p-3 border border-gray-200 rounded-lg focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400">æ¡ç  (ä¸å¯æ”¹)</label>
                    <input v-model="editingProduct.barcode" class="w-full p-3 border border-gray-200 rounded-lg bg-gray-50 text-gray-500 font-mono" readonly>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400">æ‰¹å‘ä»·</label>
                        <input v-model="editingProduct.wholesale_price" type="number" class="w-full p-3 border border-gray-200 rounded-lg font-bold">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400">é›¶å”®ä»·</label>
                        <input v-model="editingProduct.retail_price" type="number" class="w-full p-3 border border-gray-200 rounded-lg font-bold text-blue-600">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400">çŠ¶æ€</label>
                    <select v-model="editingProduct.status" class="w-full p-3 border border-gray-200 rounded-lg bg-white">
                        <option value="active">ğŸŸ¢ æ­£å¸¸å¯ç”¨</option>
                        <option value="disabled">ğŸ”´ åœç”¨å•†å“</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button @click="editingProduct = null" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-bold text-gray-600 transition-colors">å–æ¶ˆ</button>
                <button @click="updateProduct" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition-colors">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createClient } = supabase;
    
    // ==========================================
    // âš ï¸âš ï¸ è¯·åœ¨æ­¤å¤„å¡«å†™ä½ çš„ Supabase é…ç½® âš ï¸âš ï¸
    // ==========================================
    const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';
    // ==========================================

    const app = Vue.createApp({
        data() {
            return {
                supabase: null,
                isOnline: navigator.onLine,
                currentTab: 'cashier', // é»˜è®¤è¿›æ”¶é“¶å°
                products: [], orders: [], orderItems: [], 
                
                // å½•å…¥
                entryForm: { barcode: '', name: '', wholesale_price: '', retail_price: '' },
                
                // æ‰«ç 
                scanning: false,
                html5QrCode: null,
                scanError: '',
                
                // ä¸šåŠ¡
                searchText: '',
                editingProduct: null,
                priceMode: 'retail', 
                cashierSearch: '',
                cart: [],
                syncQueue: JSON.parse(localStorage.getItem('syncQueue') || '[]')
            }
        },
        computed: {
            currentTitle() { return { entry: 'æ‰«ç å½•å…¥', manage: 'å•†å“åº“', cashier: 'æ”¶é“¶å°', orders: 'é”€å”®æŠ¥è¡¨' }[this.currentTab]; },
            filteredProducts() {
                if (!this.searchText) return this.products;
                const low = this.searchText.toLowerCase();
                return this.products.filter(p => p.name?.toLowerCase().includes(low) || p.barcode.includes(low));
            },
            cartTotalPrice() { return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0).toFixed(2); },
            cartTotalQty() { return this.cart.reduce((sum, item) => sum + item.quantity, 0); },
            sortedOrders() { return [...this.orders].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); },
            todaySales() {
                const today = new Date().toISOString().split('T')[0];
                return this.orders.filter(o => o.status === 'completed' && o.created_at.startsWith(today)).reduce((sum, o) => sum + o.total_price, 0);
            },
            todayOrders() {
                const today = new Date().toISOString().split('T')[0];
                return this.orders.filter(o => o.status === 'completed' && o.created_at.startsWith(today)).length;
            },
            todayItems() {
                const today = new Date().toISOString().split('T')[0];
                return this.orders.filter(o => o.status === 'completed' && o.created_at.startsWith(today)).reduce((sum, o) => sum + o.total_quantity, 0);
            }
        },
        async mounted() {
            this.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            this.loadLocalData();
            await this.fetchData();
            window.addEventListener('online', () => { this.isOnline = true; this.processSyncQueue(); });
            window.addEventListener('offline', () => { this.isOnline = false; });
            setInterval(this.processSyncQueue, 10000);
            
            // æ¡Œé¢ç«¯é»˜è®¤ä¸è‡ªåŠ¨èšç„¦æ‰«ç æ¡†ï¼Œé¿å…å¹²æ‰°
        },
        methods: {
            // === æ‘„åƒå¤´é€»è¾‘ (å¤ç”¨ä¹‹å‰çš„ä¿®æ­£ç‰ˆ) ===
            async toggleScanner(tab) {
                if (this.scanning) { await this.stopScanner(); } else { this.startScanner(tab); }
            },
            async startScanner(tab) {
                this.scanError = '';
                const elementId = tab === 'entry' ? "reader" : "cashier-reader";
                if (!this.html5QrCode) { this.html5QrCode = new Html5Qrcode(elementId); }
                try {
                    this.scanning = true;
                    await this.html5QrCode.start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => this.onScanSuccess(decodedText, tab),
                        (errorMessage) => {}
                    );
                } catch (err) {
                    this.scanning = false;
                    this.scanError = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥HTTPSæˆ–æƒé™";
                    this.html5QrCode = null;
                }
            },
            async stopScanner() {
                if (this.html5QrCode && this.html5QrCode.isScanning) {
                    try { await this.html5QrCode.stop(); this.html5QrCode.clear(); } catch (e) {}
                }
                this.html5QrCode = null;
                this.scanning = false;
            },
            onScanSuccess(decodedText, tab) {
                if (tab === 'entry') {
                    this.entryForm.barcode = decodedText;
                    this.handleBarcodeEnter();
                } else if (tab === 'cashier') {
                    this.cashierSearch = decodedText;
                    this.addToCartByInput();
                }
            },
            async switchTab(tab) {
                if (this.scanning) await this.stopScanner();
                this.currentTab = tab;
            },

            // === ä¸šåŠ¡é€»è¾‘ ===
            loadLocalData() {
                this.products = JSON.parse(localStorage.getItem('products') || '[]');
                this.orders = JSON.parse(localStorage.getItem('orders') || '[]');
                this.orderItems = JSON.parse(localStorage.getItem('orderItems') || '[]');
            },
            async fetchData() {
                if (!this.isOnline) return;
                const { data: p } = await this.supabase.from('products').select('*');
                if (p) { this.products = p; localStorage.setItem('products', JSON.stringify(p)); }
                const { data: o } = await this.supabase.from('orders').select('*').limit(50);
                if (o) { this.orders = o; localStorage.setItem('orders', JSON.stringify(o)); }
            },
            handleBarcodeEnter() {
                if (!this.entryForm.barcode) return;
                const exists = this.products.find(p => p.barcode === this.entryForm.barcode);
                if (exists) alert('æ¡ç å·²å­˜åœ¨: ' + exists.name);
            },
            saveProduct() {
                if (!this.entryForm.barcode) return alert('éœ€è¾“å…¥æ¡ç ');
                let finalName = this.entryForm.name || `æœªå‘½å${this.products.length + 1}`;
                const p = {
                    barcode: this.entryForm.barcode,
                    name: finalName,
                    wholesale_price: parseFloat(this.entryForm.wholesale_price) || 0,
                    retail_price: parseFloat(this.entryForm.retail_price) || 0,
                    status: 'active'
                };
                const tempId = crypto.randomUUID();
                this.products.unshift({ ...p, id: tempId });
                localStorage.setItem('products', JSON.stringify(this.products));
                this.addToSyncQueue('products', 'insert', p);
                this.entryForm = { barcode: '', name: '', wholesale_price: '', retail_price: '' };
                this.$refs.barcodeInput.focus();
            },
            addToCartByInput() {
                const term = this.cashierSearch.trim();
                if (!term) return;
                let p = this.products.find(x => x.barcode === term && x.status === 'active');
                if (!p) p = this.products.find(x => x.name === term && x.status === 'active');
                if (p) {
                    const existing = this.cart.find(i => i.product_id === p.id);
                    if (existing) existing.quantity++;
                    else this.cart.push({
                        product_id: p.id, name: p.name, barcode: p.barcode,
                        unit_price: this.priceMode === 'retail' ? p.retail_price : p.wholesale_price, quantity: 1
                    });
                    this.cashierSearch = '';
                }
            },
            removeFromCart(idx) { this.cart.splice(idx, 1); },
            clearCart() { if(confirm('æ¸…ç©ºè´­ç‰©è½¦?')) this.cart = []; },
            checkoutDirectly() {
                const total = this.cartTotalPrice;
                if (!confirm(`æ€»é‡‘é¢ï¼šÂ¥${total}\n\nç¡®è®¤å®Œæˆæ”¶æ¬¾ï¼Ÿ`)) return;
                const orderId = crypto.randomUUID();
                const now = new Date().toISOString();
                const order = {
                    id: orderId, total_price: parseFloat(total), total_quantity: this.cartTotalQty,
                    price_type: this.priceMode, payment_method: 'å¸¸è§„ç»“ç®—', status: 'completed', created_at: now
                };
                const items = this.cart.map(i => ({
                    order_id: orderId, product_id: i.product_id, product_name: i.name, barcode: i.barcode,
                    unit_price: i.unit_price, quantity: i.quantity, subtotal: i.unit_price * i.quantity
                }));
                this.orders.unshift(order);
                localStorage.setItem('orders', JSON.stringify(this.orders));
                this.addToSyncQueue('orders', 'insert', order);
                this.addToSyncQueue('order_items', 'insert', items);
                this.cart = [];
                this.switchTab('orders');
            },
            voidOrder(order) {
                if(!confirm('ç¡®è®¤ä½œåºŸ?')) return;
                order.status = 'void';
                localStorage.setItem('orders', JSON.stringify(this.orders));
                this.addToSyncQueue('orders', 'update', { id: order.id, status: 'void' });
            },
            editProduct(p) { this.editingProduct = JSON.parse(JSON.stringify(p)); },
            updateProduct() {
                const idx = this.products.findIndex(p => p.id === this.editingProduct.id);
                if (idx !== -1) this.products[idx] = this.editingProduct;
                localStorage.setItem('products', JSON.stringify(this.products));
                const { id, ...updates } = this.editingProduct;
                this.addToSyncQueue('products', 'update', { id, ...updates });
                this.editingProduct = null;
            },
            exportExcel() {
                const ws = XLSX.utils.json_to_sheet(this.products);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, "å•†å“å¯¼å‡º.xlsx");
            },
            importExcel(e) {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(confirm(`å¯¼å…¥ ${data.length} æ¡æ•°æ®?`)) {
                        data.forEach(row => {
                            const p = { barcode: row['barcode']||row['æ¡ç '], name: row['name']||row['åç§°'], wholesale_price: row['wholesale']||0, retail_price: row['retail']||0, status: 'active' };
                            if(p.barcode) this.addToSyncQueue('products', 'insert', p);
                        });
                        alert('å·²åŠ å…¥åŒæ­¥é˜Ÿåˆ—');
                    }
                };
                r.readAsBinaryString(f);
            },
            formatDate(str) { return new Date(str).toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'}); },
            addToSyncQueue(table, action, data) {
                this.syncQueue.push({ table, action, data, retry: 0 });
                localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                this.processSyncQueue();
            },
            async processSyncQueue() {
                if (!this.isOnline || !this.syncQueue.length) return;
                const item = this.syncQueue[0];
                try {
                    if (item.action === 'insert') await this.supabase.from(item.table).insert(item.data);
                    else if (item.action === 'update') {
                        const { id, ...updates } = item.data;
                        await this.supabase.from(item.table).update(updates).eq('id', id);
                    }
                    this.syncQueue.shift();
                    localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                    this.processSyncQueue();
                } catch (e) {
                    item.retry++;
                    if(item.retry > 3) this.syncQueue.shift();
                    localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                }
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
