<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€å•†ç”¨æ”¶é“¶ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .scan-box { border: 2px solid #3b82f6; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5); content: ''; display: block; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 30%; z-index: 10; border-radius: 12px; }
        .scan-anim { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #3b82f6; box-shadow: 0 0 4px #3b82f6; animation: scanning 2s infinite; }
        @keyframes scanning { 0% {top:0} 50% {top:100%} 100% {top:0} }
        /* éšè— input ä½†ä¿æŒç„¦ç‚¹ç”¨äºæ‰«ç æª */
        .gun-input { position: absolute; opacity: 0; top: -1000px; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full">

    <div class="bg-white p-3 shadow-sm z-20 flex justify-between items-center h-14 shrink-0">
        <h1 class="font-bold text-lg text-gray-800">{{ currentTabName }}</h1>
        <div class="text-xs px-2 py-1 rounded" :class="isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
            {{ isOnline ? 'å·²è¿æ¥' : 'ç¦»çº¿æ¨¡å¼' }}
        </div>
    </div>

    <div class="flex-1 overflow-y-auto overflow-x-hidden relative" id="main-content">
        
        <div v-if="currentTab === 'entry'" class="p-4 space-y-4 pb-24">
            <div class="bg-black rounded-xl overflow-hidden relative h-64 flex items-center justify-center bg-gray-900 shadow-inner">
                <div id="reader-entry" class="w-full h-full object-cover"></div>
                <div v-if="!cameraActive" class="absolute inset-0 flex flex-col items-center justify-center text-white cursor-pointer" @click="startCamera('entry')">
                    <i class="ri-qr-scan-2-line text-4xl mb-2"></i>
                    <span>ç‚¹å‡»å¯åŠ¨æ‰«æ / æ‰«ç æªç›´æ¥æ‰«</span>
                </div>
                <div v-if="cameraActive" class="scan-box"><div class="scan-anim"></div></div>
                <div v-if="cameraActive" class="absolute bottom-2 text-white text-xs bg-black/50 px-2 py-1 rounded">ç‚¹å‡»ç”»é¢åœæ­¢</div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                <div>
                    <label class="text-gray-500 text-xs font-bold">æ¡å½¢ç  (å¿…å¡«)</label>
                    <div class="flex gap-2">
                        <input v-model="entryForm.barcode" type="text" class="w-full text-lg font-mono font-bold border-b-2 border-gray-200 focus:border-blue-500 outline-none py-2" placeholder="æ‰«ç æˆ–è¾“å…¥">
                        <button @click="generateBarcode" class="text-blue-500 text-sm whitespace-nowrap">æ— ç ç”Ÿæˆ</button>
                    </div>
                </div>

                <div>
                    <label class="text-gray-500 text-xs font-bold">å•†å“åç§°</label>
                    <input v-model="entryForm.name" type="text" class="w-full text-lg border-b-2 border-gray-200 focus:border-blue-500 outline-none py-2" :placeholder="autoNamePlaceholder">
                </div>

                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-gray-500 text-xs font-bold">æ‰¹å‘ä»·</label>
                        <input v-model.number="entryForm.wholesale_price" type="number" step="0.01" class="w-full text-xl font-bold text-orange-600 border-b-2 border-gray-200 focus:border-orange-500 outline-none py-2" placeholder="0.00">
                    </div>
                    <div class="flex-1">
                        <label class="text-gray-500 text-xs font-bold">é›¶å”®ä»·</label>
                        <input v-model.number="entryForm.retail_price" type="number" step="0.01" class="w-full text-xl font-bold text-green-600 border-b-2 border-gray-200 focus:border-green-500 outline-none py-2" placeholder="0.00">
                    </div>
                </div>

                <button @click="saveProduct" class="w-full bg-blue-600 active:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg mt-4 text-lg">
                    ä¿å­˜å¹¶ç»§ç»­ (Enter)
                </button>
            </div>
        </div>

        <div v-if="currentTab === 'manage'" class="flex flex-col h-full">
            <div class="p-3 bg-white border-b flex gap-2">
                <input v-model="searchText" placeholder="æœç´¢å•†å“åæˆ–æ¡ç ..." class="flex-1 bg-gray-100 px-3 py-2 rounded-lg outline-none">
                <button @click="exportExcel" class="bg-green-100 text-green-700 px-3 py-2 rounded-lg text-sm font-bold"><i class="ri-file-excel-2-line"></i> å¯¼å‡º</button>
                <label class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg text-sm font-bold cursor-pointer">
                    <i class="ri-upload-2-line"></i> å¯¼å…¥
                    <input type="file" @change="importExcel" class="hidden" accept=".xlsx,.xls">
                </label>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2 pb-24">
                <div v-for="p in filteredProducts" :key="p.id" class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center" :class="{'opacity-50': p.status === 'inactive'}">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800">{{ p.name || 'æœªå‘½å' }}</div>
                        <div class="text-xs text-gray-400 font-mono">{{ p.barcode }}</div>
                        <div class="text-xs mt-1">
                            <span class="text-orange-600 mr-2">æ‰¹: Â¥{{ p.wholesale_price }}</span>
                            <span class="text-green-600">é›¶: Â¥{{ p.retail_price }}</span>
                        </div>
                    </div>
                    <button @click="editProduct(p)" class="bg-gray-100 p-2 rounded-full text-gray-600">
                        <i class="ri-edit-line"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'cashier'" class="flex flex-col h-full relative">
            <div v-if="cart.length === 0" class="p-2 grid grid-cols-2 gap-2 mb-2">
                <button @click="cashierMode = 'retail'" :class="cashierMode === 'retail' ? 'bg-green-600 text-white ring-2 ring-green-300' : 'bg-white text-gray-600'" class="p-3 rounded-lg font-bold shadow-sm transition-all">
                    é›¶å”®æ¨¡å¼
                </button>
                <button @click="cashierMode = 'wholesale'" :class="cashierMode === 'wholesale' ? 'bg-orange-600 text-white ring-2 ring-orange-300' : 'bg-white text-gray-600'" class="p-3 rounded-lg font-bold shadow-sm transition-all">
                    æ‰¹å‘æ¨¡å¼
                </button>
            </div>

            <div class="bg-black relative h-32 shrink-0 overflow-hidden mx-2 rounded-lg mb-2">
                <div id="reader-cashier" class="w-full h-full object-cover"></div>
                <div v-if="!cameraActive" @click="startCamera('cashier')" class="absolute inset-0 flex items-center justify-center text-white cursor-pointer bg-gray-800">
                    <div class="text-center">
                        <i class="ri-barcode-box-line text-2xl"></i>
                        <div class="text-xs mt-1">ç‚¹å‡»æ‰«ç  / æ‰«ç æªå¾…å‘½</div>
                    </div>
                </div>
                <div v-if="cameraActive" class="absolute inset-0 border-2 border-green-400 pointer-events-none"></div>
            </div>

            <div class="px-2 mb-2">
                 <input v-model="cashierSearch" @keyup.enter="manualAdd" placeholder="è¾“å…¥æ¡ç æˆ–åç§°å›è½¦..." class="w-full bg-white px-4 py-3 rounded-lg shadow-sm outline-none border border-transparent focus:border-blue-500">
            </div>

            <div class="flex-1 overflow-y-auto px-2 space-y-2 pb-32">
                <div v-for="(item, index) in cart" :key="index" class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-bold">{{ item.product_name }}</div>
                        <div class="text-xs text-gray-400">{{ item.barcode }}</div>
                        <div class="flex items-center mt-2 gap-3">
                            <button @click="updateQty(index, -1)" class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-lg font-bold">-</button>
                            <span class="font-mono text-lg font-bold">{{ item.quantity }}</span>
                            <button @click="updateQty(index, 1)" class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-lg font-bold">+</button>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <input type="number" v-model.number="item.unit_price" class="w-20 text-right bg-gray-50 border-b border-gray-300 focus:border-blue-500 outline-none font-mono" @change="saveCart">
                        <div class="font-bold text-lg text-red-600">Â¥{{ (item.unit_price * item.quantity).toFixed(2) }}</div>
                        <button @click="removeFromCart(index)" class="text-gray-400 text-xs mt-1 underline">åˆ é™¤</button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-[4.5rem] left-0 right-0 bg-white border-t p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-500">å…± {{ cartTotalQty }} ä»¶</span>
                    <span class="text-2xl font-bold text-red-600">Â¥{{ cartTotalPrice }}</span>
                </div>
                <div class="flex gap-2">
                    <button @click="clearCart" class="bg-gray-200 text-gray-700 px-4 rounded-lg font-bold">æ¸…ç©º</button>
                    <button @click="showCheckout = true" :disabled="cart.length === 0" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold text-lg shadow-lg disabled:opacity-50">
                        æ”¶æ¬¾
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'orders'" class="p-2 space-y-2 pb-24">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div class="bg-blue-600 text-white p-3 rounded-lg shadow">
                    <div class="text-xs opacity-80">ä»Šæ—¥é”€å”®é¢</div>
                    <div class="text-xl font-bold">Â¥{{ todaySales.toFixed(2) }}</div>
                </div>
                <div class="bg-purple-600 text-white p-3 rounded-lg shadow">
                    <div class="text-xs opacity-80">ä»Šæ—¥è®¢å•æ•°</div>
                    <div class="text-xl font-bold">{{ todayOrderCount }}</div>
                </div>
            </div>
            
            <div v-for="order in orders" :key="order.id" class="bg-white p-3 rounded-lg shadow-sm border-l-4" :class="order.status === 'void' ? 'border-gray-300 opacity-60' : 'border-green-500'">
                <div class="flex justify-between">
                    <span class="font-mono text-xs text-gray-500">{{ new Date(order.created_at).toLocaleString() }}</span>
                    <span class="text-xs px-2 rounded" :class="order.price_type==='wholesale'?'bg-orange-100 text-orange-700':'bg-green-100 text-green-700'">{{ order.price_type === 'wholesale' ? 'æ‰¹å‘' : 'é›¶å”®' }}</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <div>
                        <div class="font-bold text-lg">Â¥{{ order.total_price }}</div>
                        <div class="text-xs text-gray-500">{{ order.payment_method }} | {{ order.total_quantity }} ä»¶</div>
                    </div>
                    <button v-if="order.status !== 'void'" @click="voidOrder(order)" class="text-red-500 border border-red-200 px-3 py-1 rounded text-sm">ä½œåºŸ</button>
                    <span v-else class="text-gray-400 font-bold text-sm transform -rotate-12 border-2 border-gray-300 px-2">å·²ä½œåºŸ</span>
                </div>
            </div>
        </div>

    </div>

    <div class="bg-white border-t h-16 shrink-0 flex justify-around items-center z-20 text-gray-500 pb-safe">
        <button @click="switchTab('entry')" class="flex flex-col items-center w-full" :class="{'text-blue-600': currentTab==='entry'}">
            <i class="ri-add-circle-line text-2xl mb-0.5"></i>
            <span class="text-[10px]">å•†å“å½•å…¥</span>
        </button>
        <button @click="switchTab('manage')" class="flex flex-col items-center w-full" :class="{'text-blue-600': currentTab==='manage'}">
            <i class="ri-archive-line text-2xl mb-0.5"></i>
            <span class="text-[10px]">å•†å“ç®¡ç†</span>
        </button>
        <button @click="switchTab('cashier')" class="flex flex-col items-center w-full" :class="{'text-blue-600': currentTab==='cashier'}">
            <div class="bg-blue-100 p-2 rounded-full -mt-6 border-4 border-gray-100">
                <i class="ri-hand-coin-line text-3xl text-blue-600"></i>
            </div>
            <span class="text-[10px] font-bold text-blue-600 mt-1">æ”¶é“¶</span>
        </button>
        <button @click="switchTab('orders')" class="flex flex-col items-center w-full" :class="{'text-blue-600': currentTab==='orders'}">
            <i class="ri-file-list-3-line text-2xl mb-0.5"></i>
            <span class="text-[10px]">è®¢å•ç®¡ç†</span>
        </button>
    </div>

    <div v-if="showCheckout" class="fixed inset-0 bg-black/50 z-50 flex items-end justify-center">
        <div class="bg-white w-full rounded-t-2xl p-4 animate-slide-up">
            <h3 class="font-bold text-center text-lg mb-4">é€‰æ‹©æ”¯ä»˜æ–¹å¼</h3>
            <div class="text-center mb-6">
                <div class="text-gray-500 text-sm">åº”æ”¶é‡‘é¢</div>
                <div class="text-4xl font-bold text-red-600">Â¥{{ cartTotalPrice }}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button @click="finishCheckout('å¾®ä¿¡')" class="bg-[#09BB07] text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><i class="ri-wechat-line"></i> å¾®ä¿¡</button>
                <button @click="finishCheckout('æ”¯ä»˜å®')" class="bg-[#1678FF] text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><i class="ri-alipay-line"></i> æ”¯ä»˜å®</button>
                <button @click="finishCheckout('ç°é‡‘')" class="bg-yellow-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><i class="ri-money-cny-box-line"></i> ç°é‡‘</button>
                <button @click="finishCheckout('å…¶ä»–')" class="bg-gray-500 text-white py-3 rounded-lg font-bold">å…¶ä»–</button>
            </div>
            <button @click="showCheckout = false" class="w-full py-3 text-gray-500">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="editingProduct" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-4">
            <h3 class="font-bold mb-4">ç¼–è¾‘å•†å“</h3>
            <div class="space-y-3">
                <input v-model="editingProduct.name" class="w-full border p-2 rounded" placeholder="åç§°">
                <input v-model="editingProduct.barcode" class="w-full border p-2 rounded" placeholder="æ¡ç ">
                <div class="flex gap-2">
                    <input v-model.number="editingProduct.wholesale_price" type="number" class="w-full border p-2 rounded" placeholder="æ‰¹å‘ä»·">
                    <input v-model.number="editingProduct.retail_price" type="number" class="w-full border p-2 rounded" placeholder="é›¶å”®ä»·">
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-sm">çŠ¶æ€:</span>
                    <button @click="editingProduct.status = editingProduct.status==='active'?'inactive':'active'" 
                        class="px-3 py-1 rounded text-sm font-bold"
                        :class="editingProduct.status==='active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'">
                        {{ editingProduct.status==='active'?'å¯ç”¨':'å·²åœç”¨' }}
                    </button>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button @click="editingProduct = null" class="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button>
                <button @click="saveEditedProduct" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <input ref="gunInput" type="text" class="gun-input" @blur="keepFocus" autocomplete="off">

</div>

<script>
    const { createClient } = supabase;

    // ğŸ‘‰ å¿…å¡«åŒºåŸŸï¼šSupabase Key (å·²æŒ‰è¦æ±‚é¢„å¡«)
    const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';

    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    const { createApp, ref, computed, onMounted, onUnmounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // çŠ¶æ€
            const currentTab = ref('entry');
            const isOnline = ref(navigator.onLine);
            const products = ref([]);
            const orders = ref([]);
            const searchText = ref('');
            const cameraActive = ref(false);
            const html5QrCode = ref(null);
            
            // å½•å…¥ç›¸å…³
            const entryForm = ref({ barcode: '', name: '', wholesale_price: '', retail_price: '' });
            const untitledCount = ref(1);

            // æ”¶é“¶ç›¸å…³
            const cashierMode = ref('retail'); // retail | wholesale
            const cart = ref([]);
            const cashierSearch = ref('');
            const showCheckout = ref(false);

            // ç®¡ç†ç›¸å…³
            const editingProduct = ref(null);

            // æ‰«ç é”
            let scanLock = false;
            let gunBuffer = '';
            let gunTimeout = null;
            const gunInput = ref(null);

            // è®¡ç®—å±æ€§
            const currentTabName = computed(() => {
                const map = { entry: 'å•†å“å½•å…¥', manage: 'å•†å“åº“', cashier: 'æ”¶é“¶å°', orders: 'è®¢å•è®°å½•' };
                return map[currentTab.value];
            });

            const filteredProducts = computed(() => {
                if(!searchText.value) return products.value;
                const low = searchText.value.toLowerCase();
                return products.value.filter(p => (p.name||'').toLowerCase().includes(low) || p.barcode.includes(low));
            });

            const cartTotalPrice = computed(() => {
                return cart.value.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0).toFixed(2);
            });

            const cartTotalQty = computed(() => cart.value.reduce((sum, item) => sum + item.quantity, 0));

            const autoNamePlaceholder = computed(() => `é»˜è®¤: æœªå‘½å${untitledCount.value}`);

            const todaySales = computed(() => {
                const today = new Date().toDateString();
                return orders.value
                    .filter(o => new Date(o.created_at).toDateString() === today && o.status === 'completed')
                    .reduce((sum, o) => sum + o.total_price, 0);
            });

            const todayOrderCount = computed(() => {
                const today = new Date().toDateString();
                return orders.value.filter(o => new Date(o.created_at).toDateString() === today && o.status === 'completed').length;
            });

            // åˆå§‹åŒ–
            onMounted(async () => {
                loadLocalData();
                await fetchProducts();
                await fetchOrders();
                window.addEventListener('online', () => { isOnline.value = true; syncData(); });
                window.addEventListener('offline', () => isOnline.value = false);
                
                // æ‰«ç æªå…¨å±€ç›‘å¬
                window.addEventListener('keydown', handleGunInput);
                
                // é¡µé¢å¯è§æ€§ç›‘å¬
                document.addEventListener("visibilitychange", () => {
                    if (document.hidden) stopCamera();
                });

                // åˆå§‹å¯åŠ¨å½•å…¥æ‘„åƒå¤´
                if(currentTab.value === 'entry') startCamera('entry');
            });

            // æ–¹æ³•
            const switchTab = async (tab) => {
                stopCamera();
                currentTab.value = tab;
                if (tab === 'entry' || tab === 'cashier') {
                    // å»¶è¿Ÿä¸€ç‚¹ç»™DOMæ¸²æŸ“
                    setTimeout(() => startCamera(tab), 100);
                }
            };

            // ---- æ•°æ®åº“äº¤äº’ ----
            const fetchProducts = async () => {
                const { data, error } = await db.from('products').select('*').order('created_at', { ascending: false });
                if (data) {
                    products.value = data;
                    localStorage.setItem('products', JSON.stringify(data));
                    // æ›´æ–°æœªå‘½åè®¡æ•°
                    const untitled = data.filter(p => p.name && p.name.startsWith('æœªå‘½å'));
                    if(untitled.length > 0) {
                        const max = Math.max(...untitled.map(p => parseInt(p.name.replace('æœªå‘½å', '')) || 0));
                        untitledCount.value = max + 1;
                    }
                }
            };

            const fetchOrders = async () => {
                const { data } = await db.from('orders').select('*').order('created_at', { ascending: false }).limit(50);
                if(data) orders.value = data;
            };

            // ---- å½•å…¥é€»è¾‘ ----
            const generateBarcode = () => {
                entryForm.value.barcode = Date.now().toString().slice(-8) + Math.floor(Math.random()*1000);
            };

            const saveProduct = async () => {
                if (!entryForm.value.barcode) return alert('å¿…é¡»æœ‰æ¡ç ');
                
                const finalName = entryForm.value.name || `æœªå‘½å${untitledCount.value}`;
                
                const newProduct = {
                    barcode: entryForm.value.barcode,
                    name: finalName,
                    wholesale_price: entryForm.value.wholesale_price || 0,
                    retail_price: entryForm.value.retail_price || 0,
                    status: 'active'
                };

                // æœ¬åœ°ä¹è§‚æ›´æ–°
                products.value.unshift(newProduct);
                
                // å†™å…¥æ•°æ®åº“
                const { error } = await db.from('products').insert(newProduct);
                
                if (error) {
                    if(error.code === '23505') alert('æ¡ç å·²å­˜åœ¨ï¼');
                    else alert('ä¿å­˜å¤±è´¥');
                } else {
                    // é‡ç½®è¡¨å•
                    if (!entryForm.value.name) untitledCount.value++;
                    entryForm.value.barcode = '';
                    entryForm.value.name = '';
                    entryForm.value.wholesale_price = '';
                    entryForm.value.retail_price = '';
                    // é‡æ–°èšç„¦/å¼€å§‹æ‰«æ
                    startCamera('entry');
                }
            };

            // ---- æ”¶é“¶é€»è¾‘ ----
            const addToCart = (barcode) => {
                const product = products.value.find(p => p.barcode === barcode);
                if (!product) {
                    if(confirm('æœªæ‰¾åˆ°è¯¥å•†å“ï¼Œæ˜¯å¦è·³è½¬å»å½•å…¥ï¼Ÿ')) switchTab('entry');
                    return;
                }
                if (product.status !== 'active') return alert('å•†å“å·²åœç”¨');

                const existing = cart.value.find(i => i.product_id === product.id);
                if (existing) {
                    existing.quantity++;
                } else {
                    cart.value.push({
                        product_id: product.id,
                        product_name: product.name,
                        barcode: product.barcode,
                        unit_price: cashierMode.value === 'retail' ? product.retail_price : product.wholesale_price,
                        quantity: 1
                    });
                }
                saveCart();
                playBeep();
            };

            const manualAdd = () => {
                if(!cashierSearch.value) return;
                // ä¼˜å…ˆç²¾ç¡®åŒ¹é…æ¡ç 
                const p = products.value.find(p => p.barcode === cashierSearch.value);
                if(p) {
                    addToCart(p.barcode);
                    cashierSearch.value = '';
                } else {
                    // æ¨¡ç³Šæœç´¢åç§°
                    const matches = products.value.filter(p => p.name.includes(cashierSearch.value));
                    if(matches.length === 1) {
                        addToCart(matches[0].barcode);
                        cashierSearch.value = '';
                    } else if (matches.length > 1) {
                        alert(`æ‰¾åˆ° ${matches.length} ä¸ªå•†å“ï¼Œè¯·è¾“å…¥æ›´ç²¾ç¡®çš„åç§°æˆ–æ¡ç `);
                    } else {
                        alert('æœªæ‰¾åˆ°å•†å“');
                    }
                }
            };

            const updateQty = (index, change) => {
                cart.value[index].quantity += change;
                if (cart.value[index].quantity <= 0) cart.value.splice(index, 1);
                saveCart();
            };

            const removeFromCart = (index) => {
                cart.value.splice(index, 1);
                saveCart();
            };

            const clearCart = () => {
                if(confirm('ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ')) {
                    cart.value = [];
                    saveCart();
                }
            };

            const finishCheckout = async (method) => {
                const order = {
                    total_price: parseFloat(cartTotalPrice.value),
                    total_quantity: cartTotalQty.value,
                    price_type: cashierMode.value,
                    payment_method: method,
                    status: 'completed'
                };

                const { data: orderData, error } = await db.from('orders').insert(order).select().single();
                
                if (error) {
                    alert('è®¢å•ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                    return;
                }

                const items = cart.value.map(item => ({
                    order_id: orderData.id,
                    product_id: item.product_id,
                    product_name: item.product_name,
                    barcode: item.barcode,
                    unit_price: item.unit_price,
                    quantity: item.quantity,
                    subtotal: item.unit_price * item.quantity
                }));

                await db.from('order_items').insert(items);
                
                showCheckout.value = false;
                cart.value = [];
                saveCart();
                fetchOrders();
            };

            // ---- æ‘„åƒå¤´é€»è¾‘ ----
            const startCamera = (mode) => {
                if (cameraActive.value) return; // å·²è¿è¡Œ
                const elementId = mode === 'entry' ? 'reader-entry' : 'reader-cashier';
                const el = document.getElementById(elementId);
                if(!el) return;

                html5QrCode.value = new Html5Qrcode(elementId);
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.777778 };
                
                // å¯è§†åŒ–çŠ¶æ€
                el.innerHTML = '<div class="text-white text-center pt-10">å¯åŠ¨æ‘„åƒå¤´ä¸­...</div>';

                html5QrCode.value.start(
                    { facingMode: { ideal: "environment" } }, 
                    config, 
                    (decodedText) => {
                        // æˆåŠŸå›è°ƒ
                        if (scanLock) return;
                        scanLock = true;
                        
                        // åœæ­¢æ‰«æ
                        html5QrCode.value.pause(); 
                        
                        handleScanSuccess(decodedText, mode);

                        // å†·å´ 500ms
                        setTimeout(() => {
                            scanLock = false;
                            if(mode === 'entry' && !entryForm.value.barcode) {
                                // å½•å…¥æ¨¡å¼å¦‚æœæ²¡å¡«å®Œï¼Œæ¢å¤æ‰«æ
                                // è¿™é‡Œé€»è¾‘æ˜¯ï¼šå½•å…¥æ¨¡å¼å¡«å…¥æ¡ç åï¼Œé€šå¸¸éœ€è¦å¡«åå­—ï¼Œæ‰€ä»¥æš‚åœæ¯”è¾ƒå¥½
                                // åªæœ‰å½“ä¿å­˜åæ‰æ¢å¤ã€‚ä½†ä¸ºäº†ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬åªå¡«å€¼ã€‚
                            } else {
                                html5QrCode.value.resume();
                            }
                        }, 800);
                    },
                    (errorMessage) => { 
                        // å¿½ç•¥é”™è¯¯ï¼Œé¿å…åˆ·å±
                    }
                ).then(() => {
                    cameraActive.value = true;
                }).catch(err => {
                    console.error(err);
                    alert('æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨ HTTPS æˆ–å…è®¸æƒé™');
                });
            };

            const stopCamera = () => {
                if (html5QrCode.value && html5QrCode.value.isScanning) {
                    html5QrCode.value.stop().then(() => {
                        html5QrCode.value.clear();
                        cameraActive.value = false;
                    }).catch(err => console.log(err));
                }
            };

            const handleScanSuccess = (code, mode) => {
                playBeep();
                if (mode === 'entry') {
                    // å½•å…¥æ¨¡å¼ï¼šå¡«å…¥æ¡ç 
                    entryForm.value.barcode = code;
                    // æ ¡éªŒæ˜¯å¦å·²å­˜åœ¨
                    const exist = products.value.find(p => p.barcode === code);
                    if (exist) alert(`æç¤ºï¼šå•†å“åº“å·²å­˜åœ¨æ­¤æ¡ç  (${exist.name})`);
                    stopCamera(); // å½•å…¥æˆåŠŸæš‚åœï¼Œç­‰å¾…è¾“å…¥ä»·æ ¼
                } else if (mode === 'cashier') {
                    // æ”¶é“¶æ¨¡å¼ï¼šåŠ è´­
                    addToCart(code);
                    html5QrCode.value.resume(); // ç«‹å³æ¢å¤
                }
            };

            // ---- æ‰«ç æªå…¼å®¹ ----
            const handleGunInput = (e) => {
                // å¦‚æœç„¦ç‚¹åœ¨æ­£å¸¸è¾“å…¥æ¡†ï¼Œä¸æ‹¦æˆª
                if (e.target.tagName === 'INPUT' && e.target.type !== 'checkbox') return;

                if (e.key === 'Enter') {
                    if (gunBuffer.length > 5) { // ç®€å•è¿‡æ»¤
                        const code = gunBuffer;
                        if (currentTab.value === 'entry') {
                            entryForm.value.barcode = code;
                        } else if (currentTab.value === 'cashier') {
                            addToCart(code);
                        } else if (currentTab.value === 'manage') {
                            searchText.value = code;
                        }
                    }
                    gunBuffer = '';
                } else {
                    // ä»…æ•°å­—æˆ–å­—æ¯
                    if (e.key.length === 1) gunBuffer += e.key;
                    // è¶…æ—¶æ¸…ç©º
                    clearTimeout(gunTimeout);
                    gunTimeout = setTimeout(() => gunBuffer = '', 100);
                }
            };

            // ---- å…¶ä»–è¾…åŠ© ----
            const playBeep = () => {
                const audio = new AudioContext();
                const osc = audio.createOscillator();
                const gain = audio.createGain();
                osc.connect(gain);
                gain.connect(audio.destination);
                osc.frequency.value = 1500;
                gain.gain.value = 0.1;
                osc.start();
                setTimeout(() => osc.stop(), 100);
            };

            const loadLocalData = () => {
                const p = localStorage.getItem('products');
                if(p) products.value = JSON.parse(p);
                const c = localStorage.getItem('cart');
                if(c) cart.value = JSON.parse(c);
            };

            const syncData = () => {
                fetchProducts();
            };

            const saveCart = () => {
                localStorage.setItem('cart', JSON.stringify(cart.value));
            };

            // ç®¡ç†åŠŸèƒ½
            const editProduct = (p) => {
                editingProduct.value = { ...p };
            };
            
            const saveEditedProduct = async () => {
                const { error } = await db.from('products').update(editingProduct.value).eq('id', editingProduct.value.id);
                if(!error) {
                    editingProduct.value = null;
                    fetchProducts();
                } else {
                    alert('æ›´æ–°å¤±è´¥');
                }
            };

            const exportExcel = () => {
                const ws = XLSX.utils.json_to_sheet(products.value);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, "products_backup.xlsx");
            };

            const importExcel = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if(jsonData.length > 0 && confirm(`å‡†å¤‡å¯¼å…¥ ${jsonData.length} æ¡æ•°æ®ï¼Ÿ`)) {
                        // ç®€å•æ‰¹é‡æ’å…¥ï¼Œå®é™…ä½¿ç”¨å»ºè®®åˆ†æ‰¹
                         jsonData.forEach(async item => {
                             // æ˜ å°„å­—æ®µï¼ˆå‡è®¾ Excel åˆ—è¡¨å¤´åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…è¦åšæ˜ å°„ï¼‰
                             const p = {
                                 barcode: item.barcode || item['æ¡ç '],
                                 name: item.name || item['å•†å“å'] || item['åç§°'],
                                 wholesale_price: item.wholesale_price || item['æ‰¹å‘ä»·'] || 0,
                                 retail_price: item.retail_price || item['é›¶å”®ä»·'] || 0
                             };
                             if(p.barcode) await db.from('products').upsert(p, { onConflict: 'barcode' });
                         });
                         alert('åå°æ­£åœ¨å¯¼å…¥ï¼Œè¯·ç¨ååˆ·æ–°');
                         setTimeout(fetchProducts, 2000);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const voidOrder = async (order) => {
                if(!confirm('ç¡®å®šä½œåºŸæ­¤è®¢å•ï¼Ÿä¸å¯æ¢å¤ã€‚')) return;
                const { error } = await db.from('orders').update({ status: 'void' }).eq('id', order.id);
                if(!error) {
                    order.status = 'void';
                }
            };
            
            const keepFocus = () => {
               // ä¿æŒç„¦ç‚¹é€»è¾‘åœ¨ç§»åŠ¨ç«¯å¯èƒ½ä¼šå¼•èµ·é”®ç›˜å¼¹å‡ºï¼Œè¿™é‡Œä¸»è¦é  window keydown ç›‘å¬
            };

            return {
                currentTab, switchTab, currentTabName, isOnline,
                products, filteredProducts, searchText,
                entryForm, saveProduct, generateBarcode, autoNamePlaceholder,
                cart, addToCart, cashierMode, updateQty, removeFromCart, clearCart, cartTotalPrice, cartTotalQty, cashierSearch, manualAdd,
                showCheckout, finishCheckout,
                orders, todaySales, todayOrderCount, voidOrder,
                editingProduct, editProduct, saveEditedProduct,
                exportExcel, importExcel,
                startCamera, stopCamera, cameraActive
            };
        }
    }).mount('#app');
</script>
</body>
</html>
