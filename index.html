<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€æ”¶é“¶ Pro</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* åŸºç¡€æ ·å¼é‡ç½®ä¸ä¼˜åŒ– */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ‰«ææ¡†æ ·å¼å¾®è°ƒ */
        #reader video { object-fit: cover; border-radius: 0.75rem; }
        #reader { border: none !important; }
        
        /* åŠ¨ç”»ç±» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* ç§»åŠ¨ç«¯Inputèšç„¦æ—¶ä¸æ”¾å¤§ */
        input, select, textarea { font-size: 16px !important; }

        /* åº•éƒ¨å¯¼èˆªå®‰å…¨åŒº */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col overflow-hidden">
    
    <header class="bg-white shadow-sm z-20 px-4 py-3 flex justify-between items-center" v-if="currentView !== 'entry'">
        <h1 class="font-bold text-lg text-gray-800">{{ pageTitle }}</h1>
        <div class="flex gap-2">
            <span :class="isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="text-xs px-2 py-1 rounded-full font-medium">
                {{ isOnline ? 'äº‘ç«¯åŒæ­¥' : 'ç¦»çº¿æ¨¡å¼' }}
            </span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto overflow-x-hidden relative bg-gray-50">
        
        <div v-if="currentView === 'entry'" class="h-full flex flex-col">
            <div class="relative bg-black transition-all duration-300 overflow-hidden shrink-0" :style="{ height: scanning ? '280px' : '0px' }">
                <div v-if="cameraMount" id="reader" class="w-full h-full bg-black"></div>
                
                <div v-if="scanning" class="absolute inset-0 pointer-events-none border-2 border-blue-400/50 m-8 rounded-lg flex items-center justify-center">
                    <div class="w-full h-0.5 bg-red-500/80 animate-pulse shadow-[0_0_10px_rgba(255,0,0,0.8)]"></div>
                </div>
                <div v-if="scanning" class="absolute bottom-2 w-full text-center text-white text-xs text-shadow">
                    è·ç¦»æ¡ç  10-20cm
                </div>
                <button @click="stopScanner" class="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full backdrop-blur-sm z-30">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <div class="flex-1 flex flex-col p-4 bg-white rounded-t-2xl -mt-4 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                
                <div class="space-y-4">
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-gray-500 uppercase">æ¡å½¢ç </label>
                            <div class="flex gap-2">
                                <input ref="entryBarcode" v-model="entryForm.barcode" type="number" pattern="\d*" class="w-full bg-gray-100 border-0 rounded-lg px-4 py-3 font-mono text-lg focus:ring-2 focus:ring-blue-500 transition-all" placeholder="æ‰«ç æˆ–è¾“å…¥">
                                <button @click="toggleScanner('entry')" class="bg-blue-600 text-white px-4 rounded-lg active:scale-95 transition-transform flex items-center justify-center">
                                    <i class="ph ph-scan text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">å•†å“åç§°</label>
                        <input v-model="entryForm.name" type="text" class="w-full bg-gray-100 border-0 rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-blue-500 transition-all" placeholder="ä¾‹å¦‚ï¼šå¯å£å¯ä¹">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">æ‰¹å‘ä»·</label>
                            <input v-model="entryForm.wholesale_price" type="number" step="0.01" class="w-full bg-gray-100 border-0 rounded-lg px-4 py-3 text-lg font-medium focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">é›¶å”®ä»·</label>
                            <input v-model="entryForm.retail_price" type="number" step="0.01" class="w-full bg-gray-100 border-0 rounded-lg px-4 py-3 text-lg font-medium text-blue-600 focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <p class="text-xs text-gray-400 mb-2">åˆšåˆšå½•å…¥</p>
                        <div v-if="lastAddedProduct" class="flex justify-between items-center bg-green-50 p-3 rounded-lg border border-green-100">
                            <div>
                                <div class="font-bold text-gray-800">{{ lastAddedProduct.name }}</div>
                                <div class="text-xs text-gray-500">{{ lastAddedProduct.barcode }}</div>
                            </div>
                            <div class="font-mono font-bold text-green-700">Â¥{{ lastAddedProduct.retail_price }}</div>
                        </div>
                        <div v-else class="text-center text-gray-300 text-sm py-2">æš‚æ— è®°å½•</div>
                    </div>
                </div>

                <div class="mt-auto pt-4 pb-safe">
                    <button @click="saveProduct" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <i class="ph ph-check-circle text-xl"></i>
                        ç¡®è®¤å¹¶ç»§ç»­
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'cashier'" class="h-full flex flex-col md:flex-row">
            <div class="flex-1 flex flex-col h-full overflow-hidden">
                <div class="p-3 bg-white shadow-sm z-10 flex gap-2">
                    <button @click="togglePriceMode" :class="priceMode === 'retail' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'" class="px-3 py-2 rounded-lg font-bold text-sm whitespace-nowrap transition-colors">
                        {{ priceMode === 'retail' ? 'é›¶å”®ä»·' : 'æ‰¹å‘ä»·' }}
                    </button>
                    <div class="flex-1 relative">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input ref="cashierInput" v-model="searchQuery" @keyup.enter="handleSearchEnter" type="text" class="w-full bg-gray-100 rounded-lg pl-9 pr-8 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ‰«ç  / æœç´¢...">
                        <button v-if="searchQuery" @click="searchQuery=''" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400"><i class="ph ph-x-circle-fill"></i></button>
                    </div>
                    <button @click="toggleScanner('cashier')" class="bg-gray-900 text-white w-10 h-10 rounded-lg flex items-center justify-center active:scale-95">
                        <i class="ph ph-scan text-lg"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div v-for="(item, index) in cart" :key="item.tempId" class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center animate-[slideIn_0.2s_ease-out]">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 truncate">{{ item.name }}</h3>
                            <div class="text-xs text-gray-400 font-mono">{{ item.barcode }}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">Â¥{{ item.unit_price }}</span>
                                <span v-if="item.original_price !== item.unit_price" class="text-xs line-through text-gray-300">Â¥{{ item.original_price }}</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-end gap-2">
                            <div class="font-bold text-lg text-gray-900">Â¥{{ (item.unit_price * item.quantity).toFixed(2) }}</div>
                            <div class="flex items-center bg-gray-100 rounded-lg p-0.5">
                                <button @click="updateQty(index, -1)" class="w-7 h-7 flex items-center justify-center bg-white rounded shadow-sm text-red-500 active:bg-gray-50"><i class="ph ph-minus"></i></button>
                                <span class="w-8 text-center font-bold text-sm">{{ item.quantity }}</span>
                                <button @click="updateQty(index, 1)" class="w-7 h-7 flex items-center justify-center bg-white rounded shadow-sm text-green-600 active:bg-gray-50"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="cart.length === 0" class="flex flex-col items-center justify-center h-40 text-gray-400">
                        <i class="ph ph-shopping-cart text-4xl mb-2 opacity-50"></i>
                        <p class="text-sm">æš‚æ— å•†å“ï¼Œè¯·æ‰«ç </p>
                    </div>
                </div>

                <div class="bg-white border-t border-gray-200 p-3 pb-safe shadow-[0_-4px_10px_rgba(0,0,0,0.05)] z-20">
                    <div class="flex justify-between items-end mb-3">
                        <div class="text-xs text-gray-500">å…± {{ cartTotalQty }} ä»¶</div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400 mr-1">åˆè®¡</span>
                            <span class="text-2xl font-bold text-gray-900 font-mono">Â¥{{ cartTotalPrice }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="clearCart" class="px-4 py-3 border border-red-200 text-red-600 rounded-xl font-medium active:bg-red-50 transition-colors">
                            <i class="ph ph-trash"></i>
                        </button>
                        <button @click="prepareCheckout" :disabled="cart.length === 0" :class="cart.length === 0 ? 'bg-gray-300' : 'bg-blue-600 shadow-blue-200 shadow-lg'" class="flex-1 py-3 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 active:scale-[0.98] transition-all">
                            æ”¶æ¬¾
                            <i class="ph ph-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div v-if="scanning && currentView === 'cashier'" class="fixed inset-0 z-50 bg-black flex flex-col">
                 <div v-if="cameraMount" id="reader-cashier" class="w-full flex-1"></div>
                 <button @click="stopScanner" class="absolute bottom-10 left-1/2 -translate-x-1/2 bg-white/20 backdrop-blur text-white px-6 py-3 rounded-full font-bold border border-white/30">å…³é—­æ‰«ç </button>
            </div>
        </div>

        <div v-if="currentView === 'manage'" class="h-full flex flex-col p-4">
            <div class="flex gap-2 mb-4">
                <input v-model="manageSearch" type="text" class="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="æœç´¢å•†å“...">
                <div class="flex gap-1">
                   <button @click="exportData" class="bg-green-100 text-green-700 px-3 rounded-lg text-sm font-medium">å¯¼å‡º</button>
                   <label class="bg-blue-100 text-blue-700 px-3 rounded-lg text-sm font-medium flex items-center cursor-pointer">
                       å¯¼å…¥ <input type="file" @change="importData" class="hidden" accept=".xlsx,.xls">
                   </label>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex-1">
                <div class="overflow-y-auto h-full">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-3 font-medium">å•†å“</th>
                                <th class="p-3 font-medium text-right">ä»·æ ¼</th>
                                <th class="p-3 font-medium text-center">çŠ¶æ€</th>
                                <th class="p-3 font-medium text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr v-for="p in filteredProducts" :key="p.id">
                                <td class="p-3">
                                    <div class="font-bold text-gray-800">{{ p.name }}</div>
                                    <div class="text-xs text-gray-400 font-mono">{{ p.barcode }}</div>
                                </td>
                                <td class="p-3 text-right">
                                    <div class="text-blue-600">Â¥{{ p.retail_price }}</div>
                                    <div class="text-xs text-gray-400">æ‰¹:{{ p.wholesale_price }}</div>
                                </td>
                                <td class="p-3 text-center">
                                    <span :class="p.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-500'" class="px-2 py-0.5 rounded text-xs">
                                        {{ p.status === 'active' ? 'åœ¨å”®' : 'åœç”¨' }}
                                    </span>
                                </td>
                                <td class="p-3 text-center">
                                    <button @click="openEditModal(p)" class="text-blue-600 font-medium">ç¼–è¾‘</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'orders'" class="h-full overflow-y-auto p-4 space-y-3">
             <div v-for="order in orders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                 <div class="flex justify-between items-start mb-2">
                     <div>
                         <div class="text-xs text-gray-400">{{ formatDate(order.created_at) }}</div>
                         <div class="font-bold text-gray-800">è®¢å• #{{ order.id }}</div>
                     </div>
                     <span :class="order.status === 'completed' ? 'text-green-600' : 'text-red-500'" class="text-xs font-bold px-2 py-1 bg-gray-50 rounded">{{ order.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²ä½œåºŸ' }}</span>
                 </div>
                 <div class="flex justify-between items-center border-t border-gray-100 pt-2 mt-2">
                     <div class="text-sm text-gray-500">{{ order.payment_method }} | {{ order.price_type === 'retail' ? 'é›¶å”®' : 'æ‰¹å‘' }}</div>
                     <div class="text-lg font-bold font-mono">Â¥{{ order.total_price }}</div>
                 </div>
                 <div class="mt-2 flex justify-end gap-2">
                     <button v-if="order.status === 'completed'" @click="voidOrder(order)" class="text-xs border border-red-200 text-red-600 px-3 py-1.5 rounded-lg active:bg-red-50">ä½œåºŸè®¢å•</button>
                 </div>
             </div>
        </div>

    </main>

    <nav class="bg-white border-t border-gray-200 pb-safe z-30 flex justify-around items-center h-[60px] shrink-0">
        <button v-for="tab in tabs" :key="tab.id" @click="switchTab(tab.id)" :class="currentView === tab.id ? 'text-blue-600' : 'text-gray-400'" class="flex-1 flex flex-col items-center justify-center h-full active:bg-gray-50">
            <i :class="tab.icon" class="text-2xl mb-0.5 transition-transform" :class="currentView === tab.id ? 'scale-110 font-weight-bold' : ''"></i>
            <span class="text-[10px] font-medium">{{ tab.name }}</span>
        </button>
    </nav>

    <div v-if="showPaymentModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-[scaleIn_0.2s_ease-out]">
            <h3 class="text-lg font-bold text-center mb-1">ç¡®è®¤æ”¶æ¬¾</h3>
            <div class="text-3xl font-bold text-center text-blue-600 font-mono mb-6">Â¥{{ cartTotalPrice }}</div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button v-for="method in ['å¾®ä¿¡', 'æ”¯ä»˜å®', 'ç°é‡‘', 'å…¶ä»–']" :key="method" @click="completeOrder(method)" class="py-3 bg-gray-50 border border-gray-200 rounded-xl font-medium active:bg-blue-50 active:border-blue-500 active:text-blue-600">
                    {{ method }}
                </button>
            </div>
            
            <button @click="showPaymentModal = false" class="w-full py-3 text-gray-500 font-medium">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="editingProduct" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-[slideUp_0.3s_ease-out]">
            <h3 class="text-lg font-bold mb-4">ç¼–è¾‘å•†å“</h3>
            <div class="space-y-3">
                <input v-model="editingProduct.name" class="w-full bg-gray-100 p-3 rounded-lg" placeholder="å•†å“åç§°">
                <input v-model="editingProduct.barcode" class="w-full bg-gray-100 p-3 rounded-lg" placeholder="æ¡ç ">
                <div class="flex gap-2">
                    <input v-model="editingProduct.wholesale_price" type="number" class="w-1/2 bg-gray-100 p-3 rounded-lg" placeholder="æ‰¹å‘ä»·">
                    <input v-model="editingProduct.retail_price" type="number" class="w-1/2 bg-gray-100 p-3 rounded-lg" placeholder="é›¶å”®ä»·">
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm font-medium">çŠ¶æ€: {{ editingProduct.status === 'active' ? 'å¯ç”¨' : 'åœç”¨' }}</span>
                    <button @click="editingProduct.status = editingProduct.status === 'active' ? 'disabled' : 'active'" class="text-sm text-blue-600 font-bold">åˆ‡æ¢çŠ¶æ€</button>
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button @click="editingProduct = null" class="flex-1 py-3 bg-gray-100 rounded-xl font-medium">å–æ¶ˆ</button>
                <button @click="saveEditedProduct" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <div v-if="toastMsg" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-full text-sm font-medium z-[100] backdrop-blur transition-opacity">
        {{ toastMsg }}
    </div>

</div>

<script>
    const { createClient } = supabase;

    // ğŸ‘‰ å¿…å¡«é…ç½®
    const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE'; // âš ï¸ åœ¨è¿™é‡Œå¡«å…¥ Supabase Anon Key

    const app = Vue.createApp({
        data() {
            return {
                sb: null,
                currentView: 'entry', // entry, cashier, manage, orders
                tabs: [
                    {id: 'entry', name: 'å…¥åº“', icon: 'ph-plus-circle'},
                    {id: 'cashier', name: 'æ”¶é“¶', icon: 'ph-cash-register'},
                    {id: 'manage', name: 'ç®¡ç†', icon: 'ph-archive'},
                    {id: 'orders', name: 'è®¢å•', icon: 'ph-receipt'}
                ],
                
                // æ•°æ®çŠ¶æ€
                products: [],
                orders: [],
                cart: [],
                
                // å½•å…¥è¡¨å•
                entryForm: { barcode: '', name: '', wholesale_price: '', retail_price: '' },
                lastAddedProduct: null,
                
                // æ”¶é“¶çŠ¶æ€
                priceMode: 'retail', // retail, wholesale
                searchQuery: '',
                
                // UI çŠ¶æ€
                showPaymentModal: false,
                editingProduct: null,
                manageSearch: '',
                toastMsg: '',
                isOnline: navigator.onLine,
                
                // æ‰«æç›¸å…³
                scanner: null,
                scanning: false,
                cameraMount: false, // æ§åˆ¶ Video å®¹å™¨ DOM å­˜åœ¨ä¸å¦
                scanLock: false,
                scanMode: '', // entry, cashier
                audioCtx: null,
            }
        },
        computed: {
            pageTitle() {
                return this.tabs.find(t => t.id === this.currentView)?.name || '';
            },
            isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            },
            filteredProducts() {
                if(!this.manageSearch) return this.products;
                const q = this.manageSearch.toLowerCase();
                return this.products.filter(p => p.name.toLowerCase().includes(q) || p.barcode.includes(q));
            },
            cartTotalQty() {
                return this.cart.reduce((sum, item) => sum + item.quantity, 0);
            },
            cartTotalPrice() {
                return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0).toFixed(2);
            }
        },
        watch: {
            searchQuery(val) {
                if(!val) return;
                // ç®€å•çš„é˜²æŠ–æœç´¢
                if(this.searchTimer) clearTimeout(this.searchTimer);
                this.searchTimer = setTimeout(() => {
                   this.handleSearchInput(val);
                }, 300);
            }
        },
        async mounted() {
            this.sb = createClient(SUPABASE_URL, SUPABASE_KEY);
            this.initAudio();
            await this.loadInitialData();
            
            // é”®ç›˜ç›‘å¬ï¼ˆæ‰«ç æªæ”¯æŒï¼‰
            window.addEventListener('keydown', this.handleGlobalKeydown);
            window.addEventListener('online', () => { this.isOnline = true; this.syncData(); });
            window.addEventListener('offline', () => this.isOnline = false);
            
            // è‡ªåŠ¨èšç„¦
            this.autoFocus();
        },
        methods: {
            // --- æ ¸å¿ƒé€»è¾‘ ---
            async loadInitialData() {
                // ä¼˜å…ˆä» LocalStorage åŠ è½½ä»¥æé«˜é€Ÿåº¦
                const localProds = localStorage.getItem('products');
                if(localProds) this.products = JSON.parse(localProds);
                
                if(this.isOnline) {
                    const { data } = await this.sb.from('products').select('*').order('created_at', {ascending: false});
                    if(data) {
                        this.products = data;
                        localStorage.setItem('products', JSON.stringify(data));
                    }
                    
                    const { data: ords } = await this.sb.from('orders').select('*').order('created_at', {ascending: false}).limit(50);
                    if(ords) this.orders = ords;
                }
            },
            
            switchTab(id) {
                if (this.scanning) this.stopScanner();
                this.currentView = id;
                this.autoFocus();
            },

            // --- æ‰«æä¸æ‘„åƒå¤´ (ä¿®å¤é»‘å±çš„å…³é”®é€»è¾‘) ---
            async toggleScanner(mode) {
                if (this.scanning) {
                    await this.stopScanner();
                } else {
                    this.scanMode = mode;
                    this.scanning = true;
                    this.cameraMount = false; // å…ˆå¸è½½ DOM
                    await this.$nextTick(); // ç­‰å¾…å¸è½½å®Œæˆ
                    this.cameraMount = true; // é‡æ–°æŒ‚è½½ DOM
                    await this.$nextTick(); // ç­‰å¾…æŒ‚è½½å®Œæˆ
                    
                    // å»¶è¿Ÿä¸€ç‚¹å¯åŠ¨ï¼Œç»™ DOM æ¸²æŸ“æ—¶é—´
                    setTimeout(() => this.startScanner(), 50);
                }
            },
            
            startScanner() {
                const elementId = this.scanMode === 'entry' ? 'reader' : 'reader-cashier';
                if (!document.getElementById(elementId)) return;

                this.scanner = new Html5Qrcode(elementId);
                const config = { 
                    fps: 15, 
                    qrbox: { width: 250, height: 150 }, 
                    aspectRatio: 1.0,
                    useBarCodeDetectorIfSupported: true 
                };
                
                this.scanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    this.onScanSuccess,
                    (err) => { /* ignore errors */ }
                ).catch(err => {
                    console.error("Camera start failed", err);
                    this.showToast("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™");
                    this.scanning = false;
                });
            },
            
            async stopScanner() {
                if (this.scanner) {
                    try {
                        await this.scanner.stop();
                        this.scanner.clear();
                    } catch (e) { console.log(e); }
                    this.scanner = null;
                }
                this.scanning = false;
                this.cameraMount = false; // å½»åº•é”€æ¯ DOM èŠ‚ç‚¹
            },
            
            onScanSuccess(decodedText) {
                if (this.scanLock) return;
                this.scanLock = true;
                this.playBeep();
                
                // 500ms é”å®šé˜²æ­¢é‡å¤
                setTimeout(() => { this.scanLock = false; }, 500);

                if (this.scanMode === 'entry') {
                    // å…¥åº“æ¨¡å¼ï¼šå¡«å…¥æ¡ç å¹¶æš‚åœæ‰«ç ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ä»·æ ¼
                    this.entryForm.barcode = decodedText;
                    this.stopScanner(); // æˆåŠŸå³åœ
                    this.showToast("æ‰«ç æˆåŠŸï¼Œè¯·è¡¥å…¨ä¿¡æ¯");
                } else {
                    // æ”¶é“¶æ¨¡å¼ï¼šç›´æ¥åŠ è´­
                    this.addToCartByBarcode(decodedText);
                    // æ”¶é“¶æ¨¡å¼å¯ä»¥é€‰æ‹©ä¸å…³æ‘„åƒå¤´ï¼Œæˆ–è€…ä¸ºäº†ç¨³å¦¥ä¹Ÿå…ˆå…³ä¸€ä¸‹ï¼ˆè¿™é‡Œé€‰æ‹©ä¸å…³ï¼Œä¸ºäº†è¿ç»­æ‰«ï¼‰
                    // è‹¥éœ€è¦é˜²æŠ–ï¼ŒscanLock å·²ç»å¤„ç†äº†
                }
            },

            // --- æ‰«ç æªä¸é”®ç›˜æ”¯æŒ ---
            handleGlobalKeydown(e) {
                // ç®€å•çš„é€»è¾‘ï¼šå¦‚æœæ˜¯ Enter ä¸”è¾“å…¥æ¡†æœ‰ç„¦ç‚¹ï¼Œåˆ™è§¦å‘æœç´¢/ä¿å­˜
                // æ›´å¤æ‚çš„æ‰«ç æªé€»è¾‘é€šå¸¸åŸºäºè¾“å…¥é€Ÿåº¦ï¼Œè¿™é‡Œç®€åŒ–ä¸º Input æ¡†ç›‘å¬
                if (e.key === 'Enter') {
                    // å¦‚æœåœ¨å½•å…¥é¡µ
                    if (this.currentView === 'entry' && this.entryForm.barcode) {
                        // èšç„¦åˆ°åç§°æˆ–ä»·æ ¼ï¼Ÿè¿™é‡Œç®€åŒ–ï¼Œä¸åšè¿‡å¤šè·³è½¬
                    }
                }
            },

            // --- éŸ³æ•ˆ ---
            initAudio() {
                // Base64 çŸ­ä¿ƒæ»´å£°
                this.beepSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"); // å ä½ï¼Œéœ€æ›¿æ¢çœŸå® Base64
                // ç”±äº Base64 å¤ªé•¿ï¼Œä½¿ç”¨ç®€å•æŒ¯åŠ¨ä»£æ›¿å…œåº•
            },
            playBeep() {
                if(navigator.vibrate) navigator.vibrate(50);
                // ç®€å•çš„ Audio Context ç”Ÿæˆ beepï¼Œæ— éœ€å¤–éƒ¨æ–‡ä»¶
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 1500;
                gain.gain.value = 0.1;
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            },

            // --- ä¸šåŠ¡é€»è¾‘ï¼šå•†å“å½•å…¥ ---
            async saveProduct() {
                if (!this.entryForm.barcode) return this.showToast("è¯·è¾“å…¥æ¡ç ");
                
                // ç”Ÿæˆåç§°
                let finalName = this.entryForm.name || `æœªå‘½åå•†å“`;
                // æ£€æŸ¥é‡å¤åç§°å¹¶è¿½åŠ åºå·é€»è¾‘ç•¥å»ï¼ŒSupabase æ— åä¹Ÿè¡Œ
                
                const newProd = {
                    barcode: this.entryForm.barcode,
                    name: finalName,
                    wholesale_price: parseFloat(this.entryForm.wholesale_price) || 0,
                    retail_price: parseFloat(this.entryForm.retail_price) || 0,
                    status: 'active'
                };

                // ä¿å­˜åˆ° Supabase
                if(this.isOnline) {
                    const { error } = await this.sb.from('products').upsert(newProd, { onConflict: 'barcode' });
                    if(error) return this.showToast("ä¿å­˜å¤±è´¥: " + error.message);
                } else {
                    // ç¦»çº¿æš‚å­˜é€»è¾‘ (ç®€åŒ–ï¼šç›´æ¥æ›´æœ¬åœ°æ•°ç»„)
                }

                // æ›´æ–°æœ¬åœ°
                const idx = this.products.findIndex(p => p.barcode === newProd.barcode);
                if(idx >= 0) this.products[idx] = { ...this.products[idx], ...newProd };
                else this.products.unshift(newProd); // åŠ åˆ°æœ€å‰
                
                localStorage.setItem('products', JSON.stringify(this.products));
                
                this.lastAddedProduct = { ...newProd };
                this.showToast("å½•å…¥æˆåŠŸ");
                
                // é‡ç½®è¡¨å•ä½†ä¿ç•™èšç„¦
                this.entryForm = { barcode: '', name: '', wholesale_price: '', retail_price: '' };
                
                // PC ç«¯è‡ªåŠ¨èšç„¦å›æ¡ç æ¡†
                this.autoFocus(); 
                
                // æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ˜¯è¿ç»­æ‰«ç æ¨¡å¼ï¼Œè¿™é‡Œé‡å¯ Scanner
                // æ ¹æ®éœ€æ±‚ï¼Œç”¨æˆ·ç‚¹å‡»â€œç¡®è®¤å¹¶ç»§ç»­â€åï¼Œåº”è¯¥é‡æ–°å¼€å¯æ‰«ç 
                // this.toggleScanner('entry'); // å¯é€‰ï¼šå¦‚æœä½ å¸Œæœ›ç‚¹ä¿å­˜åè‡ªåŠ¨å¼¹æ‘„åƒå¤´ï¼Œè§£å¼€æ­¤è¡Œ
            },

            // --- ä¸šåŠ¡é€»è¾‘ï¼šæ”¶é“¶ ---
            handleSearchInput(val) {
                // å°è¯•ç²¾ç¡®åŒ¹é…æ¡ç 
                const prod = this.products.find(p => p.barcode === val);
                if(prod) {
                    this.addToCart(prod);
                    this.searchQuery = ''; // æ¸…ç©º
                }
            },
            handleSearchEnter() {
                this.handleSearchInput(this.searchQuery);
            },
            addToCartByBarcode(code) {
                const prod = this.products.find(p => p.barcode === code);
                if (prod) {
                    this.addToCart(prod);
                    this.showToast(`å·²æ·»åŠ : ${prod.name}`);
                } else {
                    // æœªæ‰¾åˆ°å•†å“ï¼Œæ˜¯å¦æç¤ºå»å½•å…¥ï¼Ÿ
                    this.showToast("æœªæ‰¾åˆ°å•†å“ï¼Œè¯·å…ˆå½•å…¥");
                    // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            },
            addToCart(prod) {
                if(prod.status !== 'active') return this.showToast("å•†å“å·²åœç”¨");
                
                const existing = this.cart.find(i => i.barcode === prod.barcode);
                if (existing) {
                    existing.quantity++;
                } else {
                    const unitPrice = this.priceMode === 'retail' ? prod.retail_price : prod.wholesale_price;
                    this.cart.unshift({
                        tempId: Date.now().toString() + Math.floor(Math.random() * 1000), // Polyfill UUID
                        product_id: prod.id, // å¯èƒ½ä¸ºç©ºå¦‚æœç¦»çº¿ä¸”æœªåŒæ­¥ï¼Œä½†è¿™ä¸å½±å“UI
                        name: prod.name,
                        barcode: prod.barcode,
                        unit_price: unitPrice,
                        original_price: unitPrice, // ç”¨äºæ˜¾ç¤ºæ˜¯å¦æ”¹ä»·
                        quantity: 1
                    });
                }
            },
            updateQty(index, delta) {
                const item = this.cart[index];
                item.quantity += delta;
                if(item.quantity <= 0) this.cart.splice(index, 1);
            },
            clearCart() {
                if(confirm("ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ")) this.cart = [];
            },
            
            // --- ç»“ç®— ---
            prepareCheckout() {
                this.showPaymentModal = true;
            },
            async completeOrder(method) {
                const orderData = {
                    total_price: this.cartTotalPrice,
                    total_quantity: this.cartTotalQty,
                    price_type: this.priceMode,
                    payment_method: method,
                    status: 'completed',
                    created_at: new Date().toISOString()
                };

                // ä¹è§‚æ›´æ–° UI
                this.orders.unshift({ id: 'Loading...', ...orderData });
                this.showPaymentModal = false;
                const currentCart = [...this.cart]; // æ­¤æ—¶çš„å¿«ç…§
                this.cart = []; // æ¸…ç©º

                if(this.isOnline) {
                    // 1. åˆ›å»º Order
                    const { data: orderRes, error } = await this.sb.from('orders').insert(orderData).select().single();
                    if(error) {
                        this.showToast("è®¢å•ä¿å­˜å¤±è´¥");
                        return;
                    }
                    
                    // 2. åˆ›å»º Items
                    const itemsData = currentCart.map(i => ({
                        order_id: orderRes.id,
                        product_id: i.product_id, // æ³¨æ„ï¼šå¦‚æœæ˜¯çº¯ç¦»çº¿æ–°å»ºçš„å•†å“å¯èƒ½æ²¡æœ‰ IDï¼Œéœ€å¤„ç†
                        product_name: i.name,
                        barcode: i.barcode,
                        unit_price: i.unit_price,
                        quantity: i.quantity,
                        subtotal: i.unit_price * i.quantity
                    }));
                    await this.sb.from('order_items').insert(itemsData);
                    
                    // æ›´æ–°æœ¬åœ°åˆ—è¡¨ ID
                    this.orders[0] = orderRes;
                } else {
                    // ç¦»çº¿å­˜å‚¨è®¢å•é€»è¾‘ (å­˜å…¥ LocalStorage å¾…åŒæ­¥)
                    const offlineOrders = JSON.parse(localStorage.getItem('offline_orders') || '[]');
                    offlineOrders.push({ order: orderData, items: currentCart });
                    localStorage.setItem('offline_orders', JSON.stringify(offlineOrders));
                    this.orders[0].id = 'Offline-' + Date.now();
                }
                
                this.showToast("æ”¶æ¬¾æˆåŠŸï¼");
                // èšç„¦å›æ‰«ææ¡†ä»¥ä¾¿ä¸‹ä¸€å•
                if (!this.isMobile) this.autoFocus();
            },

            // --- æ‚é¡¹ ---
            autoFocus() {
                // PC ç«¯è‡ªåŠ¨èšç„¦é€»è¾‘
                if (this.isMobile) return;
                
                this.$nextTick(() => {
                    if (this.currentView === 'entry') this.$refs.entryBarcode?.focus();
                    if (this.currentView === 'cashier') this.$refs.cashierInput?.focus();
                });
            },
            showToast(msg) {
                this.toastMsg = msg;
                setTimeout(() => this.toastMsg = '', 2000);
            },
            formatDate(str) {
                if(!str) return '';
                return new Date(str).toLocaleString();
            },
            
            // --- å¯¼å…¥å¯¼å‡º (Excel) ---
            exportData() {
                const ws = XLSX.utils.json_to_sheet(this.products);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, "products_backup.xlsx");
            },
            importData(e) {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, {type:'binary'});
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);
                    
                    // ç®€å•åˆå¹¶é€»è¾‘
                    data.forEach(row => {
                         // å¿…é¡»ç”± barcode
                         if(row.barcode) {
                             const newP = {
                                 barcode: String(row.barcode),
                                 name: row.name || 'å¯¼å…¥å•†å“',
                                 wholesale_price: row.wholesale_price || 0,
                                 retail_price: row.retail_price || 0,
                                 status: 'active'
                             };
                             // Upsert Local & Remote
                             const idx = this.products.findIndex(p => p.barcode === newP.barcode);
                             if(idx >= 0) this.products[idx] = { ...this.products[idx], ...newP };
                             else this.products.push(newP);
                             
                             if(this.isOnline) this.sb.from('products').upsert(newP, {onConflict: 'barcode'}).then();
                         }
                    });
                    this.showToast(`å¯¼å…¥ ${data.length} æ¡æ•°æ®`);
                };
                reader.readAsBinaryString(file);
            },
            
            // --- ç®¡ç† ---
            openEditModal(p) {
                this.editingProduct = JSON.parse(JSON.stringify(p));
            },
            async saveEditedProduct() {
                const p = this.editingProduct;
                if(this.isOnline) {
                    await this.sb.from('products').update({
                        name: p.name, wholesale_price: p.wholesale_price, retail_price: p.retail_price, status: p.status
                    }).eq('id', p.id);
                }
                // Update Local
                const idx = this.products.findIndex(x => x.id === p.id);
                if(idx >= 0) this.products[idx] = p;
                
                this.editingProduct = null;
                this.showToast("ä¿®æ”¹å·²ä¿å­˜");
            },
            async voidOrder(order) {
                if(!confirm("ç¡®å®šä½œåºŸæ­¤è®¢å•ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚")) return;
                if(this.isOnline) {
                    await this.sb.from('orders').update({ status: 'void' }).eq('id', order.id);
                }
                order.status = 'void';
            }
        }
    }).mount('#app');
</script>

<style>
    /* é¢å¤–çš„åŠ¨ç”»å…³é”®å¸§ */
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>
</body>
</html>

