<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€æ”¶é“¶ Pro</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .scan-region { position: relative; width: 100%; height: 280px; background: #000; overflow: hidden; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        /* éšè— html5-qrcode é»˜è®¤çš„ UI */
        #reader button { display: none; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; }
        /* åˆ—è¡¨æ»šåŠ¨æ¡éšè— */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800">

    <div id="app" class="flex flex-col h-full">
        
        <header class="bg-white shadow-sm z-20 flex-none">
            <div class="flex justify-between items-center p-4">
                <h1 class="text-lg font-bold flex items-center gap-2">
                    <i class="ri-store-2-line text-blue-600"></i> æç®€æ”¶é“¶ Pro
                </h1>
                <div class="flex gap-2">
                    <span class="text-xs px-2 py-1 rounded bg-green-100 text-green-700" v-if="isOnline">åœ¨çº¿</span>
                    <span class="text-xs px-2 py-1 rounded bg-red-100 text-red-700" v-else>ç¦»çº¿</span>
                </div>
            </div>
            <nav class="flex border-b border-gray-200">
                <button @click="switchTab('entry')" :class="['flex-1 py-3 text-sm font-medium transition-colors', currentTab === 'entry' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500']">
                    å•†å“å½•å…¥
                </button>
                <button @click="switchTab('manage')" :class="['flex-1 py-3 text-sm font-medium transition-colors', currentTab === 'manage' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500']">
                    å•†å“ç®¡ç†
                </button>
                <button @click="switchTab('pos')" :class="['flex-1 py-3 text-sm font-medium transition-colors', currentTab === 'pos' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500']">
                    æ”¶é“¶å°
                </button>
                <button @click="switchTab('orders')" :class="['flex-1 py-3 text-sm font-medium transition-colors', currentTab === 'orders' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500']">
                    è®¢å•
                </button>
            </nav>
        </header>

        <main class="flex-1 overflow-hidden relative bg-gray-50">
            
            <div v-show="currentTab === 'entry'" class="h-full flex flex-col">
                <div class="scan-region flex-none" v-if="cameraActive">
                    <div id="reader-entry"></div>
                    <div class="absolute inset-0 border-2 border-blue-400 opacity-50 pointer-events-none z-10 m-auto" style="width: 70%; height: 50%;"></div>
                    <p class="absolute bottom-4 w-full text-center text-white text-sm z-10 drop-shadow">{{ scanTip }}</p>
                </div>
                <div v-else class="h-64 bg-gray-800 flex items-center justify-center text-white flex-col gap-2">
                    <i class="ri-camera-off-line text-3xl"></i>
                    <span>æ‘„åƒå¤´å·²å…³é—­</span>
                    <button @click="startScanner('entry')" class="mt-2 px-4 py-1 bg-blue-600 rounded text-sm">ç‚¹å‡»å¼€å¯</button>
                </div>

                <div class="p-4 flex-1 overflow-y-auto">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="font-bold mb-4 text-gray-700">åˆšåˆšå½•å…¥</h3>
                        <div v-if="lastAddedProduct" class="border-l-4 border-green-500 pl-3 py-2 bg-green-50">
                            <p class="font-bold text-lg">{{ lastAddedProduct.name }}</p>
                            <p class="text-sm text-gray-500">æ¡ç : {{ lastAddedProduct.barcode }}</p>
                            <div class="flex gap-4 mt-1 text-sm">
                                <span>æ‰¹: <span class="font-bold">Â¥{{ lastAddedProduct.wholesale_price }}</span></span>
                                <span>é›¶: <span class="font-bold text-blue-600">Â¥{{ lastAddedProduct.retail_price }}</span></span>
                            </div>
                        </div>
                        <p v-else class="text-gray-400 text-center py-4">æš‚æ— æ–°å½•å…¥æ•°æ®</p>
                    </div>
                    
                    <div class="mt-4 text-center">
                         <input type="text" v-model="manualBarcodeInput" placeholder="æ‰«ç å¤±è´¥ï¼Ÿåœ¨æ­¤æ‰‹åŠ¨è¾“å…¥æ¡ç " 
                            class="w-full p-3 border rounded mb-2 text-center text-lg" @keyup.enter="handleManualInput('entry')">
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'manage'" class="h-full flex flex-col">
                <div class="p-2 bg-white flex justify-between items-center shadow-sm">
                    <input v-model="searchQuery" type="text" placeholder="æœç´¢å•†å“åç§°æˆ–æ¡ç " class="bg-gray-100 p-2 rounded w-1/2 text-sm">
                    <div class="flex gap-2">
                        <button @click="exportToExcel" class="px-3 py-2 bg-green-100 text-green-700 rounded text-xs font-bold flex items-center gap-1">
                            <i class="ri-file-excel-2-line"></i> å¯¼å‡º
                        </button>
                        <label class="px-3 py-2 bg-blue-100 text-blue-700 rounded text-xs font-bold flex items-center gap-1 cursor-pointer">
                            <i class="ri-upload-2-line"></i> å¯¼å…¥
                            <input type="file" @change="importFromExcel" accept=".xlsx,.xls" class="hidden">
                        </label>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-2">
                    <div v-for="product in filteredProducts" :key="product.id" :class="['bg-white mb-2 p-3 rounded shadow-sm border-l-4', product.status === 'active' ? 'border-blue-500' : 'border-gray-300 bg-gray-100']">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">{{ product.name || 'æœªå‘½åå•†å“' }}</h3>
                                <p class="text-gray-500 text-sm font-mono">{{ product.barcode }}</p>
                            </div>
                            <button @click="toggleProductStatus(product)" :class="['text-xs px-2 py-1 rounded', product.status === 'active' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600']">
                                {{ product.status === 'active' ? 'åœç”¨' : 'å¯ç”¨' }}
                            </button>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                            <label class="flex flex-col">
                                <span class="text-xs text-gray-400">æ‰¹å‘ä»·</span>
                                <input type="number" v-model="product.wholesale_price" @change="updateProduct(product)" class="border-b p-1">
                            </label>
                            <label class="flex flex-col">
                                <span class="text-xs text-gray-400">é›¶å”®ä»·</span>
                                <input type="number" v-model="product.retail_price" @change="updateProduct(product)" class="border-b p-1">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'pos'" class="h-full flex flex-col">
                <div class="bg-white p-2 flex gap-2 shadow-sm z-10">
                    <button @click="priceMode = 'wholesale'" :class="['flex-1 py-2 rounded text-sm font-bold border transition', priceMode === 'wholesale' ? 'bg-purple-600 text-white border-purple-600' : 'text-gray-600 border-gray-300']">
                        æ‰¹å‘ä»·æ¨¡å¼
                    </button>
                    <button @click="priceMode = 'retail'" :class="['flex-1 py-2 rounded text-sm font-bold border transition', priceMode === 'retail' ? 'bg-blue-600 text-white border-blue-600' : 'text-gray-600 border-gray-300']">
                        é›¶å”®ä»·æ¨¡å¼
                    </button>
                </div>

                <div class="scan-region flex-none" v-if="cameraActive && currentTab === 'pos'">
                    <div id="reader-pos"></div>
                    <div class="absolute inset-0 border-2 border-red-400 opacity-50 pointer-events-none z-10 m-auto" style="width: 70%; height: 50%;"></div>
                    <p class="absolute bottom-4 w-full text-center text-white text-sm z-10 drop-shadow">{{ scanTip }}</p>
                </div>
                
                <div class="bg-gray-100 p-2">
                     <input type="text" v-model="manualBarcodeInput" placeholder="ğŸ” æ‰«ç æˆ–è¾“å…¥å•†å“å/æ¡ç " 
                            class="w-full p-2 border rounded text-center" @keyup.enter="handleManualInput('pos')">
                </div>

                <div class="flex-1 overflow-y-auto p-2 pb-20">
                    <div v-if="cart.length === 0" class="h-full flex items-center justify-center text-gray-400 flex-col">
                        <i class="ri-shopping-cart-2-line text-4xl mb-2"></i>
                        <p>è¯·æ‰«ç æˆ–æ·»åŠ å•†å“</p>
                    </div>
                    <div v-for="(item, index) in cart" :key="index" class="bg-white p-3 rounded mb-2 shadow-sm flex flex-col gap-2">
                        <div class="flex justify-between">
                            <h4 class="font-bold">{{ item.name }}</h4>
                            <span class="font-mono text-gray-500 text-xs">{{ item.barcode }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">å•ä»·:</span>
                                <input type="number" v-model="item.unit_price" class="w-20 border-b p-1 text-center font-bold text-blue-600">
                            </div>
                            <div class="flex items-center gap-3 bg-gray-100 rounded-full px-2 py-1">
                                <button @click="updateCartQty(index, -1)" class="w-6 h-6 rounded-full bg-white shadow text-gray-600 flex items-center justify-center font-bold">-</button>
                                <span class="font-bold w-4 text-center">{{ item.quantity }}</span>
                                <button @click="updateCartQty(index, 1)" class="w-6 h-6 rounded-full bg-white shadow text-blue-600 flex items-center justify-center font-bold">+</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center border-t pt-2 mt-1">
                            <span class="font-bold text-lg">Â¥{{ (item.unit_price * item.quantity).toFixed(2) }}</span>
                            <button @click="removeFromCart(index)" class="text-red-500 text-sm">åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-0 w-full bg-white border-t p-3 shadow-lg z-20">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-500">æ•°é‡: {{ cartTotalQty }}</span>
                        <button @click="clearCart" class="text-red-500 text-xs underline">æ¸…ç©º</button>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <p class="text-xs text-gray-500">æ€»è®¡</p>
                            <p class="text-2xl font-bold text-red-600">Â¥{{ cartTotalAmount.toFixed(2) }}</p>
                        </div>
                        <button @click="showCheckoutModal = true" :disabled="cart.length === 0" class="bg-blue-600 disabled:bg-gray-400 text-white px-8 rounded-lg font-bold shadow-lg active:scale-95 transition-transform">
                            å»ç»“ç®—
                        </button>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'orders'" class="h-full flex flex-col">
                <div class="p-4 bg-white shadow-sm mb-2">
                    <h2 class="text-lg font-bold text-gray-800">ä»Šæ—¥æ¦‚è§ˆ</h2>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div class="bg-blue-50 p-3 rounded">
                            <p class="text-xs text-blue-500">ä»Šæ—¥é”€å”®é¢</p>
                            <p class="text-xl font-bold text-blue-700">Â¥{{ todayStats.sales.toFixed(2) }}</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded">
                            <p class="text-xs text-purple-500">ä»Šæ—¥è®¢å•æ•°</p>
                            <p class="text-xl font-bold text-purple-700">{{ todayStats.count }}</p>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-2">
                    <div v-for="order in orders" :key="order.id" class="bg-white p-3 rounded mb-2 shadow-sm border-l-4 border-gray-400 relative">
                        <div class="flex justify-between mb-1">
                            <span class="font-mono text-xs text-gray-500">{{ new Date(order.created_at).toLocaleString() }}</span>
                            <span :class="['text-xs px-2 rounded', order.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">
                                {{ order.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²ä½œåºŸ' }}
                            </span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="font-bold text-lg">Â¥{{ order.total_price }}</p>
                                <p class="text-xs text-gray-500">{{ order.payment_method }} | {{ order.price_type === 'retail'?'é›¶å”®':'æ‰¹å‘' }}</p>
                            </div>
                            <button v-if="order.status === 'completed'" @click="voidOrder(order)" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">ä½œåºŸè®¢å•</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <div v-if="showEntryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl animate-fade-in-up">
                <h3 class="text-lg font-bold mb-4">å½•å…¥å•†å“ä¿¡æ¯</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500">æ¡å½¢ç </label>
                        <input type="text" v-model="entryForm.barcode" class="w-full bg-gray-100 p-2 rounded font-mono text-lg" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">å•†å“åç§° (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)</label>
                        <input type="text" v-model="entryForm.name" placeholder="è¯·è¾“å…¥åç§°" class="w-full border p-2 rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">æ‰¹å‘ä»·</label>
                            <input type="number" v-model="entryForm.wholesale_price" class="w-full border p-2 rounded text-lg font-bold">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">é›¶å”®ä»·</label>
                            <input type="number" v-model="entryForm.retail_price" class="w-full border p-2 rounded text-lg font-bold text-blue-600">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="cancelEntry" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-lg">å–æ¶ˆ</button>
                    <button @click="saveProduct" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold shadow">ä¿å­˜å¹¶ç»§ç»­</button>
                </div>
            </div>
        </div>

        <div v-if="showCheckoutModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:w-96 p-6 rounded-t-xl sm:rounded-xl shadow-2xl">
                <h3 class="text-xl font-bold mb-4">æ”¶æ¬¾ç¡®è®¤</h3>
                <p class="text-3xl font-bold text-center mb-6 text-red-600">Â¥{{ cartTotalAmount.toFixed(2) }}</p>
                <p class="text-sm text-gray-500 mb-2">é€‰æ‹©æ”¯ä»˜æ–¹å¼ (ä»…è®°å½•)</p>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button @click="checkout('å¾®ä¿¡')" class="p-3 border rounded hover:bg-green-50 hover:border-green-500">å¾®ä¿¡æ”¯ä»˜</button>
                    <button @click="checkout('æ”¯ä»˜å®')" class="p-3 border rounded hover:bg-blue-50 hover:border-blue-500">æ”¯ä»˜å®</button>
                    <button @click="checkout('ç°é‡‘')" class="p-3 border rounded hover:bg-yellow-50 hover:border-yellow-500">ç°é‡‘</button>
                    <button @click="checkout('å…¶ä»–')" class="p-3 border rounded">å…¶ä»–</button>
                </div>
                <button @click="showCheckoutModal = false" class="w-full py-3 bg-gray-100 text-gray-600 rounded-lg">å–æ¶ˆ</button>
            </div>
        </div>

        <input type="text" id="global-scan-input" class="fixed top-0 left-0 opacity-0 h-0 w-0" autocomplete="off">

    </div>

    <script>
        const { createClient } = supabase;

        // âš ï¸ åœ¨è¿™é‡Œå¡«å†™ Supabase URL / anon key
        const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';

        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        const app = Vue.createApp({
            data() {
                return {
                    currentTab: 'entry',
                    isOnline: navigator.onLine,
                    cameraActive: false,
                    html5QrCode: null,
                    scanLock: false,
                    scanTip: 'æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...',
                    products: [], // æœ¬åœ°å•†å“ç¼“å­˜
                    orders: [],
                    
                    // å•†å“å½•å…¥
                    showEntryModal: false,
                    entryForm: { barcode: '', name: '', wholesale_price: '', retail_price: '' },
                    lastAddedProduct: null,

                    // æ”¶é“¶
                    priceMode: 'retail',
                    cart: [],
                    showCheckoutModal: false,
                    manualBarcodeInput: '',

                    // æœç´¢
                    searchQuery: '',

                    // æ‰«ç æªç¼“å†²åŒº
                    gunBuffer: '',
                    gunLastTime: 0,
                }
            },
            computed: {
                filteredProducts() {
                    const q = this.searchQuery.toLowerCase();
                    return this.products.filter(p => 
                        (p.name && p.name.toLowerCase().includes(q)) || 
                        (p.barcode && p.barcode.includes(q))
                    ).sort((a,b) => b.id - a.id);
                },
                cartTotalQty() {
                    return this.cart.reduce((acc, item) => acc + item.quantity, 0);
                },
                cartTotalAmount() {
                    return this.cart.reduce((acc, item) => acc + (item.unit_price * item.quantity), 0);
                },
                todayStats() {
                    const today = new Date().toDateString();
                    const todayOrders = this.orders.filter(o => 
                        new Date(o.created_at).toDateString() === today && o.status === 'completed'
                    );
                    return {
                        count: todayOrders.length,
                        sales: todayOrders.reduce((acc, o) => acc + o.total_price, 0)
                    }
                }
            },
            async mounted() {
                window.addEventListener('online', () => { this.isOnline = true; this.syncData(); });
                window.addEventListener('offline', () => this.isOnline = false);
                document.addEventListener('visibilitychange', this.handleVisibilityChange);
                
                // æ‰«ç æªå…¨å±€ç›‘å¬
                document.addEventListener('keydown', this.handleGunInput);

                await this.fetchProducts();
                await this.fetchOrders();
                
                // åˆå§‹å¯åŠ¨æ‘„åƒå¤´ï¼ˆå¦‚æœæ˜¯ entry æ¨¡å¼ï¼‰
                if(this.currentTab === 'entry') this.startScanner('entry');
            },
            methods: {
                // --- åŸºç¡€æ•°æ®é€»è¾‘ ---
                async fetchProducts() {
                    const local = localStorage.getItem('products');
                    if (local) this.products = JSON.parse(local);
                    
                    if (this.isOnline) {
                        const { data, error } = await sb.from('products').select('*');
                        if (!error && data) {
                            this.products = data;
                            localStorage.setItem('products', JSON.stringify(data));
                        }
                    }
                },
                async fetchOrders() {
                    if (!this.isOnline) return;
                    const { data, error } = await sb.from('orders').select('*').order('created_at', { ascending: false }).limit(50);
                    if (!error && data) this.orders = data;
                },
                async syncData() {
                    await this.fetchProducts();
                    // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„ç¦»çº¿è®¢å•ä¸Šä¼ é€»è¾‘ï¼Œæ­¤å¤„ç®€åŒ–
                },

                // --- é¡µé¢åˆ‡æ¢é€»è¾‘ ---
                async switchTab(tab) {
                    await this.stopScanner();
                    this.currentTab = tab;
                    this.manualBarcodeInput = '';
                    if (tab === 'entry' || tab === 'pos') {
                        setTimeout(() => this.startScanner(tab), 300);
                    }
                    if (tab === 'orders') {
                        this.fetchOrders();
                    }
                },
                handleVisibilityChange() {
                    if (document.hidden) {
                        this.stopScanner();
                    } else if (this.currentTab === 'entry' || this.currentTab === 'pos') {
                        // å›åˆ°é¡µé¢ä¸è‡ªåŠ¨é‡å¯æ‘„åƒå¤´ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’æˆ–æ˜¾å¼é€»è¾‘ï¼Œé¿å…å¡é¡¿
                        // ä½†æ ¹æ®éœ€æ±‚ï¼Œè¿™é‡Œæ¢å¤
                         this.startScanner(this.currentTab);
                    }
                },

                // --- æ‘„åƒå¤´ä¸æ‰«ç é€»è¾‘ ---
                async startScanner(mode) {
                    if (this.cameraActive || this.showEntryModal || this.showCheckoutModal) return;
                    
                    const elementId = mode === 'entry' ? 'reader-entry' : 'reader-pos';
                    // æ£€æŸ¥ DOM æ˜¯å¦å­˜åœ¨
                    if(!document.getElementById(elementId)) return;

                    this.scanTip = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
                    this.html5QrCode = new Html5Qrcode(elementId);
                    
                    const config = { fps: 10, qrbox: { width: 250, height: 150 } }; // çŸ©å½¢æ¡†é€‚åˆæ¡å½¢ç 
                    
                    try {
                        await this.html5QrCode.start(
                            { facingMode: { ideal: "environment" } },
                            config,
                            this.onScanSuccess,
                            this.onScanFailure
                        );
                        this.cameraActive = true;
                        this.scanTip = "å¯¹å‡†æ¡å½¢ç ";
                    } catch (err) {
                        console.error("Camera Error", err);
                        this.scanTip = "æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨æ‰«ç æªæˆ–æ‰‹åŠ¨è¾“å…¥";
                    }
                },
                async stopScanner() {
                    if (this.html5QrCode && this.html5QrCode.isScanning) {
                        try {
                            await this.html5QrCode.stop();
                            this.html5QrCode.clear();
                        } catch(e) {}
                    }
                    this.html5QrCode = null;
                    this.cameraActive = false;
                },
                onScanFailure(error) {
                    // ä¸å¤„ç†æ¯ä¸€å¸§çš„å¤±è´¥ï¼Œé¿å… console åˆ·å±
                },
                async onScanSuccess(decodedText) {
                    if (this.scanLock) return;
                    this.scanLock = true;
                    this.scanTip = "å·²è¯†åˆ«ï¼Œå¤„ç†ä¸­...";

                    // æ’­æ”¾æˆåŠŸæç¤ºéŸ³ (å¯é€‰)
                    // const audio = new Audio('beep.mp3'); audio.play().catch(()=>{});

                    // æš‚åœæ‰«ç æµ
                    if(this.html5QrCode) this.html5QrCode.pause();

                    await this.processBarcode(decodedText);

                    // 500ms åè§£é”
                    setTimeout(() => {
                        this.scanLock = false;
                        if(this.html5QrCode && this.cameraActive && !this.showEntryModal && !this.showCheckoutModal) {
                            this.html5QrCode.resume();
                            this.scanTip = "å¯¹å‡†æ¡å½¢ç ";
                        }
                    }, 500);
                },

                // --- æ‰«ç æªé€»è¾‘ ---
                handleGunInput(e) {
                    // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ï¼Œä¸æ‹¦æˆª
                    if (e.target.tagName === 'INPUT') return;

                    const now = Date.now();
                    if (now - this.gunLastTime > 100) {
                        this.gunBuffer = ''; // è¶…æ—¶é‡ç½®
                    }
                    this.gunLastTime = now;

                    if (e.key === 'Enter') {
                        if (this.gunBuffer.length >= 3) {
                            // åˆ¤å®šä¸ºæ‰«ç è¾“å…¥
                            this.processBarcode(this.gunBuffer);
                            this.gunBuffer = '';
                        }
                    } else if (e.key.length === 1) {
                        this.gunBuffer += e.key;
                    }
                },

                // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼šå¤„ç†æ¡ç  ---
                async processBarcode(code) {
                    // æ ¡éªŒ
                    if (!/^\d+$/.test(code) || code.length < 5) {
                        // æ— æ•ˆæ¡ç å¿½ç•¥
                        return;
                    }

                    if (this.currentTab === 'entry') {
                        // å½•å…¥æ¨¡å¼
                        this.stopScanner(); // å…³é—­æ‘„åƒå¤´æ˜¾ç¤ºå¼¹çª—
                        this.entryForm = { barcode: code, name: '', wholesale_price: '', retail_price: '' };
                        this.showEntryModal = true;
                    } else if (this.currentTab === 'pos') {
                        // æ”¶é“¶æ¨¡å¼
                        const product = this.products.find(p => p.barcode === code);
                        if (product) {
                            if (product.status !== 'active') {
                                alert('è¯¥å•†å“å·²åœç”¨');
                                return;
                            }
                            this.addToCart(product);
                        } else {
                            // æ²¡æ‰¾åˆ°å•†å“ï¼Œæç¤ºå½•å…¥? éœ€æ±‚æœªè¯´ï¼Œæ­¤å¤„ç®€ç•¥
                            alert('æœªæ‰¾åˆ°å•†å“ï¼Œè¯·å…ˆå½•å…¥');
                        }
                    }
                },

                // --- å•†å“å½•å…¥åŠŸèƒ½ ---
                cancelEntry() {
                    this.showEntryModal = false;
                    this.startScanner('entry');
                },
                generateName() {
                    let base = "æœªå‘½å";
                    let count = 0;
                    this.products.forEach(p => {
                        if (p.name && p.name.startsWith(base)) {
                            count++;
                        }
                    });
                    return count === 0 ? base : base + count;
                },
                async saveProduct() {
                    const form = this.entryForm;
                    if (!form.name) form.name = this.generateName();
                    
                    const newProduct = {
                        barcode: form.barcode,
                        name: form.name,
                        wholesale_price: parseFloat(form.wholesale_price) || 0,
                        retail_price: parseFloat(form.retail_price) || 0,
                        status: 'active'
                    };

                    // Optimistic update
                    this.products.unshift(newProduct);
                    this.lastAddedProduct = newProduct;

                    if (this.isOnline) {
                        const { error } = await sb.from('products').insert([newProduct]);
                        if (error) {
                            alert('ä¿å­˜å¤±è´¥ï¼Œæ¡ç å¯èƒ½é‡å¤');
                            this.products.shift(); // revert
                            return;
                        }
                    } else {
                        // ç¦»çº¿æš‚å­˜é€»è¾‘ (ç®€åŒ–ï¼šåªå­˜ localStorageï¼Œç­‰ä¸‹æ¬¡ load)
                        localStorage.setItem('products', JSON.stringify(this.products));
                    }

                    this.showEntryModal = false;
                    this.startScanner('entry');
                },
                handleManualInput(mode) {
                    if(this.manualBarcodeInput) {
                        this.processBarcode(this.manualBarcodeInput);
                        this.manualBarcodeInput = '';
                    }
                },

                // --- å•†å“ç®¡ç†åŠŸèƒ½ ---
                async toggleProductStatus(product) {
                    const newStatus = product.status === 'active' ? 'inactive' : 'active';
                    product.status = newStatus;
                    if (this.isOnline) {
                        await sb.from('products').update({ status: newStatus }).eq('id', product.id);
                    }
                },
                async updateProduct(product) {
                    if (this.isOnline) {
                        await sb.from('products').update({ 
                            wholesale_price: product.wholesale_price,
                            retail_price: product.retail_price
                        }).eq('id', product.id);
                    }
                },
                exportToExcel() {
                    const ws = XLSX.utils.json_to_sheet(this.products);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Products");
                    XLSX.writeFile(wb, "products_backup.xlsx");
                },
                importFromExcel(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, {type:'binary'});
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);
                        // ç®€å•å¤„ç†ï¼šå¾ªç¯æ’å…¥/æ›´æ–° (Upsert logic needs primary key, here strictly barcode)
                        // ä¸ºæ¼”ç¤ºç®€å•ï¼Œä»… console
                        alert(`è§£æäº† ${data.length} æ¡æ•°æ®ï¼Œå®é™…æ‰¹é‡å¯¼å…¥éœ€åç«¯æ”¯æŒ upsert`);
                    };
                    reader.readAsBinaryString(file);
                },

                // --- æ”¶é“¶åŠŸèƒ½ ---
                addToCart(product) {
                    const existing = this.cart.find(i => i.barcode === product.barcode);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.cart.push({
                            ...product,
                            product_id: product.id,
                            unit_price: this.priceMode === 'retail' ? product.retail_price : product.wholesale_price,
                            quantity: 1
                        });
                    }
                },
                updateCartQty(index, delta) {
                    const item = this.cart[index];
                    item.quantity += delta;
                    if (item.quantity <= 0) this.cart.splice(index, 1);
                },
                removeFromCart(index) {
                    this.cart.splice(index, 1);
                },
                clearCart() {
                    if (confirm('ç¡®è®¤æ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ')) {
                        this.cart = [];
                    }
                },
                async checkout(method) {
                    const orderData = {
                        total_price: this.cartTotalAmount,
                        total_quantity: this.cartTotalQty,
                        price_type: this.priceMode,
                        payment_method: method,
                        status: 'completed'
                    };

                    if (this.isOnline) {
                        // 1. Create Order
                        const { data: order, error } = await sb.from('orders').insert([orderData]).select().single();
                        
                        if (!error && order) {
                            // 2. Create Items
                            const items = this.cart.map(i => ({
                                order_id: order.id,
                                product_id: i.product_id, // Note: might be null if offline created
                                product_name: i.name,
                                barcode: i.barcode,
                                unit_price: i.unit_price,
                                quantity: i.quantity,
                                subtotal: i.unit_price * i.quantity
                            }));
                            await sb.from('order_items').insert(items);
                            
                            // 3. UI Update
                            this.orders.unshift({ ...orderData, id: order.id, created_at: new Date() });
                        }
                    } else {
                        // Offline order storage (omitted for brevity, just clearing cart)
                        alert('ç¦»çº¿æ¨¡å¼ï¼šè®¢å•å·²æš‚å­˜æœ¬åœ° (æ¨¡æ‹Ÿ)');
                    }

                    this.cart = [];
                    this.showCheckoutModal = false;
                },

                // --- è®¢å•ç®¡ç† ---
                async voidOrder(order) {
                    if(confirm('ç¡®è®¤ä½œåºŸæ­¤è®¢å•ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                        if(this.isOnline) {
                            const { error } = await sb.from('orders').update({ status: 'void' }).eq('id', order.id);
                            if(!error) order.status = 'void';
                        }
                    }
                }
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
