<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€æ”¶é“¶ Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* åŸºç¡€æ ·å¼ä¼˜åŒ– */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f1f5f9; user-select: none; }
        .scan-region { position: relative; width: 100%; height: 200px; overflow: hidden; background: #000; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; }
        
        /* éšè— html5-qrcode é»˜è®¤å…ƒç´  */
        #reader__dashboard_section_csr span, #reader__dashboard_section_swaplink { display: none !important; }
        
        /* ç´§å‡‘åˆ—è¡¨æ ·å¼ */
        .compact-list-item { padding: 0.5rem; border-bottom: 1px solid #e2e8f0; }
        .compact-list-item:last-child { border-bottom: none; }
        
        /* åŠ¨ç”» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ– */
        .scroll-smooth { -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col max-w-4xl mx-auto bg-white shadow-xl overflow-hidden relative">
    
    <audio ref="beepSound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//uQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWgAAAA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYaW5nAAAAEAAAAAEAAABwAADUAA==" style="display:none;"></audio>

    <nav class="flex justify-between bg-slate-800 text-white p-2 text-xs md:text-sm z-50 shrink-0">
        <button @click="switchTab('entry')" :class="{'bg-blue-600': currentTab==='entry'}" class="flex-1 py-3 rounded mx-1 transition active:scale-95 font-bold">ğŸ“· å•†å“å½•å…¥</button>
        <button @click="switchTab('manage')" :class="{'bg-blue-600': currentTab==='manage'}" class="flex-1 py-3 rounded mx-1 transition active:scale-95 font-bold">ğŸ“¦ ç®¡ç†</button>
        <button @click="switchTab('cashier')" :class="{'bg-emerald-600': currentTab==='cashier'}" class="flex-1 py-3 rounded mx-1 transition active:scale-95 font-bold">ğŸ’° æ”¶é“¶å°</button>
        <button @click="switchTab('orders')" :class="{'bg-blue-600': currentTab==='orders'}" class="flex-1 py-3 rounded mx-1 transition active:scale-95 font-bold">ğŸ“„ è®¢å•</button>
    </nav>

    <div v-if="currentTab === 'entry'" class="flex-1 flex flex-col overflow-hidden">
        <div class="h-[220px] bg-black shrink-0 relative flex flex-col items-center justify-center">
             <div v-if="scanning" id="reader" class="w-full h-full"></div>
             <div v-else class="text-white text-center p-4">
                 <p class="mb-2">æ‘„åƒå¤´å·²æš‚åœ</p>
                 <button @click="startScanner" class="bg-blue-600 px-6 py-2 rounded text-white font-bold">ç‚¹å‡»å¼€å¯æ‰«ç </button>
             </div>
             <div v-if="scanning" class="absolute inset-0 pointer-events-none border-2 border-white/30 flex items-center justify-center">
                 <div class="w-[280px] h-[150px] border-2 border-green-400 box-content shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]"></div>
                 <p class="absolute bottom-2 text-white text-xs bg-black/50 px-2 rounded">å¯¹å‡†æ¡å½¢ç </p>
             </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <div class="bg-white p-4 rounded shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 border-l-4 border-blue-600 pl-2">æ‰«ç ç»“æœå½•å…¥</h3>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">æ¡å½¢ç  (å¯æ‰‹åŠ¨ä¿®æ”¹)</label>
                        <input type="text" v-model="entryForm.barcode" id="barcodeInput" placeholder="æ‰«ææˆ–è¾“å…¥..." class="w-full p-3 border rounded text-lg font-mono focus:border-blue-500 outline-none transition bg-gray-50">
                    </div>

                    <div v-if="entryForm.barcode" class="animate-fade-in space-y-3">
                         <div>
                            <label class="block text-xs text-slate-500 mb-1">å•†å“åç§° (ä¸å¡«è‡ªåŠ¨ç”Ÿæˆ)</label>
                            <input type="text" v-model="entryForm.name" placeholder="ä¾‹å¦‚ï¼šå¯å£å¯ä¹ 330ml" class="w-full p-3 border rounded focus:border-blue-500 outline-none transition">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">æ‰¹å‘ä»·</label>
                                <input type="number" v-model="entryForm.wholesale_price" class="w-full p-3 border rounded font-bold text-blue-600 focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-500 mb-1">é›¶å”®ä»·</label>
                                <input type="number" v-model="entryForm.retail_price" class="w-full p-3 border rounded font-bold text-emerald-600 focus:border-blue-500 outline-none">
                            </div>
                        </div>
                        <button @click="saveProduct" class="w-full bg-blue-600 text-white py-4 rounded font-bold text-lg shadow-lg active:scale-95 transition mt-2">ç¡®è®¤å¹¶ç»§ç»­ (Enter)</button>
                        <button @click="clearEntry" class="w-full text-slate-400 py-2 text-sm">å–æ¶ˆ / æ¸…ç©º</button>
                    </div>
                    <div v-else class="text-center text-gray-400 py-4 text-sm">
                        â¬†ï¸ è¯·æ‰«ææ¡å½¢ç æˆ–æ‰‹åŠ¨è¾“å…¥
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h4 class="text-xs font-bold text-slate-400 mb-2 uppercase">åˆšåˆšå½•å…¥</h4>
                <div v-for="p in recentProducts" :key="p.id" class="bg-white p-3 rounded mb-2 flex justify-between items-center shadow-sm text-sm">
                    <span class="truncate w-1/2">{{ p.name }}</span>
                    <span class="font-mono text-xs text-gray-500">{{ p.barcode }}</span>
                    <span class="font-bold text-emerald-600">Â¥{{ p.retail_price }}</span>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'manage'" class="flex-1 flex flex-col overflow-hidden bg-slate-50">
        <div class="p-3 bg-white shadow-sm flex gap-2 shrink-0">
            <input type="text" v-model="searchQuery" id="manageInput" placeholder="ğŸ” æœç´¢å•†å“..." class="flex-1 p-2 border rounded text-sm outline-none focus:border-blue-500">
            <button @click="exportExcel" class="bg-green-600 text-white px-3 py-2 rounded text-xs">å¯¼å‡ºExcel</button>
            <label class="bg-blue-600 text-white px-3 py-2 rounded text-xs flex items-center cursor-pointer">
                å¯¼å…¥
                <input type="file" @change="importExcel" class="hidden" accept=".xlsx,.xls">
            </label>
        </div>
        <div class="flex-1 overflow-y-auto p-2">
            <div v-for="p in filteredProducts" :key="p.id" class="bg-white p-3 rounded shadow-sm mb-2 border-l-4" :class="p.status === 'active' ? 'border-blue-500' : 'border-gray-300'">
                <div class="flex justify-between items-start mb-2">
                    <input v-model="p.name" class="font-bold text-slate-800 border-b border-transparent focus:border-blue-300 outline-none w-2/3" placeholder="å•†å“å">
                    <span class="text-xs bg-gray-100 px-1 rounded font-mono">{{ p.barcode }}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="flex items-center">
                        <span class="text-xs text-gray-400 mr-1">æ‰¹å‘</span>
                        <input type="number" v-model="p.wholesale_price" class="w-full text-sm border rounded p-1 text-blue-600 font-bold">
                    </div>
                    <div class="flex items-center">
                        <span class="text-xs text-gray-400 mr-1">é›¶å”®</span>
                        <input type="number" v-model="p.retail_price" class="w-full text-sm border rounded p-1 text-emerald-600 font-bold">
                    </div>
                </div>
                <div class="flex justify-between items-center mt-1 pt-1 border-t border-gray-100">
                     <button @click="updateProduct(p)" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded">ä¿å­˜ä¿®æ”¹</button>
                     <button @click="toggleStatus(p)" class="text-xs px-3 py-1 rounded" :class="p.status==='active' ? 'text-red-500 bg-red-50' : 'text-green-500 bg-green-50'">
                        {{ p.status === 'active' ? 'åœç”¨' : 'å¯ç”¨' }}
                     </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'cashier'" class="flex-1 flex flex-col overflow-hidden h-full">
        <div class="bg-slate-800 p-2 flex justify-center shrink-0">
            <div class="bg-slate-700 p-1 rounded-lg flex text-xs">
                <button @click="priceMode = 'retail'" :class="priceMode === 'retail' ? 'bg-emerald-500 text-white shadow' : 'text-gray-300'" class="px-4 py-1.5 rounded transition">ğŸ›’ é›¶å”®ä»·æ¨¡å¼</button>
                <button @click="priceMode = 'wholesale'" :class="priceMode === 'wholesale' ? 'bg-blue-500 text-white shadow' : 'text-gray-300'" class="px-4 py-1.5 rounded transition">ğŸ­ æ‰¹å‘ä»·æ¨¡å¼</button>
            </div>
        </div>

        <div v-show="showCashierScanner" class="h-[180px] bg-black shrink-0 relative flex flex-col items-center justify-center transition-all">
             <div v-if="scanning" id="reader-cashier" class="w-full h-full"></div>
             <div v-if="scanning" class="absolute inset-0 pointer-events-none border-2 border-white/10 flex items-center justify-center">
                 <div class="w-[280px] h-[150px] border-2 border-emerald-400 box-content shadow-[0_0_0_9999px_rgba(0,0,0,0.6)]"></div>
             </div>
             <button @click="showCashierScanner = false; stopScanner()" class="absolute top-2 right-2 text-white bg-black/50 px-2 rounded z-20 text-xs">å…³é—­æ‘„åƒå¤´</button>
        </div>
        <div v-if="!showCashierScanner" class="p-2 bg-white border-b flex gap-2 shrink-0">
            <button @click="startCashierScanner" class="bg-emerald-600 text-white px-3 py-2 rounded shadow active:scale-95">ğŸ“· æ‰«ç </button>
            <input type="text" id="cashierInput" v-model="cashierQuery" @keyup.enter="manualAddToCart" placeholder="æ‰«ææˆ–è¾“å…¥æ¡ç /åç§°..." class="flex-1 border rounded px-3 outline-none focus:border-emerald-500">
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50 p-2">
            <div v-if="cart.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-50">
                <span class="text-4xl mb-2">ğŸ›’</span>
                <p>ç©ºç©ºå¦‚ä¹Ÿ</p>
            </div>
            <div v-else class="bg-white rounded shadow-sm overflow-hidden">
                <div v-for="(item, index) in cart" :key="index" class="compact-list-item flex flex-col">
                    <div class="flex justify-between w-full mb-1">
                        <span class="font-bold text-slate-700 truncate">{{ item.name }}</span>
                        <span class="font-mono text-xs text-gray-400">#{{ item.barcode }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <button @click="updateQty(index, -1)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold active:bg-slate-200">-</button>
                            <span class="w-6 text-center font-bold">{{ item.quantity }}</span>
                            <button @click="updateQty(index, 1)" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold active:bg-slate-200">+</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex flex-col items-end">
                                <input type="number" v-model="item.unit_price" class="w-16 text-right border-b border-dashed border-gray-300 text-sm font-bold text-emerald-600 focus:outline-none focus:border-emerald-500 bg-transparent">
                                <span class="text-xs text-gray-400">å°è®¡: Â¥{{ (item.unit_price * item.quantity).toFixed(2) }}</span>
                            </div>
                            <button @click="removeFromCart(index)" class="text-red-400 p-2">âœ•</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-3 border-t shadow-[0_-2px_10px_rgba(0,0,0,0.05)] shrink-0 z-20">
            <div class="flex justify-between items-end mb-3">
                <div class="text-xs text-slate-500">
                    å…± <span class="font-bold text-slate-800 text-base">{{ cartTotalQty }}</span> ä»¶
                    <button @click="clearCart" class="text-red-500 ml-2 underline">æ¸…ç©º</button>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400">åˆè®¡</div>
                    <div class="text-2xl font-black text-slate-800 leading-none">Â¥{{ cartTotalPrice.toFixed(2) }}</div>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2">
                 <button @click="checkout('cash')" class="bg-green-100 text-green-700 py-3 rounded font-bold text-sm active:scale-95">ğŸ’µ ç°é‡‘</button>
                 <button @click="checkout('wechat')" class="bg-green-500 text-white py-3 rounded font-bold text-sm active:scale-95">ğŸ’¬ å¾®ä¿¡</button>
                 <button @click="checkout('alipay')" class="bg-blue-500 text-white py-3 rounded font-bold text-sm active:scale-95">ğŸ’³ æ”¯ä»˜å®</button>
                 <button @click="checkout('other')" class="bg-slate-200 text-slate-600 py-3 rounded font-bold text-sm active:scale-95">å…¶å®ƒ</button>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'orders'" class="flex-1 flex flex-col overflow-hidden bg-slate-50">
        <div class="p-4 bg-white shadow-sm mb-2">
            <h2 class="font-bold text-lg text-slate-800">é”€å”®ç»Ÿè®¡</h2>
            <div class="flex justify-between mt-2">
                <div class="text-center w-1/2 border-r">
                    <div class="text-xs text-gray-400">ä»Šæ—¥é”€å”®é¢</div>
                    <div class="text-xl font-bold text-emerald-600">Â¥{{ todayStats.total }}</div>
                </div>
                 <div class="text-center w-1/2">
                    <div class="text-xs text-gray-400">ä»Šæ—¥è®¢å•æ•°</div>
                    <div class="text-xl font-bold text-blue-600">{{ todayStats.count }}</div>
                </div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2">
            <div v-for="order in sortedOrders" :key="order.id" class="bg-white p-3 rounded shadow-sm mb-2 border-l-4" :class="order.status === 'void' ? 'border-red-400 opacity-60' : 'border-emerald-500'">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="text-xs text-gray-400">{{ formatDate(order.created_at) }}</span>
                        <div class="font-bold text-slate-800">Â¥{{ order.total_price }} <span class="text-xs font-normal text-gray-500">({{ order.payment_method }})</span></div>
                    </div>
                    <div class="text-right">
                        <button v-if="order.status !== 'void'" @click="voidOrder(order)" class="text-xs text-red-500 border border-red-200 px-2 py-1 rounded">ä½œåºŸ</button>
                        <span v-else class="text-xs text-red-500 font-bold">å·²ä½œåºŸ</span>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t border-dashed border-gray-100 text-xs text-gray-500">
                    å…± {{ order.total_quantity }} ä»¶å•†å“ ({{ order.price_type === 'retail' ? 'é›¶å”®' : 'æ‰¹å‘' }})
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const { createClient } = supabase;

// âš ï¸ å¿…é¡»é…ç½®çš„ Supabase Key (æŒ‰ç”¨æˆ·è¦æ±‚å†™å…¥)
const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';

const app = Vue.createApp({
    data() {
        return {
            currentTab: 'entry',
            supabase: null,
            html5QrcodeScanner: null,
            scanning: false,
            scanLock: false,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            
            // æ•°æ®
            products: [],
            orders: [],
            recentProducts: [],
            
            // å½•å…¥è¡¨å•
            entryForm: { barcode: '', name: '', wholesale_price: '', retail_price: '' },
            
            // ç®¡ç†
            searchQuery: '',
            
            // æ”¶é“¶
            priceMode: 'retail',
            cart: [],
            cashierQuery: '',
            showCashierScanner: false,
        }
    },
    computed: {
        filteredProducts() {
            if (!this.searchQuery) return this.products;
            const lower = this.searchQuery.toLowerCase();
            return this.products.filter(p => 
                (p.name && p.name.toLowerCase().includes(lower)) || 
                p.barcode.includes(lower)
            );
        },
        cartTotalPrice() {
            return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
        },
        cartTotalQty() {
            return this.cart.reduce((sum, item) => sum + item.quantity, 0);
        },
        sortedOrders() {
            return [...this.orders].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        },
        todayStats() {
            const today = new Date().toDateString();
            const todayOrders = this.orders.filter(o => 
                o.status === 'completed' && new Date(o.created_at).toDateString() === today
            );
            return {
                count: todayOrders.length,
                total: todayOrders.reduce((sum, o) => sum + Number(o.total_price), 0).toFixed(2)
            };
        }
    },
    methods: {
        // --- æ ¸å¿ƒï¼šç³»ç»Ÿåˆå§‹åŒ– ---
        async initSystem() {
            this.supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            this.loadLocalData();
            await this.syncData();
            
            // æ‰«ç æªç›‘å¬
            document.addEventListener('keydown', this.handleGlobalKeydown);
            // é¡µé¢å¯è§æ€§ç›‘å¬
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) this.stopScanner();
            });
        },

        // --- æ ¸å¿ƒï¼šæ‰«ç é€»è¾‘ (é»‘å±ä¿®å¤ç‰ˆ) ---
        async startScanner() {
            if (this.scanning) return;
            
            // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨
            this.scanning = true;
            await this.$nextTick();

            const elementId = this.currentTab === 'entry' ? "reader" : "reader-cashier";
            if (!document.getElementById(elementId)) return;

            this.html5QrcodeScanner = new Html5Qrcode(elementId);
            
            const config = {
                fps: 15,
                qrbox: { width: 280, height: 150 },
                aspectRatio: 1.333333,
                useBarCodeDetectorIfSupported: true
            };

            try {
                await this.html5QrcodeScanner.start(
                    { facingMode: { ideal: "environment" } },
                    config,
                    this.onScanSuccess,
                    (err) => { /* å¿½ç•¥ç¬æ—¶é”™è¯¯ */ }
                );
            } catch (err) {
                console.error("Camera start failed", err);
                this.scanning = false;
            }
        },

        async stopScanner() {
            if (this.html5QrcodeScanner && this.html5QrcodeScanner.isScanning) {
                await this.html5QrcodeScanner.stop();
                this.html5QrcodeScanner.clear();
            }
            this.scanning = false;
        },
        
        // æ‰«ç æˆåŠŸå›è°ƒ
        onScanSuccess(decodedText) {
            if (this.scanLock) return;
            this.scanLock = true;
            
            this.playBeep();
            
            // è·¯ç”±é€»è¾‘
            if (this.currentTab === 'entry') {
                this.entryForm.barcode = decodedText;
                this.stopScanner(); // æš‚åœä»¥å¡«å†™ä¿¡æ¯
            } else if (this.currentTab === 'cashier') {
                this.addToCart(decodedText);
            }
            
            setTimeout(() => { this.scanLock = false; }, 500);
        },

        playBeep() {
            const audio = this.$refs.beepSound;
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Audio play blocked'));
            }
        },

        // --- åŠŸèƒ½ï¼šå•†å“å½•å…¥ ---
        async saveProduct() {
            if (!this.entryForm.barcode) return alert('ç¼ºå°‘æ¡ç ');
            
            const newId = Date.now().toString() + Math.floor(Math.random() * 1000);
            
            // è‡ªåŠ¨å‘½å
            let finalName = this.entryForm.name;
            if (!finalName) {
                const unnamedCount = this.products.filter(p => p.name && p.name.startsWith('æœªå‘½å')).length;
                finalName = unnamedCount === 0 ? 'æœªå‘½å' : `æœªå‘½å${unnamedCount}`;
            }

            const product = {
                id: newId,
                barcode: this.entryForm.barcode,
                name: finalName,
                wholesale_price: Number(this.entryForm.wholesale_price) || 0,
                retail_price: Number(this.entryForm.retail_price) || 0,
                status: 'active',
                created_at: new Date().toISOString()
            };

            // æœ¬åœ°ä¿å­˜
            const existingIdx = this.products.findIndex(p => p.barcode === product.barcode);
            if (existingIdx >= 0) {
                if(!confirm('æ¡ç å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–æ›´æ–°ï¼Ÿ')) return;
                this.products[existingIdx] = product;
            } else {
                this.products.unshift(product);
            }
            this.recentProducts.unshift(product);
            if(this.recentProducts.length > 3) this.recentProducts.pop();
            
            this.saveLocalData();
            this.syncProductToSupabase(product);

            // é‡ç½®å¹¶é‡å¯æ‰«ç  (é»‘å±ä¿®å¤æ ¸å¿ƒé€»è¾‘)
            this.clearEntry();
            
            if (this.isMobile) {
                // å½»åº•é”€æ¯å¹¶é‡å»º DOM ä»¥é˜²æ­¢é»‘å±
                await this.stopScanner();
                this.scanning = false;
                await this.$nextTick(); 
                this.scanning = true;
                await this.$nextTick();
                this.startScanner();
            } else {
                // PCç«¯èšç„¦
                this.$nextTick(() => document.getElementById('barcodeInput')?.focus());
            }
        },

        clearEntry() {
            this.entryForm = { barcode: '', name: '', wholesale_price: '', retail_price: '' };
        },

        // --- åŠŸèƒ½ï¼šæ”¶é“¶ ---
        startCashierScanner() {
            this.showCashierScanner = true;
            this.startScanner();
        },

        manualAddToCart() {
            if(!this.cashierQuery) return;
            this.addToCart(this.cashierQuery);
            this.cashierQuery = '';
        },

        addToCart(query) {
            const product = this.products.find(p => p.barcode === query || p.name === query);
            
            if (!product) {
                // å¦‚æœæ˜¯æ‰«ç ä¸”æœªæ‰¾åˆ°ï¼Œä¸æŠ¥é”™ï¼Œä»…è½»æç¤ºï¼ˆUIé€»è¾‘å·²ç®€åŒ–ï¼Œæ­¤å¤„ç•¥ï¼‰
                return;
            }
            if (product.status !== 'active') return alert('å•†å“å·²åœç”¨');

            const existing = this.cart.find(item => item.product_id === product.id);
            if (existing) {
                existing.quantity++;
            } else {
                this.cart.push({
                    product_id: product.id,
                    name: product.name,
                    barcode: product.barcode,
                    unit_price: this.priceMode === 'retail' ? product.retail_price : product.wholesale_price,
                    quantity: 1
                });
            }
        },

        updateQty(index, delta) {
            const item = this.cart[index];
            item.quantity += delta;
            if (item.quantity <= 0) this.cart.splice(index, 1);
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        clearCart() {
            if(confirm('ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦ï¼Ÿ')) this.cart = [];
        },

        async checkout(method) {
            if (this.cart.length === 0) return;
            
            const orderId = Date.now().toString() + Math.floor(Math.random() * 1000);
            const order = {
                id: orderId,
                total_price: this.cartTotalPrice,
                total_quantity: this.cartTotalQty,
                price_type: this.priceMode,
                payment_method: method,
                status: 'completed',
                created_at: new Date().toISOString()
            };

            const items = this.cart.map(item => ({
                order_id: orderId,
                product_id: item.product_id,
                product_name: item.name,
                barcode: item.barcode,
                unit_price: item.unit_price,
                quantity: item.quantity,
                subtotal: item.unit_price * item.quantity
            }));

            // æœ¬åœ°ä¿å­˜
            this.orders.unshift(order);
            this.saveLocalData();
            this.cart = [];
            this.showCashierScanner = false;
            this.stopScanner();
            
            // å¼‚æ­¥åŒæ­¥åˆ° Supabase
            this.syncOrderToSupabase(order, items);
        },

        // --- åŠŸèƒ½ï¼šç®¡ç† & è®¢å• ---
        async updateProduct(p) {
            this.saveLocalData();
            await this.syncProductToSupabase(p);
            alert('å·²ä¿å­˜');
        },

        toggleStatus(p) {
            p.status = p.status === 'active' ? 'inactive' : 'active';
            this.updateProduct(p);
        },

        async voidOrder(order) {
            if(!confirm('ç¡®å®šä½œåºŸæ­¤è®¢å•ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) return;
            order.status = 'void';
            this.saveLocalData();
            // åŒæ­¥æ›´æ–°
            const { error } = await this.supabase.from('orders').update({ status: 'void' }).eq('id', order.id);
        },

        // --- Excel ---
        exportExcel() {
            const ws = XLSX.utils.json_to_sheet(this.products);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Products");
            XLSX.writeFile(wb, "å•†å“åº“.xlsx");
        },

        importExcel(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, {type:'binary'});
                const wsname = wb.SheetNames[0];
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname]);
                
                let count = 0;
                data.forEach(row => {
                    if(row.barcode) {
                        const existing = this.products.find(p => p.barcode == row.barcode);
                        if(existing) {
                            Object.assign(existing, row); // æ›´æ–°
                        } else {
                            this.products.push({
                                id: Date.now().toString() + Math.random(),
                                barcode: String(row.barcode),
                                name: row.name || 'å¯¼å…¥å•†å“',
                                wholesale_price: row.wholesale_price || 0,
                                retail_price: row.retail_price || 0,
                                status: 'active',
                                created_at: new Date().toISOString()
                            });
                        }
                        count++;
                    }
                });
                this.saveLocalData();
                this.syncData(); // å°è¯•æ‰¹é‡åŒæ­¥
                alert(`å¤„ç†äº† ${count} æ¡æ•°æ®`);
            };
            reader.readAsBinaryString(file);
        },

        // --- æ ¸å¿ƒï¼šæ•°æ®å±‚ (ç¦»çº¿ä¼˜å…ˆ) ---
        loadLocalData() {
            const p = localStorage.getItem('pos_products');
            const o = localStorage.getItem('pos_orders');
            if(p) this.products = JSON.parse(p);
            if(o) this.orders = JSON.parse(o);
        },

        saveLocalData() {
            localStorage.setItem('pos_products', JSON.stringify(this.products));
            localStorage.setItem('pos_orders', JSON.stringify(this.orders));
        },

        async syncData() {
            // ç®€å•åŒæ­¥ç­–ç•¥ï¼šæ‹‰å–è¿œç¨‹æœ€æ–°è¦†ç›–æœ¬åœ°ï¼ˆçœŸå®åœºæ™¯éœ€æ›´å¤æ‚åˆå¹¶é€»è¾‘ï¼Œæ­¤å¤„ç®€åŒ–ï¼‰
            if(!navigator.onLine) return;
            
            const { data: pData } = await this.supabase.from('products').select('*');
            if(pData && pData.length > 0) {
                // åˆå¹¶é€»è¾‘ï¼šä»¥æ¡ç ä¸ºä¸»é”®
                pData.forEach(remote => {
                    const idx = this.products.findIndex(local => local.barcode === remote.barcode);
                    if(idx === -1) this.products.push(remote);
                    else this.products[idx] = remote; 
                });
                this.saveLocalData();
            }

            const { data: oData } = await this.supabase.from('orders').select('*').limit(100);
            if(oData && oData.length > 0) {
                // è®¢å•ä»…åšç®€å•è¡¥å……ï¼Œä¸è¦†ç›–ä»¥é˜²æœ¬åœ°æœ‰æœªä¸Šä¼ çš„
                oData.forEach(remote => {
                    if(!this.orders.find(local => local.id === remote.id)) {
                        this.orders.push(remote);
                    }
                });
                this.saveLocalData();
            }
        },

        async syncProductToSupabase(product) {
            if(!navigator.onLine) return;
            const { error } = await this.supabase.from('products').upsert(product);
            if(error) console.error(error);
        },

        async syncOrderToSupabase(order, items) {
            if(!navigator.onLine) return; // çœŸå®åœºæ™¯åº”æ”¾å…¥é˜Ÿåˆ—
            const { error: e1 } = await this.supabase.from('orders').insert(order);
            const { error: e2 } = await this.supabase.from('order_items').insert(items);
        },

        // --- æ‚é¡¹ ---
        async switchTab(tab) {
            await this.stopScanner();
            this.currentTab = tab;
            
            // PCç«¯è‡ªåŠ¨èšç„¦
            if (!this.isMobile) {
                await this.$nextTick();
                if (tab === 'cashier') document.getElementById('cashierInput')?.focus();
                if (tab === 'entry') document.getElementById('barcodeInput')?.focus();
                if (tab === 'manage') document.getElementById('manageInput')?.focus();
            }

            if (tab === 'entry' && this.isMobile) {
                // ä»…åœ¨ç§»åŠ¨ç«¯è‡ªåŠ¨å¼€å¯
                this.startScanner();
            }
        },

        handleGlobalKeydown(e) {
            // ç®€å•æ‰«ç æªæ£€æµ‹ï¼šå¿«é€Ÿè¾“å…¥ä¸è§¦å‘ keydown event flowå¹²æ‰°
            // å®é™…æ‰«ç æªé€šå¸¸ä»¥ Enter ç»“å°¾
            if (e.key === 'Enter' && e.target.tagName !== 'INPUT') {
                // å…¨å±€ Enter è§¦å‘ï¼šè‹¥å½“å‰æ— ç„¦ç‚¹ï¼Œå°è¯•èšç„¦åˆ°å¯¹åº”è¾“å…¥æ¡†
                if (this.currentTab === 'cashier') document.getElementById('cashierInput')?.focus();
                if (this.currentTab === 'entry') document.getElementById('barcodeInput')?.focus();
            }
        },
        
        formatDate(iso) {
            return new Date(iso).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit'});
        }
    },
    mounted() {
        this.initSystem();
    }
}).mount('#app');
</script>
</body>
</html>

