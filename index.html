<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>极简商用收银系统</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* 摄像头区域强制样式 */
        .scan-container {
            width: 100%;
            height: 280px;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        /* 强制视频填满，不做镜像翻转 */
        #reader video { 
            width: 100% !important; 
            height: 100% !important; 
            object-fit: cover !important; 
            border-radius: 12px;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-press:active { transform: scale(0.96); opacity: 0.8; }
        input:focus { outline: none; border-color: #2563eb; ring: 2px; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-screen w-full flex flex-col bg-gray-50 max-w-md mx-auto shadow-2xl overflow-hidden">

    <div class="h-14 bg-white px-4 shadow-sm shrink-0 flex justify-between items-center z-20 border-b border-gray-100">
        <h1 class="font-bold text-lg text-gray-800">{{ currentTitle }}</h1>
        <div class="flex items-center gap-2">
            <div :class="isOnline ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
            <span class="text-xs text-gray-500 font-mono">{{ isOnline ? 'ONLINE' : 'OFFLINE' }}</span>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto hide-scrollbar p-4 relative bg-gray-50">
        
        <div v-if="currentTab === 'entry'" class="space-y-4">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <div v-show="scanning" class="scan-container mb-3">
                    <div id="reader" class="w-full h-full"></div>
                    <div class="absolute inset-0 border-2 border-blue-500/50 rounded-xl pointer-events-none"></div>
                    <div class="absolute top-1/2 left-4 right-4 h-0.5 bg-red-500/80 shadow-[0_0_8px_rgba(239,68,68,0.8)] z-10"></div>
                </div>
                
                <button @click="toggleScanner('entry')" :class="scanning ? 'bg-red-50 text-red-600' : 'bg-blue-600 text-white'" class="w-full py-3 rounded-lg font-bold flex items-center justify-center gap-2 btn-press shadow-md transition-colors">
                    <i :class="scanning ? 'ph-x-circle' : 'ph-camera'" class="text-xl"></i> 
                    {{ scanning ? '关闭摄像头' : '打开摄像头扫码' }}
                </button>
                <p v-if="scanError" class="text-xs text-red-500 text-center mt-2 font-bold">{{ scanError }}</p>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm space-y-4 border border-gray-100">
                <div>
                    <label class="text-xs text-gray-400 font-bold block mb-1">条形码</label>
                    <input ref="barcodeInput" v-model="entryForm.barcode" @keyup.enter="handleBarcodeEnter" type="text" class="w-full p-3 bg-gray-100 rounded-lg text-lg font-mono font-bold text-gray-800 focus:bg-white transition-all" placeholder="扫码结果会出现在这">
                </div>
                <div>
                    <label class="text-xs text-gray-400 font-bold block mb-1">商品名称</label>
                    <input v-model="entryForm.name" type="text" placeholder="留空自动生成 '未命名'" class="w-full p-3 bg-gray-100 rounded-lg text-gray-800 focus:bg-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-400 font-bold block mb-1">批发价</label>
                        <input v-model="entryForm.wholesale_price" type="number" class="w-full p-3 bg-gray-100 rounded-lg text-gray-800 font-bold">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold block mb-1">零售价</label>
                        <input v-model="entryForm.retail_price" type="number" class="w-full p-3 bg-gray-100 rounded-lg text-gray-800 font-bold text-blue-600">
                    </div>
                </div>
                <button @click="saveProduct" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold text-lg shadow-lg btn-press mt-2">
                    确认添加
                </button>
            </div>
        </div>

        <div v-if="currentTab === 'manage'" class="space-y-4 pb-12">
            <div class="flex gap-2 sticky top-0 z-10 bg-gray-50 pb-2">
                <input v-model="searchText" type="text" placeholder="搜索商品..." class="flex-1 p-3 bg-white rounded-lg shadow-sm border border-gray-100">
                <button @click="exportExcel" class="px-4 bg-green-100 text-green-700 rounded-lg font-bold btn-press"><i class="ph-file-xls text-xl"></i></button>
                <label class="px-4 bg-blue-100 text-blue-700 rounded-lg font-bold flex items-center btn-press">
                    <i class="ph-upload-simple text-xl"></i>
                    <input type="file" @change="importExcel" class="hidden" accept=".xlsx,.xls">
                </label>
            </div>
            <div class="space-y-2">
                <div v-for="p in filteredProducts" :key="p.id" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100" @click="editProduct(p)">
                    <div>
                        <div class="font-bold text-gray-800">{{ p.name }}</div>
                        <div class="text-xs text-gray-400 font-mono">{{ p.barcode }}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-blue-600 font-bold">¥{{ p.retail_price }}</div>
                        <div class="text-gray-300 text-xs">¥{{ p.wholesale_price }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'cashier'" class="space-y-3 pb-32">
            <div class="grid grid-cols-2 gap-2 bg-white p-1 rounded-xl shadow-sm">
                <button @click="priceMode = 'retail'" :class="priceMode === 'retail' ? 'bg-blue-600 text-white shadow' : 'text-gray-400'" class="py-2 rounded-lg font-bold text-sm transition-all">零售价</button>
                <button @click="priceMode = 'wholesale'" :class="priceMode === 'wholesale' ? 'bg-orange-500 text-white shadow' : 'text-gray-400'" class="py-2 rounded-lg font-bold text-sm transition-all">批发价</button>
            </div>

            <div class="relative">
                <input ref="cashierInput" v-model="cashierSearch" @keyup.enter="addToCartByInput" type="text" placeholder="扫描或输入..." class="w-full p-4 pl-12 bg-white rounded-xl shadow-sm font-bold text-lg border border-gray-100">
                <i class="ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
                <button @click="toggleScanner('cashier')" class="absolute right-2 top-2 p-2 bg-gray-50 rounded-lg text-gray-600">
                    <i class="ph-qr-code text-xl"></i>
                </button>
            </div>
            
            <div v-show="scanning" class="scan-container mb-2">
                <div id="cashier-reader" class="w-full h-full"></div>
                <div class="absolute inset-0 border-2 border-blue-500/50 rounded-xl pointer-events-none"></div>
                <div class="absolute top-1/2 left-4 right-4 h-0.5 bg-red-500/80 shadow-[0_0_8px_rgba(239,68,68,0.8)] z-10"></div>
                <button @click="stopScanner" class="absolute bottom-2 right-2 bg-black/50 text-white px-3 py-1 rounded text-xs z-20">关闭</button>
            </div>

            <div class="space-y-2">
                <div v-for="(item, index) in cart" :key="index" class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <div class="flex justify-between mb-2">
                        <h4 class="font-bold text-gray-800">{{ item.name }}</h4>
                        <button @click="removeFromCart(index)" class="text-red-400 p-1"><i class="ph-trash"></i></button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                        <div class="flex items-center gap-3">
                            <button @click="item.quantity > 1 ? item.quantity-- : removeFromCart(index)" class="w-8 h-8 bg-white rounded shadow text-gray-600 font-bold">-</button>
                            <span class="font-bold w-6 text-center">{{ item.quantity }}</span>
                            <button @click="item.quantity++" class="w-8 h-8 bg-blue-600 rounded shadow text-white font-bold">+</button>
                        </div>
                        <div class="text-right flex items-center gap-1">
                            <span class="text-xs text-gray-400">¥</span>
                            <input v-model="item.unit_price" type="number" class="w-16 text-right bg-transparent border-b border-gray-300 font-bold text-lg">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'orders'" class="space-y-4">
            <div class="bg-gray-900 p-5 rounded-xl shadow-lg text-white">
                <div class="text-sm text-gray-400">今日销售额</div>
                <div class="text-4xl font-black mt-1">¥{{ todaySales.toFixed(2) }}</div>
                <div class="text-xs text-gray-500 mt-2">共 {{ todayOrders }} 单</div>
            </div>

            <div class="space-y-3">
                <div v-for="order in sortedOrders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-50">
                        <span class="text-xs text-gray-400">{{ formatDate(order.created_at) }}</span>
                        <button v-if="order.status === 'completed'" @click="voidOrder(order)" class="text-xs text-red-400 bg-red-50 px-2 py-1 rounded">作废</button>
                        <span v-else class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">已作废</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-gray-800">¥{{ order.total_price }}</span>
                        <span class="text-sm text-gray-500">{{ order.total_quantity }} 件</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'cashier'" class="bg-white border-t p-3 shadow-lg shrink-0 z-30">
        <div class="flex justify-between items-center mb-2">
            <span class="text-gray-500 text-xs">合计数量: {{ cartTotalQty }}</span>
            <div class="text-2xl font-black text-gray-900">¥{{ cartTotalPrice }}</div>
        </div>
        <div class="grid grid-cols-4 gap-2">
            <button @click="clearCart" class="col-span-1 bg-gray-100 text-gray-500 rounded-lg font-bold">清空</button>
            <button @click="checkoutDirectly" :disabled="cart.length===0" class="col-span-3 bg-gray-900 text-white rounded-lg font-bold py-3 text-lg btn-press disabled:opacity-50">
                结算收款
            </button>
        </div>
    </div>

    <div class="h-[60px] bg-white border-t border-gray-200 flex justify-around items-center shrink-0 z-40 text-gray-400">
        <div @click="switchTab('entry')" :class="{'text-blue-600': currentTab==='entry'}" class="flex flex-col items-center w-1/4 btn-press">
            <i class="ph-plus-circle text-2xl mb-0.5"></i>
            <span class="text-[10px] font-bold">录入</span>
        </div>
        <div @click="switchTab('manage')" :class="{'text-blue-600': currentTab==='manage'}" class="flex flex-col items-center w-1/4 btn-press">
            <i class="ph-package text-2xl mb-0.5"></i>
            <span class="text-[10px] font-bold">管理</span>
        </div>
        <div @click="switchTab('cashier')" :class="{'text-blue-600': currentTab==='cashier'}" class="flex flex-col items-center w-1/4 btn-press">
            <i class="ph-barcode text-2xl mb-0.5"></i>
            <span class="text-[10px] font-bold">收银</span>
        </div>
        <div @click="switchTab('orders')" :class="{'text-blue-600': currentTab==='orders'}" class="flex flex-col items-center w-1/4 btn-press">
            <i class="ph-receipt text-2xl mb-0.5"></i>
            <span class="text-[10px] font-bold">报表</span>
        </div>
    </div>

    <div v-if="editingProduct" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">编辑商品</h3>
            <div class="space-y-3">
                <input v-model="editingProduct.name" class="w-full p-3 border rounded-lg">
                <input v-model="editingProduct.barcode" class="w-full p-3 border rounded-lg bg-gray-100" readonly>
                <div class="flex gap-2">
                    <input v-model="editingProduct.wholesale_price" type="number" class="w-1/2 p-3 border rounded-lg">
                    <input v-model="editingProduct.retail_price" type="number" class="w-1/2 p-3 border rounded-lg">
                </div>
                <select v-model="editingProduct.status" class="w-full p-3 border rounded-lg">
                    <option value="active">启用</option>
                    <option value="disabled">停用</option>
                </select>
            </div>
            <div class="flex gap-2 mt-6">
                <button @click="editingProduct = null" class="flex-1 py-3 bg-gray-100 rounded-lg font-bold">取消</button>
                <button @click="updateProduct" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold">保存</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createClient } = supabase;
    
    // ==========================================
    // ⚠️⚠️ 请在此处填写你的 Supabase 配置 ⚠️⚠️
    // ==========================================
    const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';
    // ==========================================

    const app = Vue.createApp({
        data() {
            return {
                supabase: null,
                isOnline: navigator.onLine,
                currentTab: 'entry',
                products: [], orders: [], orderItems: [], 
                
                // 录入
                entryForm: { barcode: '', name: '', wholesale_price: '', retail_price: '' },
                
                // 核心：扫码器实例
                scanning: false,
                html5QrCode: null, // 改用 Html5Qrcode 而不是 Scanner UI
                scanError: '',
                
                // 业务数据
                searchText: '',
                editingProduct: null,
                priceMode: 'retail', 
                cashierSearch: '',
                cart: [],
                syncQueue: JSON.parse(localStorage.getItem('syncQueue') || '[]')
            }
        },
        computed: {
            currentTitle() { return { entry: '扫码录入', manage: '商品库', cashier: '前台收银', orders: '销售记录' }[this.currentTab]; },
            filteredProducts() {
                if (!this.searchText) return this.products;
                const low = this.searchText.toLowerCase();
                return this.products.filter(p => p.name?.toLowerCase().includes(low) || p.barcode.includes(low));
            },
            cartTotalPrice() { return this.cart.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0).toFixed(2); },
            cartTotalQty() { return this.cart.reduce((sum, item) => sum + item.quantity, 0); },
            sortedOrders() { return [...this.orders].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); },
            todaySales() {
                const today = new Date().toISOString().split('T')[0];
                return this.orders.filter(o => o.status === 'completed' && o.created_at.startsWith(today)).reduce((sum, o) => sum + o.total_price, 0);
            },
            todayOrders() {
                const today = new Date().toISOString().split('T')[0];
                return this.orders.filter(o => o.status === 'completed' && o.created_at.startsWith(today)).length;
            }
        },
        async mounted() {
            this.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            this.loadLocalData();
            await this.fetchData();
            window.addEventListener('online', () => { this.isOnline = true; this.processSyncQueue(); });
            window.addEventListener('offline', () => { this.isOnline = false; });
            setInterval(this.processSyncQueue, 10000);
        },
        methods: {
            // === 修复版：摄像头逻辑 (使用 Html5Qrcode Pro Mode) ===
            async toggleScanner(tab) {
                if (this.scanning) {
                    await this.stopScanner();
                } else {
                    this.startScanner(tab);
                }
            },
            async startScanner(tab) {
                this.scanError = '';
                // 确定渲染容器 ID
                const elementId = tab === 'entry' ? "reader" : "cashier-reader";
                
                // 1. 实例化 (如果不存在)
                if (!this.html5QrCode) {
                    this.html5QrCode = new Html5Qrcode(elementId);
                }

                try {
                    this.scanning = true;
                    // 2. 启动摄像头，强制使用后置 (environment)
                    // aspectRatio: 1.0 保持正方形比例 (可选)
                    await this.html5QrCode.start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => this.onScanSuccess(decodedText, tab),
                        (errorMessage) => {
                            // 扫描过程中的错误忽略，不弹窗
                        }
                    );
                } catch (err) {
                    console.error("Camera start failed", err);
                    this.scanning = false;
                    this.scanError = "无法启动摄像头，请检查权限或尝试刷新";
                    // 如果启动失败，尝试清理
                    this.html5QrCode = null;
                }
            },
            async stopScanner() {
                if (this.html5QrCode && this.html5QrCode.isScanning) {
                    try {
                        await this.html5QrCode.stop();
                        this.html5QrCode.clear();
                    } catch (err) {
                        console.error("Stop failed", err);
                    }
                }
                this.html5QrCode = null; // 彻底销毁实例，防止重用ID冲突
                this.scanning = false;
            },
            onScanSuccess(decodedText, tab) {
                if (tab === 'entry') {
                    this.entryForm.barcode = decodedText;
                    this.handleBarcodeEnter();
                } else if (tab === 'cashier') {
                    this.cashierSearch = decodedText;
                    this.addToCartByInput();
                    // 收银模式下扫码成功不关闭摄像头，允许连续扫
                }
            },
            
            // 切换 Tab 时必须关闭摄像头
            async switchTab(tab) {
                if (this.scanning) await this.stopScanner();
                this.currentTab = tab;
            },

            // === 业务逻辑保持不变 ===
            loadLocalData() {
                this.products = JSON.parse(localStorage.getItem('products') || '[]');
                this.orders = JSON.parse(localStorage.getItem('orders') || '[]');
                this.orderItems = JSON.parse(localStorage.getItem('orderItems') || '[]');
            },
            async fetchData() {
                if (!this.isOnline) return;
                const { data: p } = await this.supabase.from('products').select('*');
                if (p) { this.products = p; localStorage.setItem('products', JSON.stringify(p)); }
                const { data: o } = await this.supabase.from('orders').select('*').limit(50);
                if (o) { this.orders = o; localStorage.setItem('orders', JSON.stringify(o)); }
            },
            handleBarcodeEnter() {
                if (!this.entryForm.barcode) return;
                const exists = this.products.find(p => p.barcode === this.entryForm.barcode);
                if (exists) alert('该条码已存在: ' + exists.name);
            },
            saveProduct() {
                if (!this.entryForm.barcode) return alert('需输入条码');
                let finalName = this.entryForm.name || `未命名${this.products.length + 1}`;
                const p = {
                    barcode: this.entryForm.barcode,
                    name: finalName,
                    wholesale_price: parseFloat(this.entryForm.wholesale_price) || 0,
                    retail_price: parseFloat(this.entryForm.retail_price) || 0,
                    status: 'active'
                };
                const tempId = crypto.randomUUID();
                this.products.unshift({ ...p, id: tempId });
                localStorage.setItem('products', JSON.stringify(this.products));
                this.addToSyncQueue('products', 'insert', p);
                this.entryForm = { barcode: '', name: '', wholesale_price: '', retail_price: '' };
                this.$refs.barcodeInput.focus();
            },
            addToCartByInput() {
                const term = this.cashierSearch.trim();
                if (!term) return;
                let p = this.products.find(x => x.barcode === term && x.status === 'active');
                if (!p) p = this.products.find(x => x.name === term && x.status === 'active');
                if (p) {
                    const existing = this.cart.find(i => i.product_id === p.id);
                    if (existing) existing.quantity++;
                    else this.cart.push({
                        product_id: p.id, name: p.name, barcode: p.barcode,
                        unit_price: this.priceMode === 'retail' ? p.retail_price : p.wholesale_price, quantity: 1
                    });
                    this.cashierSearch = '';
                }
            },
            removeFromCart(idx) { this.cart.splice(idx, 1); },
            clearCart() { if(confirm('清空购物车?')) this.cart = []; },
            checkoutDirectly() {
                const total = this.cartTotalPrice;
                if (!confirm(`总金额：¥${total}\n\n确认完成收款？`)) return;
                const orderId = crypto.randomUUID();
                const now = new Date().toISOString();
                const order = {
                    id: orderId, total_price: parseFloat(total), total_quantity: this.cartTotalQty,
                    price_type: this.priceMode, payment_method: '常规结算', status: 'completed', created_at: now
                };
                const items = this.cart.map(i => ({
                    order_id: orderId, product_id: i.product_id, product_name: i.name, barcode: i.barcode,
                    unit_price: i.unit_price, quantity: i.quantity, subtotal: i.unit_price * i.quantity
                }));
                this.orders.unshift(order);
                localStorage.setItem('orders', JSON.stringify(this.orders));
                this.addToSyncQueue('orders', 'insert', order);
                this.addToSyncQueue('order_items', 'insert', items);
                this.cart = [];
                this.switchTab('orders');
            },
            voidOrder(order) {
                if(!confirm('确认作废?')) return;
                order.status = 'void';
                localStorage.setItem('orders', JSON.stringify(this.orders));
                this.addToSyncQueue('orders', 'update', { id: order.id, status: 'void' });
            },
            editProduct(p) { this.editingProduct = JSON.parse(JSON.stringify(p)); },
            updateProduct() {
                const idx = this.products.findIndex(p => p.id === this.editingProduct.id);
                if (idx !== -1) this.products[idx] = this.editingProduct;
                localStorage.setItem('products', JSON.stringify(this.products));
                const { id, ...updates } = this.editingProduct;
                this.addToSyncQueue('products', 'update', { id, ...updates });
                this.editingProduct = null;
            },
            exportExcel() {
                const ws = XLSX.utils.json_to_sheet(this.products);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Products");
                XLSX.writeFile(wb, "商品导出.xlsx");
            },
            importExcel(e) {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(confirm(`导入 ${data.length} 条数据?`)) {
                        data.forEach(row => {
                            const p = { barcode: row['barcode']||row['条码'], name: row['name']||row['名称'], wholesale_price: row['wholesale']||0, retail_price: row['retail']||0, status: 'active' };
                            if(p.barcode) this.addToSyncQueue('products', 'insert', p);
                        });
                        alert('已加入后台同步队列');
                    }
                };
                r.readAsBinaryString(f);
            },
            formatDate(str) { return new Date(str).toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'}); },
            addToSyncQueue(table, action, data) {
                this.syncQueue.push({ table, action, data, retry: 0 });
                localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                this.processSyncQueue();
            },
            async processSyncQueue() {
                if (!this.isOnline || !this.syncQueue.length) return;
                const item = this.syncQueue[0];
                try {
                    if (item.action === 'insert') await this.supabase.from(item.table).insert(item.data);
                    else if (item.action === 'update') {
                        const { id, ...updates } = item.data;
                        await this.supabase.from(item.table).update(updates).eq('id', id);
                    }
                    this.syncQueue.shift();
                    localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                    this.processSyncQueue();
                } catch (e) {
                    item.retry++;
                    if(item.retry > 3) this.syncQueue.shift();
                    localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
                }
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
