<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æé€Ÿæ”¶é“¶ç³»ç»Ÿ (Mobile POS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .page { display: none; padding-bottom: 80px; height: 100vh; overflow-y: auto; }
        .page.active { display: block; }
        
        /* æ‰«ç æ¡†æ ·å¼ */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        #reader video { object-fit: cover; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* åº•éƒ¨å¯¼èˆª */
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #2563EB; font-weight: bold; transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg z-50 hidden transition-opacity duration-300"></div>

    <div id="page-entry" class="page active">
        <header class="bg-white p-4 shadow-sm sticky top-0 z-10">
            <h1 class="text-xl font-bold text-center">å•†å“å½•å…¥</h1>
        </header>
        <div class="p-4 space-y-4">
            <div class="relative bg-black rounded-lg overflow-hidden h-64 flex flex-col items-center justify-center">
                <div id="reader" class="absolute inset-0"></div>
                <div id="camera-status" class="z-10 text-white text-sm bg-black/50 px-3 py-1 rounded">ç‚¹å‡»å¼€å§‹æ‰«ç </div>
                <button onclick="startScanner('entry')" id="btn-scan-entry" class="z-10 mt-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full shadow-lg">å¯åŠ¨æ‘„åƒå¤´</button>
            </div>
            
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                <div>
                    <label class="block text-sm text-gray-500 mb-1">æ¡å½¢ç  (å¿…å¡«)</label>
                    <div class="flex gap-2">
                        <input type="text" id="entry-barcode" class="w-full border p-2 rounded bg-gray-50 text-lg font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ‰«ç æˆ–æ‰‹åŠ¨è¾“å…¥">
                        <button onclick="generateBarcode()" class="bg-gray-200 px-3 rounded text-sm whitespace-nowrap">ç”Ÿæˆ</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-500 mb-1">å•†å“åç§°</label>
                    <input type="text" id="entry-name" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="é»˜è®¤ï¼šæœªå‘½åN">
                </div>
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="block text-sm text-gray-500 mb-1">æ‰¹å‘ä»·</label>
                        <input type="number" id="entry-wholesale" class="w-full border p-2 rounded text-lg font-bold text-orange-600 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-sm text-gray-500 mb-1">é›¶å”®ä»·</label>
                        <input type="number" id="entry-retail" class="w-full border p-2 rounded text-lg font-bold text-green-600 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0.00">
                    </div>
                </div>
                <button onclick="saveProduct()" class="w-full bg-blue-600 active:bg-blue-800 text-white py-3 rounded-lg text-lg font-bold shadow mt-2">ä¿å­˜å¹¶ç»§ç»­ (Enter)</button>
            </div>
        </div>
    </div>

    <div id="page-mgmt" class="page">
        <header class="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
            <h1 class="text-xl font-bold">å•†å“åº“</h1>
            <div class="space-x-2">
                <button onclick="exportExcel()" class="text-sm bg-green-100 text-green-700 px-2 py-1 rounded">å¯¼å‡º</button>
                <button onclick="document.getElementById('file-import').click()" class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded">å¯¼å…¥</button>
                <input type="file" id="file-import" hidden onchange="importExcel(this)">
            </div>
        </header>
        <div class="p-2">
            <input type="text" id="search-mgmt" oninput="renderProductList()" class="w-full border p-2 rounded mb-2" placeholder="æœç´¢å•†å“åæˆ–æ¡ç ...">
            <div id="product-list" class="space-y-2 pb-20">
                </div>
        </div>
    </div>

    <div id="page-pos" class="page">
        <header class="bg-white p-2 shadow-sm sticky top-0 z-10">
            <div class="flex justify-center gap-4 mb-2">
                <label class="flex items-center space-x-2">
                    <input type="radio" name="price-type" value="retail" checked onchange="updateCartPrices()" class="w-4 h-4 text-blue-600">
                    <span class="font-bold text-green-700">é›¶å”®ä»·</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="price-type" value="wholesale" onchange="updateCartPrices()" class="w-4 h-4 text-blue-600">
                    <span class="font-bold text-orange-700">æ‰¹å‘ä»·</span>
                </label>
            </div>
            <div class="relative bg-black rounded h-32 flex flex-col items-center justify-center overflow-hidden mb-2">
                 <div id="reader-pos" class="absolute inset-0"></div>
                 <button onclick="startScanner('pos')" id="btn-scan-pos" class="z-10 bg-white/20 text-white border border-white px-4 py-1 rounded-full text-sm">ç‚¹å‡»æ‰«ç </button>
            </div>
            <input type="text" id="pos-input" class="w-full border border-blue-300 p-2 rounded text-center font-mono" placeholder="æ‰«ææˆ–è¾“å…¥æ¡ç  (Enter)">
        </header>
        
        <div id="cart-list" class="p-2 space-y-2 pb-32">
            </div>

        <div class="fixed bottom-[60px] left-0 right-0 bg-white border-t p-3 shadow-lg z-20 flex justify-between items-center">
            <div>
                <div class="text-xs text-gray-500">å…± <span id="cart-count">0</span> ä»¶</div>
                <div class="text-2xl font-bold text-red-600">Â¥ <span id="cart-total">0.00</span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearCart()" class="px-3 py-2 text-gray-500 bg-gray-100 rounded">æ¸…ç©º</button>
                <button onclick="showCheckoutModal()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded shadow">ç»“ç®—</button>
            </div>
        </div>
    </div>

    <div id="page-orders" class="page">
        <header class="bg-white p-4 shadow-sm sticky top-0 z-10">
            <h1 class="text-xl font-bold text-center">è®¢å•è®°å½•</h1>
        </header>
        <div class="p-2">
            <div class="bg-blue-50 p-3 rounded mb-4 flex justify-between text-blue-800 text-sm">
                <span>ä»Šæ—¥é”€å”®: Â¥<b id="stats-sales">0</b></span>
                <span>å•é‡: <b id="stats-count">0</b></span>
            </div>
            <div id="order-list" class="space-y-3 pb-20">
                </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t h-[60px] flex justify-around items-center z-40 pb-safe">
        <button onclick="switchPage('entry')" class="nav-item flex flex-col items-center p-2 text-gray-500 active">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            <span class="text-xs">å½•å…¥</span>
        </button>
        <button onclick="switchPage('mgmt')" class="nav-item flex flex-col items-center p-2 text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
            <span class="text-xs">ç®¡ç†</span>
        </button>
        <button onclick="switchPage('pos')" class="nav-item flex flex-col items-center p-2 text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span class="text-xs">æ”¶é“¶</span>
        </button>
        <button onclick="switchPage('orders')" class="nav-item flex flex-col items-center p-2 text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span class="text-xs">è®¢å•</span>
        </button>
    </nav>

    <div id="checkout-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-96 rounded-t-xl sm:rounded-xl p-6 animate-slide-up">
            <h2 class="text-xl font-bold mb-4">ç¡®è®¤æ”¶æ¬¾</h2>
            <div class="text-center mb-6">
                <div class="text-gray-500">åº”æ”¶é‡‘é¢</div>
                <div class="text-4xl font-bold text-blue-600">Â¥ <span id="modal-total">0.00</span></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="finishOrder('å¾®ä¿¡')" class="p-3 border rounded-lg hover:bg-green-50 text-green-700 font-bold">å¾®ä¿¡æ”¯ä»˜</button>
                <button onclick="finishOrder('æ”¯ä»˜å®')" class="p-3 border rounded-lg hover:bg-blue-50 text-blue-700 font-bold">æ”¯ä»˜å®</button>
                <button onclick="finishOrder('ç°é‡‘')" class="p-3 border rounded-lg hover:bg-yellow-50 text-yellow-700 font-bold">ç°é‡‘</button>
                <button onclick="finishOrder('å…¶ä»–')" class="p-3 border rounded-lg bg-gray-50 text-gray-700">å…¶ä»–</button>
            </div>
            <button onclick="closeCheckoutModal()" class="w-full py-3 text-gray-500">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        const SUPABASE_URL = 'https://ovhjhqfjygwzvfpaiejb.supabase.co';
        // ğŸ‘‰ è¿™é‡Œå¡«å†™ Supabase Key (Service Role Key å…è®¸ç»•è¿‡ RLS)
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGpocWZqeWd3enZmcGFpZWpiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzYzNTk4NywiZXhwIjoyMDgzMjExOTg3fQ.GYw1xicPS93oQIqOJNaqzYlq7zTcst_jo5B7JEQYZCE';

        // ================= åˆå§‹åŒ– =================
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let productsCache = JSON.parse(localStorage.getItem('products')) || [];
        let cart = [];
        let html5QrCode;
        let scanLock = false;
        let currentMode = 'entry'; // entry, mgmt, pos, orders

        // åˆå§‹åŒ–
        window.onload = async () => {
            syncProducts(); // åå°åŒæ­¥æ•°æ®
            setupGlobalListeners();
        };

        // ================= 1. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ =================

        // --- å•†å“å½•å…¥ ---
        async function saveProduct() {
            const barcode = document.getElementById('entry-barcode').value.trim();
            let name = document.getElementById('entry-name').value.trim();
            const wholesale = parseFloat(document.getElementById('entry-wholesale').value) || 0;
            const retail = parseFloat(document.getElementById('entry-retail').value) || 0;

            if (!barcode) return showToast('è¯·è¾“å…¥æ¡ç ');

            // è‡ªåŠ¨å‘½åé€»è¾‘
            if (!name) {
                const untitledCount = productsCache.filter(p => p.name.startsWith('æœªå‘½å')).length;
                name = `æœªå‘½å${untitledCount + 1}`;
            }

            // æ£€æŸ¥é‡å¤
            const exist = productsCache.find(p => p.barcode === barcode);
            if (exist) {
                if(!confirm(`æ¡ç  ${barcode} å·²å­˜åœ¨ (${exist.name})ï¼Œè¦è¦†ç›–ä»·æ ¼å—ï¼Ÿ`)) return;
                const { error } = await supabase.from('products').update({ name, wholesale_price: wholesale, retail_price: retail }).eq('id', exist.id);
                if(error) return showToast('æ›´æ–°å¤±è´¥');
            } else {
                const { error } = await supabase.from('products').insert([{ barcode, name, wholesale_price: wholesale, retail_price: retail }]);
                if(error) return showToast('æ·»åŠ å¤±è´¥: ' + error.message);
            }

            showToast('å•†å“å·²ä¿å­˜');
            document.getElementById('entry-barcode').value = '';
            document.getElementById('entry-name').value = '';
            document.getElementById('entry-wholesale').value = '';
            document.getElementById('entry-retail').value = '';
            
            await syncProducts();
            
            // è‡ªåŠ¨é‡å¼€æ‰«ç 
            if(currentMode === 'entry') startScanner('entry');
        }

        // --- æ”¶é“¶é€»è¾‘ ---
        function addToCart(barcode) {
            const product = productsCache.find(p => p.barcode === barcode && p.status === 'active');
            if (!product) {
                showToast('å•†å“ä¸å­˜åœ¨æˆ–å·²åœç”¨');
                // å¤±è´¥å…è®¸æ‰‹åŠ¨è¾“å…¥
                if(currentMode === 'pos') document.getElementById('pos-input').focus();
                return;
            }

            const existingItem = cart.find(item => item.barcode === barcode);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                const priceType = document.querySelector('input[name="price-type"]:checked').value;
                cart.push({
                    ...product,
                    unit_price: priceType === 'wholesale' ? product.wholesale_price : product.retail_price,
                    quantity: 1
                });
            }
            renderCart();
            showToast(`å·²æ·»åŠ : ${product.name}`);
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;
            let count = 0;

            cart.forEach((item, index) => {
                const subtotal = item.unit_price * item.quantity;
                total += subtotal;
                count += item.quantity;
                
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded shadow-sm flex justify-between items-center';
                el.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.barcode}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-gray-600">å•ä»·:</span>
                            <input type="number" value="${item.unit_price}" onchange="updateItemPrice(${index}, this.value)" class="w-20 border rounded px-1 text-sm font-bold text-blue-600">
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="font-bold text-red-600">Â¥${subtotal.toFixed(2)}</div>
                        <div class="flex items-center border rounded">
                            <button onclick="updateQty(${index}, -1)" class="px-2 py-1 bg-gray-100 text-lg font-bold">-</button>
                            <span class="px-2 text-sm">${item.quantity}</span>
                            <button onclick="updateQty(${index}, 1)" class="px-2 py-1 bg-gray-100 text-lg font-bold">+</button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });

            document.getElementById('cart-total').innerText = total.toFixed(2);
            document.getElementById('cart-count').innerText = count;
            document.getElementById('modal-total').innerText = total.toFixed(2);
        }

        async function finishOrder(paymentMethod) {
            if (cart.length === 0) return;
            
            const total = parseFloat(document.getElementById('cart-total').innerText);
            const qty = parseInt(document.getElementById('cart-count').innerText);
            const priceType = document.querySelector('input[name="price-type"]:checked').value;

            // 1. ä¿å­˜è®¢å•ä¸»è¡¨
            const { data: order, error } = await supabase.from('orders').insert([{
                total_price: total,
                total_quantity: qty,
                price_type: priceType,
                payment_method: paymentMethod,
                status: 'completed'
            }]).select().single();

            if (error) return showToast('è®¢å•ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');

            // 2. ä¿å­˜æ˜ç»†
            const items = cart.map(item => ({
                order_id: order.id,
                product_id: item.id,
                product_name: item.name,
                barcode: item.barcode,
                unit_price: item.unit_price,
                quantity: item.quantity,
                subtotal: item.unit_price * item.quantity
            }));
            
            await supabase.from('order_items').insert(items);

            closeCheckoutModal();
            clearCart(false); // ä¸éœ€ç¡®è®¤
            showToast('æ”¶æ¬¾æˆåŠŸï¼');
            loadOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
        }

        // ================= 2. æ‰«ç ä¸æ‘„åƒå¤´é€»è¾‘ =================

        async function startScanner(mode) {
            const domId = mode === 'entry' ? 'reader' : 'reader-pos';
            const btnId = mode === 'entry' ? 'btn-scan-entry' : 'btn-scan-pos';
            
            // å…ˆåœæ­¢å·²æœ‰æµ
            if (html5QrCode) {
                try { await stopScanner(); } catch(e){}
            }

            document.getElementById(btnId).classList.add('hidden');
            
            html5QrCode = new Html5Qrcode(domId);
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 },
                aspectRatio: 1.0 
            };

            try {
                await html5QrCode.start(
                    { facingMode: { ideal: "environment" } },
                    config,
                    (decodedText) => handleScanSuccess(decodedText, mode),
                    (errorMessage) => { /* å¿½ç•¥é”™è¯¯ï¼Œé¿å…æ—¥å¿—åˆ·å± */ }
                );
            } catch (err) {
                showToast("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥");
                document.getElementById(btnId).classList.remove('hidden');
            }
        }

        async function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                await html5QrCode.stop();
                html5QrCode.clear();
            }
            // æ¢å¤æŒ‰é’®æ˜¾ç¤º
            document.getElementById('btn-scan-entry').classList.remove('hidden');
            document.getElementById('btn-scan-pos').classList.remove('hidden');
        }

        function handleScanSuccess(decodedText, mode) {
            if (scanLock) return;
            scanLock = true;
            
            // æ ¡éªŒæ¡ç : çº¯æ•°å­—, 8-13ä½
            if (!/^\d{8,15}$/.test(decodedText)) {
                 showToast('æ— æ•ˆæ¡ç ï¼Œè¯·é‡è¯•');
                 setTimeout(() => { scanLock = false; }, 1000);
                 return;
            }

            // æš‚åœæ‘„åƒå¤´
            html5QrCode.pause();

            if (mode === 'entry') {
                document.getElementById('entry-barcode').value = decodedText;
                showToast('å·²æ‰«æï¼Œè¯·å¡«å†™ä¿¡æ¯');
                document.getElementById('entry-name').focus();
            } else if (mode === 'pos') {
                addToCart(decodedText);
                // æ”¶é“¶æ¨¡å¼è‡ªåŠ¨æ¢å¤æ‰«ç ï¼Œæ–¹ä¾¿è¿ç»­æ‰«
                setTimeout(() => { html5QrCode.resume(); }, 800);
            }

            // 500ms åé‡Šæ”¾é”
            setTimeout(() => { scanLock = false; }, 500);
        }

        // ç›‘å¬æ‰«ç æª (é”®ç›˜äº‹ä»¶æ¨¡æ‹Ÿ)
        let keyBuffer = '';
        let lastKeyTime = 0;
        document.addEventListener('keydown', (e) => {
            const currentTime = Date.now();
            
            // å¦‚æœé—´éš”å¤ªä¹…ï¼Œé‡ç½® buffer
            if (currentTime - lastKeyTime > 100) {
                keyBuffer = '';
            }
            lastKeyTime = currentTime;

            if (e.key === 'Enter') {
                if (keyBuffer.length >= 8 && /^\d+$/.test(keyBuffer)) {
                    // åˆ¤å®šä¸ºæ‰«ç æªè¾“å…¥
                    if (currentMode === 'entry') {
                        document.getElementById('entry-barcode').value = keyBuffer;
                        document.getElementById('entry-name').focus();
                    } else if (currentMode === 'pos') {
                        addToCart(keyBuffer);
                        document.getElementById('pos-input').value = '';
                    }
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤å›è½¦è¡Œä¸º
                }
                keyBuffer = '';
            } else if (e.key.length === 1) {
                keyBuffer += e.key;
            }
        });

        // é¡µé¢å¯è§æ€§å¤„ç† (é‡Šæ”¾æ‘„åƒå¤´)
        document.addEventListener("visibilitychange", () => {
             if (document.hidden) stopScanner();
        });

        // ================= 3. æ•°æ®ç®¡ç†ä¸å·¥å…· =================

        async function syncProducts() {
            if (!navigator.onLine) return;
            const { data, error } = await supabase.from('products').select('*');
            if (!error && data) {
                productsCache = data;
                localStorage.setItem('products', JSON.stringify(data));
                renderProductList();
            }
        }

        function renderProductList() {
            const search = document.getElementById('search-mgmt').value.toLowerCase();
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            
            const filtered = productsCache.filter(p => 
                (p.name.toLowerCase().includes(search) || p.barcode.includes(search)) 
            );

            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = `bg-white p-3 rounded shadow-sm border-l-4 ${p.status === 'active' ? 'border-green-500' : 'border-red-500'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">${p.name}</div>
                            <div class="text-sm text-gray-500 font-mono">${p.barcode}</div>
                            <div class="text-xs text-gray-400 mt-1">æ‰¹: Â¥${p.wholesale_price} / é›¶: Â¥${p.retail_price}</div>
                        </div>
                        <button onclick="toggleStatus(${p.id}, '${p.status}')" class="px-3 py-1 text-sm rounded ${p.status === 'active' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                            ${p.status === 'active' ? 'åœç”¨' : 'å¯ç”¨'}
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            await supabase.from('products').update({ status: newStatus }).eq('id', id);
            syncProducts();
        }

        async function loadOrders() {
            const { data } = await supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(20);
            if (!data) return;

            // ç»Ÿè®¡ä»Šæ—¥
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = data.filter(o => o.created_at.startsWith(today) && o.status === 'completed');
            const todaySales = todayOrders.reduce((sum, o) => sum + o.total_price, 0);
            
            document.getElementById('stats-sales').innerText = todaySales.toFixed(2);
            document.getElementById('stats-count').innerText = todayOrders.length;

            const list = document.getElementById('order-list');
            list.innerHTML = '';
            data.forEach(o => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded shadow-sm';
                div.innerHTML = `
                    <div class="flex justify-between border-b pb-2 mb-2">
                        <span class="font-mono text-sm text-gray-500">${new Date(o.created_at).toLocaleString()}</span>
                        <span class="font-bold ${o.status==='completed'?'text-green-600':'text-red-500'}">${o.status==='completed'?'å®Œæˆ':'å·²ä½œåºŸ'}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-sm text-gray-600">
                            æ•°é‡: ${o.total_quantity} | æ”¯ä»˜: ${o.payment_method}
                        </div>
                        <div class="text-xl font-bold">Â¥${o.total_price.toFixed(2)}</div>
                    </div>
                    ${o.status === 'completed' ? `<button onclick="voidOrder(${o.id})" class="mt-2 text-xs text-red-500 underline w-full text-right">ä½œåºŸè®¢å•</button>` : ''}
                `;
                list.appendChild(div);
            });
        }

        async function voidOrder(id) {
            if(!confirm('ç¡®å®šè¦ä½œåºŸè¯¥è®¢å•å—ï¼Ÿ')) return;
            await supabase.from('orders').update({ status: 'void' }).eq('id', id);
            loadOrders();
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function updateItemPrice(index, val) {
            cart[index].unit_price = parseFloat(val);
            renderCart();
        }

        function updateQty(index, delta) {
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            renderCart();
        }

        function clearCart(confirmFlag = true) {
            if (confirmFlag && !confirm('ç¡®å®šæ¸…ç©ºè´­ç‰©è½¦?')) return;
            cart = [];
            renderCart();
        }
        
        function updateCartPrices() {
            // åˆ‡æ¢ä»·æ ¼æ¨¡å¼æ—¶æ›´æ–°è´­ç‰©è½¦å•ä»·
            const priceType = document.querySelector('input[name="price-type"]:checked').value;
            cart.forEach(item => {
                // å¦‚æœç”¨æˆ·æ‰‹åŠ¨æ”¹è¿‡ä»·ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿè¿™é‡Œé€»è¾‘é€‰æ‹©æ¢å¤æ ‡å‡†ä»·
                item.unit_price = priceType === 'wholesale' ? item.wholesale_price : item.retail_price;
            });
            renderCart();
            showToast(`å·²åˆ‡æ¢ä¸º${priceType === 'wholesale' ? 'æ‰¹å‘' : 'é›¶å”®'}ä»·`);
        }

        function generateBarcode() {
            document.getElementById('entry-barcode').value = Date.now().toString().slice(-8);
        }

        function switchPage(pageId) {
            stopScanner(); // åˆ‡æ¢é¡µé¢å¿…é¡»å…³æ‘„åƒå¤´
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            
            document.getElementById('page-' + pageId).classList.add('active');
            // é«˜äº®å½“å‰ nav
            const navIndex = ['entry', 'mgmt', 'pos', 'orders'].indexOf(pageId);
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            
            currentMode = pageId;

            if(pageId === 'mgmt') syncProducts();
            if(pageId === 'orders') loadOrders();
            if(pageId === 'pos') document.getElementById('pos-input').focus();
        }

        function showCheckoutModal() {
            if (cart.length === 0) return showToast('è´­ç‰©è½¦æ˜¯ç©ºçš„');
            document.getElementById('checkout-modal').classList.remove('hidden');
        }
        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.add('hidden');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            t.classList.add('opacity-100');
            setTimeout(() => {
                t.classList.remove('opacity-100');
                setTimeout(() => t.classList.add('hidden'), 300);
            }, 2000);
        }

        // Excel å¯¼å‡ºå¯¼å…¥
        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(productsCache);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å•†å“åº“");
            XLSX.writeFile(wb, "å•†å“åº“å¤‡ä»½.xlsx");
        }

        function importExcel(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // æ‰¹é‡æ’å…¥
                const validData = json.map(r => ({
                    barcode: r.barcode || r['barcode'],
                    name: r.name || r['name'] || 'å¯¼å…¥å•†å“',
                    wholesale_price: r.wholesale_price || r['wholesale_price'] || 0,
                    retail_price: r.retail_price || r['retail_price'] || 0
                })).filter(r => r.barcode); // å¿…é¡»æœ‰æ¡ç 

                const { error } = await supabase.from('products').upsert(validData, { onConflict: 'barcode' });
                if(!error) {
                    showToast(`æˆåŠŸå¯¼å…¥ ${validData.length} ä¸ªå•†å“`);
                    syncProducts();
                } else {
                    showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ç»‘å®šå¸¸ç”¨ Enter é”®
        document.getElementById('entry-name').addEventListener('keydown', (e) => {
             if(e.key === 'Enter') saveProduct();
        });
        document.getElementById('pos-input').addEventListener('keydown', (e) => {
             if(e.key === 'Enter') {
                 addToCart(e.target.value.trim());
                 e.target.value = '';
             }
        });
    </script>
</body>
</html>
